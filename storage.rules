rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    function isSignedIn() {
      return request.auth != null;
    }

    function userEmail() {
      return request.auth.token.email;
    }

    function userEmailLower() {
      return userEmail() != null ? userEmail().toLowerCase() : null;
    }

    function isAuthorizedUser() {
      return isSignedIn() && (
        firestore.exists(/databases/(default)/documents/authorizedUsers/$(userEmail()))
        || (userEmailLower() != null && firestore.exists(/databases/(default)/documents/authorizedUsers/$(userEmailLower())))
      );
    }

    function isAdminUser() {
      return isSignedIn() && (
        firestore.exists(/databases/(default)/documents/adminUsers/$(userEmail()))
        || (userEmailLower() != null && firestore.exists(/databases/(default)/documents/adminUsers/$(userEmailLower())))
      );
    }

    function isViewerUser() {
      return isSignedIn() && (
        firestore.exists(/databases/(default)/documents/viewerUsers/$(userEmail()))
        || (userEmailLower() != null && firestore.exists(/databases/(default)/documents/viewerUsers/$(userEmailLower())))
      );
    }

    function isStaff() {
      return isAuthorizedUser() || isAdminUser();
    }

    function isStaffOrViewer() {
      return isStaff() || isViewerUser();
    }

    // Default deny
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Tenant documents (staff-only)
    match /tenant-documents/{roomId}/{propertyDocId}/{fileName} {
      allow read: if isStaffOrViewer();
      allow write: if isStaff()
        && request.resource.size < 10 * 1024 * 1024
        && (
          request.resource.contentType == 'application/pdf'
          || request.resource.contentType.matches('image/.*')
        );
    }

    // Tenant upload link (Option 2) - invite-scoped path
    match /tenant-upload-invites/{inviteId}/{fileName} {
      function invitePath() {
        return /databases/(default)/documents/tenantUploadInvites/$(inviteId);
      }
      function inviteDoc() {
        return firestore.get(invitePath());
      }
      function isInviteValid() {
        return isSignedIn()
          && firestore.exists(invitePath())
          && inviteDoc().data.status == 'active'
          && inviteDoc().data.emailLower == userEmailLower()
          && (inviteDoc().data.expiresAt == null || inviteDoc().data.expiresAt > request.time);
      }

      allow read: if isStaffOrViewer() || isInviteValid();
      allow write: if isInviteValid()
        && request.resource != null
        && request.resource.size < 10 * 1024 * 1024
        && (
          request.resource.contentType == 'application/pdf'
          || request.resource.contentType.matches('image/.*')
        );
    }
  }
}
