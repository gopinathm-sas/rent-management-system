rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userEmail() {
      return request.auth.token.email;
    }

    function isAuthorizedUser() {
      return isSignedIn() && exists(/databases/$(database)/documents/authorizedUsers/$(userEmail()));
    }

    function isAdminUser() {
      return isSignedIn() && exists(/databases/$(database)/documents/adminUsers/$(userEmail()));
    }

    function isStaff() {
      return isAuthorizedUser() || isAdminUser();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }

    // Authorization lists
    match /authorizedUsers/{email} {
      allow get: if isSignedIn() && userEmail() == email;
      allow list: if false;
      allow create, update, delete: if isAdminUser();
    }

    match /adminUsers/{email} {
      allow get: if isSignedIn() && userEmail() == email;
      allow list: if false;
      allow create, update, delete: if isAdminUser();
    }

    // Admin-only settings (includes admin email for settlement reports)
    match /adminSettings/{docId} {
      allow read, write: if isAdminUser();
    }

    // Main app data
    match /properties/{propertyId} {
      allow read, write: if isStaff();
    }

    match /expenses/{expenseId} {
      allow read, write: if isStaff();
    }
  }
}
