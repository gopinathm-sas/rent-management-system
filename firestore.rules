rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userEmail() {
      return request.auth.token.email;
    }

    function userEmailLower() {
      return userEmail() != null ? userEmail().toLowerCase() : null;
    }

    function isAuthorizedUser() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/authorizedUsers/$(userEmail()))
        || (userEmailLower() != null && exists(/databases/$(database)/documents/authorizedUsers/$(userEmailLower())))
      );
    }

    function isAdminUser() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/adminUsers/$(userEmail()))
        || (userEmailLower() != null && exists(/databases/$(database)/documents/adminUsers/$(userEmailLower())))
      );
    }

    function isViewerUser() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/viewerUsers/$(userEmail()))
        || (userEmailLower() != null && exists(/databases/$(database)/documents/viewerUsers/$(userEmailLower())))
      );
    }

    function isStaff() {
      return isAuthorizedUser() || isAdminUser();
    }

    function isStaffOrViewer() {
      return isStaff() || isViewerUser();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }

    // Authorization lists
    match /authorizedUsers/{email} {
      allow get: if isSignedIn() && userEmail() == email;
      allow list: if false;
      allow create, update, delete: if isAdminUser();
    }

    match /adminUsers/{email} {
      allow get: if isSignedIn() && userEmail() == email;
      allow list: if false;
      allow create, update, delete: if isAdminUser();
    }

    // Read-only viewer allowlist
    match /viewerUsers/{email} {
      allow get: if isSignedIn() && userEmail() == email;
      allow list: if false;
      allow create, update, delete: if isAdminUser();
    }

    // Admin-only settings (includes admin email for settlement reports)
    match /adminSettings/{docId} {
      allow read, write: if isAdminUser();
    }

    // Main app data
    match /properties/{propertyId} {
      allow read: if isStaffOrViewer();
      allow write: if isStaff();
    }

    match /expenses/{expenseId} {
      allow read: if isStaffOrViewer();
      allow write: if isStaff();
    }

    // Tenant upload link (Option 2)
    match /tenantUploadInvites/{inviteId} {
      // Admin creates/manages invites
      allow create, update, delete: if isAdminUser();
      // Admin can read; tenant can read only their own invite
      allow read: if isAdminUser() || (isSignedIn() && resource.data.emailLower == userEmailLower());
    }

    match /tenantUploadSubmissions/{submissionId} {
      function inviteDoc(inviteId) {
        return get(/databases/$(database)/documents/tenantUploadInvites/$(inviteId));
      }
      function isInviteValid(inviteId) {
        return inviteId != null
          && inviteDoc(inviteId).exists()
          && (inviteDoc(inviteId).data.status == null || inviteDoc(inviteId).data.status == 'active')
          && inviteDoc(inviteId).data.emailLower == userEmailLower()
          && (inviteDoc(inviteId).data.expiresAt == null || inviteDoc(inviteId).data.expiresAt > request.time);
      }

      allow create: if isSignedIn()
        && request.resource.data.emailLower == userEmailLower()
        && request.resource.data.inviteId is string
        && request.resource.data.roomId is string
        && request.resource.data.files is list
        && isInviteValid(request.resource.data.inviteId)
        && request.resource.data.roomId == inviteDoc(request.resource.data.inviteId).data.roomId;

      allow read: if isAdminUser() || (isSignedIn() && resource.data.emailLower == userEmailLower());

      // Prevent edits/deletes from tenants; admin can manage if needed.
      allow update, delete: if isAdminUser();
    }
  }
}
