<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent Management System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom smooth scrolling */
        html { scroll-behavior: smooth; }
        .hidden-section { display: none !important; }
        /* Section Tab Visibility */
        .section-tab { display: none !important; }
        .section-tab.active { display: block !important; }

        /* Nav active state */
        .nav-link {
            opacity: 0.92;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            line-height: 1.1;
            white-space: nowrap;
        }
        .nav-link:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.12);
        }
        .nav-link.nav-active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.28);
        }

        /* Rent Details table usability: sticky first columns */
        #rentDetailsTable { border-collapse: separate; border-spacing: 0; }
        #rentDetailsTable th, #rentDetailsTable td { white-space: nowrap; }
        #rentDetailsTable th:nth-child(1), #rentDetailsTable td:nth-child(1) { position: sticky; left: 0; z-index: 30; }
        #rentDetailsTable th:nth-child(2), #rentDetailsTable td:nth-child(2) { position: sticky; left: 6rem; z-index: 30; }
        #rentDetailsTable th:nth-child(3), #rentDetailsTable td:nth-child(3) { position: sticky; left: 12rem; z-index: 30; }

        /* Rent & Water table usability: sticky first columns */
        #rentWaterTable { border-collapse: separate; border-spacing: 0; }
        #rentWaterTable th, #rentWaterTable td { white-space: nowrap; }
        #rentWaterTable th:nth-child(1), #rentWaterTable td:nth-child(1) { position: sticky; left: 0; z-index: 30; }
        #rentWaterTable th:nth-child(2), #rentWaterTable td:nth-child(2) { position: sticky; left: 6rem; z-index: 30; }
        #rentWaterTable th:nth-child(3), #rentWaterTable td:nth-child(3) { position: sticky; left: 12rem; z-index: 30; }

        /* Desktop view toggle: hide mobile-only nav + floating quick nav */
        .force-desktop .mobile-bottom-nav { display: none !important; }
        .force-desktop .quick-nav-desktop { display: none !important; }

        /* Mobile: make horizontal scrolling less cramped */
        @media (max-width: 640px) {
            /* Reduce sticky columns to just the first one (Room ID) */
            #rentDetailsTable th:nth-child(2), #rentDetailsTable td:nth-child(2),
            #rentDetailsTable th:nth-child(3), #rentDetailsTable td:nth-child(3),
            #rentWaterTable th:nth-child(2), #rentWaterTable td:nth-child(2),
            #rentWaterTable th:nth-child(3), #rentWaterTable td:nth-child(3) {
                position: static;
            }

            /* Larger tap targets on month cells */
            #rentDetailsTable th, #rentDetailsTable td,
            #rentWaterTable th, #rentWaterTable td,
            #waterBillTable th, #waterBillTable td {
                padding: 0.55rem 0.6rem !important;
                font-size: 0.85rem !important;
            }

            /* Keep month columns readable */
            #rentDetailsTable th:not(:nth-child(-n+3)),
            #rentDetailsTable td:not(:nth-child(-n+3)),
            #rentWaterTable th:not(:nth-child(-n+3)),
            #rentWaterTable td:not(:nth-child(-n+3)),
            #waterBillTable th:not(:nth-child(-n+3)),
            #waterBillTable td:not(:nth-child(-n+3)) {
                min-width: 3.2rem;
            }
        }
        /* Ledger Grid Transition */
        .month-box { transition: all 0.2s ease; }
        .month-box:active { transform: scale(0.95); }
        /* Dashboard Table Optimization */
        #dashboard-table input { width: 100% !important; }
        #dashboard-table input { padding: 0.25rem 0.4rem !important; font-size: 0.75rem !important; }
        #dashboard-table button { font-size: 0.7rem !important; padding: 0.25rem 0.4rem !important; }
        #dashboard-table td { padding: 0.4rem !important; }
        #dashboard-table th { padding: 0.4rem !important; font-size: 0.65rem !important; }
    </style>
</head>
<body class="bg-gradient-to-b from-slate-50 via-gray-50 to-gray-100 font-sans text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
        <div class="text-center bg-white p-10 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-building-user text-4xl text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-gray-800">Munirathnam Illam</h1>
            <p class="text-gray-500 mb-8">Secure Rent Management System</p>
            
            <button onclick="loginWithGoogle('user')" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 transition flex items-center justify-center shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google">
                Sign in with Google
            </button>
            <button onclick="loginWithGoogle('admin')" class="w-full mt-3 bg-gray-900 border border-gray-800 text-white font-semibold py-3 px-4 rounded-lg hover:bg-black transition flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-shield-halved mr-3"></i>
                Admin Portal Login
            </button>
            <p id="login-error" role="alert" aria-live="assertive" class="text-red-500 text-sm mt-4 hidden text-left bg-red-50 p-3 rounded border border-red-200"></p>
        </div>
    </div>

    <!-- APP CONTENT (Hidden by default) -->
    <div id="app-content" class="hidden-section">
        
        <!-- Navigation -->
        <nav class="bg-blue-600/95 text-white shadow-lg sticky top-0 z-40 backdrop-blur-md">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-building-user text-2xl"></i>
                    <span class="text-xl font-bold hidden md:inline">Munirathnam Illam</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div data-user-only="1" class="flex items-center gap-2 text-sm font-medium overflow-x-auto whitespace-nowrap max-w-[55vw] md:max-w-none">
                        <a href="#" data-section="dashboard" onclick="showSection('dashboard')" class="nav-link hover:text-blue-200 transition cursor-pointer">Dashboard</a>
                        <a href="#" data-section="room-details" onclick="showSection('room-details')" class="nav-link hover:text-blue-200 transition cursor-pointer">Room Details</a>
                        <a href="#" data-section="rent-details" onclick="showSection('rent-details')" class="nav-link hover:text-blue-200 transition cursor-pointer">Rent Details</a>
                        <a href="#" data-section="water-bill" onclick="showSection('water-bill')" class="nav-link hover:text-blue-200 transition cursor-pointer">Water Bill</a>
                        <a href="#" data-section="expenses" onclick="showSection('expenses')" class="nav-link hover:text-blue-200 transition cursor-pointer">Expenses</a>
                    </div>

                    <div data-admin-only="1" style="display:none" class="flex items-center gap-2 text-sm font-semibold overflow-x-auto whitespace-nowrap max-w-[55vw] md:max-w-none">
                        <a href="#" data-section="admin" onclick="showSection('admin')" class="nav-link hover:text-blue-200 transition cursor-pointer">Admin</a>
                    </div>
                    
                    <div class="flex items-center border-l border-blue-400 pl-4 ml-2">
                        <button type="button" onclick="toggleDesktopView()" class="mr-2 text-blue-100 hover:text-white" title="Toggle Desktop View">
                            <i class="fa-solid fa-desktop"></i>
                        </button>
                        <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full border-2 border-white mr-2">
                        <span id="user-name" class="text-sm font-semibold mr-4 hidden sm:block">User</span>
                        <button onclick="logout()" class="text-blue-100 hover:text-white" title="Sign Out">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8 pb-28 sm:pb-8">
            
            <!-- Dashboard (Financial Summary) -->
            <section id="dashboard" class="section-tab active mb-16">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Dashboard</h2>
                    <div class="flex flex-wrap items-center gap-2 text-sm text-gray-700">
                        <span class="font-semibold">Year</span>
                        <button type="button" onclick="changeDashboardYear(-1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Previous year">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <span id="dashboard-year" class="min-w-[4rem] text-center font-bold text-blue-800">----</span>
                        <button type="button" onclick="changeDashboardYear(1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Next year">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                        <button id="cleanupLockedMonthsBtn" data-cleanup-btn="1" type="button" onclick="runLockedMonthsCleanup()" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50 text-sm font-semibold text-gray-700" title="Clears any saved Paid/Pending/Rent Only totals in current & future months (post-paid lock)">
                            One-time cleanup
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="w-full overflow-x-auto">
                        <table class="text-sm w-full border-collapse">
                            <thead class="bg-blue-100 text-gray-700 sticky top-0">
                                <tr>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[8rem]">Month</th>
                                    <th class="border px-4 py-3 text-right font-semibold bg-blue-100 min-w-[10rem]">Rent Collected</th>
                                    <th class="border px-4 py-3 text-right font-semibold bg-blue-100 min-w-[10rem]">Expenses</th>
                                    <th class="border px-4 py-3 text-right font-semibold bg-blue-100 min-w-[10rem]">Water Charges</th>
                                    <th class="border px-4 py-3 text-right font-semibold bg-blue-100 min-w-[10rem]">Pending Rent</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardBody"></tbody>
                        </table>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-3">Rent Collected includes only months marked Paid. Water Charges are computed from meter readings.</p>
            </section>

            <!-- Room Details (formerly Dashboard) -->
            <section id="room-details" class="section-tab mb-16">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6 sm:mb-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-700">Room Details</h2>
                    <button data-cleanup-btn="1" type="button" onclick="runLockedMonthsCleanup()" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50 text-sm font-semibold text-gray-700" title="One-time: clears any saved Paid/Pending/Rent Only totals in current & future months (post-paid lock)">
                        One-time cleanup
                    </button>
                </div>

                <!-- Occupancy Metrics - Maximized -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 md:gap-8 mb-10 sm:mb-12 md:mb-16">
                    <!-- Card 1: Occupied Rooms -->
                    <div class="bg-white p-5 sm:p-6 md:p-8 rounded-2xl shadow-lg border-l-8 border-blue-500 hover:shadow-2xl transition transform hover:scale-105">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Occupied Rooms</p>
                                <p class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold text-blue-600" id="occupied-count">0</p>
                                <p class="text-base text-gray-400 mt-4">Out of 12</p>
                            </div>
                            <i class="fa-solid fa-door-open text-blue-500 text-5xl md:text-6xl opacity-20"></i>
                        </div>
                    </div>
                    
                    <!-- Card 2: Vacant Rooms -->
                    <div class="bg-white p-5 sm:p-6 md:p-8 rounded-2xl shadow-lg border-l-8 border-gray-400 hover:shadow-2xl transition transform hover:scale-105">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Vacant Rooms</p>
                                <p class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold text-gray-600" id="vacant-count">12</p>
                                <p class="text-base text-gray-400 mt-4">Available</p>
                            </div>
                            <i class="fa-solid fa-house text-gray-400 text-5xl md:text-6xl opacity-20"></i>
                        </div>
                    </div>
                    
                    <!-- Card 3: Total Rent Received (Previous Month) -->
                    <div class="bg-white p-5 sm:p-6 md:p-8 rounded-2xl shadow-lg border-l-8 border-green-500 hover:shadow-2xl transition transform hover:scale-105">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Rent Received</p>
                                <p class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-green-600" id="rent-received">₹0</p>
                                <p class="text-base text-gray-400 mt-4">Last month</p>
                            </div>
                            <i class="fa-solid fa-circle-check text-green-500 text-5xl md:text-6xl opacity-20"></i>
                        </div>
                    </div>
                    
                    <!-- Card 4: Pending Rent (Previous Month) -->
                    <div class="bg-white p-5 sm:p-6 md:p-8 rounded-2xl shadow-lg border-l-8 border-orange-500 hover:shadow-2xl transition transform hover:scale-105">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Pending Rent</p>
                                <p class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-orange-600" id="pending-rent">₹0</p>
                                <p class="text-base text-gray-400 mt-4">Last month</p>
                            </div>
                            <i class="fa-solid fa-exclamation-triangle text-orange-500 text-5xl md:text-6xl opacity-20"></i>
                        </div>
                    </div>
                </div>

                <!-- Rent Revision Due Card -->
                <div id="rentRevisionDueCard" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border-l-8 border-purple-500 mb-12">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800">Rent Revision Due Soon</h3>
                        <span id="rent-revision-count" class="inline-flex items-center justify-center px-3 py-1 rounded-lg text-sm font-semibold bg-purple-50 text-purple-800 border border-purple-200">0</span>
                    </div>
                    <div id="rentRevisionList" class="space-y-3">
                        <p class="text-gray-400">Loading...</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Based on last rent revision date (fallback: relocation date). Click a tenant to open their room card and edit rent.</p>
                </div>

                <!-- Pending last Month (Quick List) -->
                <div id="pendingThisMonthCard" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border-l-8 border-orange-500 mb-12">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800">Pending last month</h3>
                        <span id="pending-this-month-count" class="inline-flex items-center justify-center px-3 py-1 rounded-lg text-sm font-semibold bg-orange-50 text-orange-800 border border-orange-200">0</span>
                    </div>
                    <div id="pendingThisMonthList" class="space-y-3">
                        <p class="text-gray-400">Loading...</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Click a row to open Rent Details.</p>
                </div>

                <!-- 12 Immutable Rooms Section -->
                <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8">Room Details</h3>
                <div id="roomCardsGrid" class="space-y-5">
                    <!-- 12 Room Cards will be generated by JavaScript -->
                </div>

            </section>

            <!-- Rent Details Section -->
            <section id="rent-details" class="section-tab mb-10">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-2">
                    <h2 class="text-2xl font-bold text-gray-700">Rent Details</h2>
                    <div class="flex items-center gap-2 text-sm text-gray-700">
                        <span class="font-semibold">Year</span>
                        <button type="button" onclick="changeRentDetailsYear(-1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Previous year">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <span id="rent-details-year" class="min-w-[4rem] text-center font-bold text-blue-800">----</span>
                        <button type="button" onclick="changeRentDetailsYear(1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Next year">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <p class="text-gray-500 mb-4">Monthly rent payment status for all rooms - select a year, then click any month to toggle (Pending/Rent Only/Paid/None)</p>
                
                <!-- Rent Details Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="w-full overflow-x-auto">
                        <table id="rentDetailsTable" class="text-sm w-full border-collapse">
                            <thead class="bg-blue-100 text-gray-700 sticky top-0">
                                <tr>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[6rem]">Room ID</th>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[6rem]">Room No</th>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[10rem]">Tenant Name</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jan</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Feb</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Mar</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Apr</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">May</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jun</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jul</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Aug</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Sep</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Oct</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Nov</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Dec</th>
                                </tr>
                            </thead>
                            <tbody id="rentDetailsBody" class="divide-y">
                                <tr>
                                    <td colspan="15" class="text-center py-10 text-gray-400">
                                        Loading room data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Legend -->
                <div class="mt-6 flex justify-center gap-8 text-sm flex-wrap">
                    <span class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-gray-200 border border-gray-400 rounded flex items-center justify-center text-xs">-</div>
                        <span>Vacant (No Tenant)</span>
                    </span>
                    <span class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-red-100 border-2 border-red-400 rounded flex items-center justify-center text-red-600 font-bold text-xs">✗</div>
                        <span>Pending (Not Paid)</span>
                    </span>
                    <span class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-purple-100 border-2 border-purple-400 rounded flex items-center justify-center text-purple-600 font-bold text-xs">✓</div>
                        <span>Rent Only (No Water Bill)</span>
                    </span>
                    <span class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-green-100 border-2 border-green-400 rounded flex items-center justify-center text-green-600 font-bold text-xs">✓</div>
                        <span>Complete (Rent + Water)</span>
                    </span>
                </div>

                <!-- Rent & Water (+60) Table -->
                <div class="mt-12">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Rent and Water</h3>
                    <p class="text-gray-500 mb-4">Auto-calculated from Rent Details. When a month is marked <span class="font-semibold">Paid (green)</span> there, this table shows <span class="font-semibold">Rent + Water Bill + 60</span>.</p>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="w-full overflow-x-auto">
                            <table id="rentWaterTable" class="text-sm w-full border-collapse">
                                <thead class="bg-blue-100 text-gray-700 sticky top-0">
                                    <tr>
                                        <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[6rem]">Room ID</th>
                                        <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[6rem]">Room No</th>
                                        <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[10rem]">Tenant Name</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jan</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Feb</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Mar</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Apr</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">May</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jun</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jul</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Aug</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Sep</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Oct</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Nov</th>
                                        <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Dec</th>
                                    </tr>
                                </thead>
                                <tbody id="rentWaterBody" class="divide-y">
                                    <tr>
                                        <td colspan="15" class="text-center py-10 text-gray-400">
                                            Loading rent &amp; water data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Water Bill Section -->
            <section id="water-bill" class="section-tab mb-10">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-2">
                    <h2 class="text-2xl font-bold text-gray-700">Water Bill</h2>
                    <div class="flex items-center gap-2 text-sm text-gray-700">
                        <span class="font-semibold">Year</span>
                        <button type="button" onclick="changeWaterBillYear(-1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Previous year">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <span id="water-bill-year" class="min-w-[4rem] text-center font-bold text-blue-800">----</span>
                        <button type="button" onclick="changeWaterBillYear(1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Next year">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                    <p class="text-gray-500">Enter monthly meter reading for each tenant. Units = (current − previous) × 10. Amount = Units × Rate</p>
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="resetWaterRatesToDefault()" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50 font-semibold text-gray-700">
                            Reset Water Rate Defaults
                        </button>
                        <button type="button" onclick="openWaterImportModal()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">
                            Import Readings
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="w-full overflow-x-auto">
                        <table id="waterBillTable" class="text-sm w-full border-collapse">
                            <thead class="bg-blue-100 text-gray-700 sticky top-0">
                                <tr>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[6rem]">Room ID</th>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[6rem]">Room No</th>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[10rem]">Tenant Name</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jan</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Feb</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Mar</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Apr</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">May</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jun</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Jul</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Aug</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Sep</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Oct</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Nov</th>
                                    <th class="border px-4 py-3 text-center font-semibold bg-blue-100">Dec</th>
                                </tr>
                            </thead>
                            <tbody id="waterBillBody" class="divide-y">
                                <tr>
                                    <td colspan="15" class="text-center py-10 text-gray-400">
                                        Loading water bill data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Expenses Section -->
            <section id="expenses" class="section-tab mb-10">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-2">
                    <h2 class="text-2xl font-bold text-gray-700">Expenses</h2>
                    <div class="flex items-center gap-2 text-sm text-gray-700">
                        <span class="font-semibold">Year</span>
                        <button type="button" onclick="changeExpensesYear(-1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Previous year">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <span id="expenses-year" class="min-w-[4rem] text-center font-bold text-blue-800">----</span>
                        <button type="button" onclick="changeExpensesYear(1)" class="px-3 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Next year">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <p class="text-gray-500 mb-4">Add item-wise expenses (salary, electricity, internet, maintenance). Dashboard shows month totals.</p>

                <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-100">
                    <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Date</label>
                            <input type="date" id="expenseDate" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Category</label>
                            <select id="expenseCategory" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="House Keeping Salary">House Keeping Salary</option>
                                <option value="Electricity Bill">Electricity Bill</option>
                                <option value="Internet Bill">Internet Bill</option>
                                <option value="Painting">Painting</option>
                                <option value="Room Maintenance">Room Maintenance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Note</label>
                            <input type="text" id="expenseNote" placeholder="Optional" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Amount (₹)</label>
                            <input type="number" id="expenseAmount" min="0" step="0.01" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div class="md:col-span-4 flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Add Expense</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="w-full overflow-x-auto">
                        <table class="text-sm w-full border-collapse">
                            <thead class="bg-blue-100 text-gray-700 sticky top-0">
                                <tr>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[8rem]">Month</th>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[9rem]">Date</th>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[12rem]">Category</th>
                                    <th class="border px-4 py-3 text-left font-semibold bg-blue-100 min-w-[14rem]">Note</th>
                                    <th class="border px-4 py-3 text-right font-semibold bg-blue-100 min-w-[8rem]">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="expensesBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Admin Section (Admin Portal only) -->
            <section id="admin" class="section-tab mb-16">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Admin</h2>
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 max-w-2xl">
                    <p class="text-sm text-gray-600 mb-2">Admin-only settings. Regular users cannot view this.</p>
                    <p class="text-xs text-orange-700 mb-4">Note: Email automation is paused while running on Firebase Spark (no server-side Functions).</p>

                    <label class="block text-gray-700 font-semibold mb-2">Admin Email (saved for future)</label>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input id="adminEmailInput" type="email" placeholder="admin@example.com" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        <button type="button" onclick="saveAdminEmail()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Save</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">This email is stored securely (admin-only). Email sending will be enabled if/when you switch to Blaze.</p>
                </div>
            </section>

            <!-- Rooms Section -->
            <section id="rooms" class="section-tab mb-10">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-700">Rooms</h2>
                    
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <!-- Search & Filter Controls -->
                        <div class="relative w-full sm:w-64">
                            <input type="text" id="searchInput" oninput="applyFilters()" placeholder="Search..." class="pl-9 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full shadow-sm">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        
                        <select id="filterStatus" onchange="applyFilters()" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="All">All Status</option>
                            <option value="Occupied">Occupied</option>
                            <option value="Vacant">Vacant</option>
                        </select>
                        
                        <select id="filterPayment" onchange="applyFilters()" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="All">All Payments</option>
                            <option value="Pending">Pending</option>
                            <option value="Paid">Paid</option>
                        </select>

                        <div class="flex gap-2">
                            <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center justify-center">
                                <i class="fa-solid fa-file-csv mr-2"></i> Export
                            </button>

                            <button onclick="toggleModal('propertyModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center justify-center">
                                <i class="fa-solid fa-plus mr-2"></i> Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property Grid -->
                <div id="property-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Loading State -->
                    <div class="col-span-full text-center py-12">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p class="text-gray-500">Loading your rooms from cloud...</p>
                    </div>
                </div>
            </section>

        </main>

        <!-- Floating Quick Nav (desktop/tablet) -->
        <div data-user-only="1" class="quick-nav-desktop fixed left-4 top-1/4 z-30 hidden sm:flex flex-col gap-2">
            <button type="button" onclick="showSection('dashboard')" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/90 hover:bg-white border border-gray-200 shadow-md text-gray-700 text-sm font-semibold transition" title="Dashboard">
                <i class="fa-solid fa-chart-line text-blue-600"></i>
                <span class="hidden md:inline">Dashboard</span>
            </button>
            <button type="button" onclick="showSection('room-details')" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/90 hover:bg-white border border-gray-200 shadow-md text-gray-700 text-sm font-semibold transition" title="Room Details">
                <i class="fa-solid fa-house text-blue-600"></i>
                <span class="hidden md:inline">Rooms</span>
            </button>
            <button type="button" onclick="showSection('rent-details')" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/90 hover:bg-white border border-gray-200 shadow-md text-gray-700 text-sm font-semibold transition" title="Rent Details">
                <i class="fa-solid fa-receipt text-purple-600"></i>
                <span class="hidden md:inline">Rent</span>
            </button>
            <button type="button" onclick="showSection('water-bill')" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/90 hover:bg-white border border-gray-200 shadow-md text-gray-700 text-sm font-semibold transition" title="Water Bill">
                <i class="fa-solid fa-droplet text-blue-600"></i>
                <span class="hidden md:inline">Water</span>
            </button>
            <button type="button" onclick="showSection('expenses')" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/90 hover:bg-white border border-gray-200 shadow-md text-gray-700 text-sm font-semibold transition" title="Expenses">
                <i class="fa-solid fa-wallet text-red-600"></i>
                <span class="hidden md:inline">Expenses</span>
            </button>
        </div>

        <!-- Bottom Nav (mobile) -->
        <div data-user-only="1" class="mobile-bottom-nav fixed bottom-0 inset-x-0 z-40 sm:hidden bg-white/95 backdrop-blur-md border-t border-gray-200">
            <div class="max-w-screen-sm mx-auto px-3 py-2 grid grid-cols-5 gap-2">
                <button type="button" onclick="showSection('dashboard')" class="flex flex-col items-center justify-center py-2 rounded-xl border border-gray-200 bg-white shadow-sm text-[11px] font-semibold text-gray-700">
                    <i class="fa-solid fa-chart-line text-blue-600 text-base"></i>
                    <span class="mt-1">Dash</span>
                </button>
                <button type="button" onclick="showSection('room-details')" class="flex flex-col items-center justify-center py-2 rounded-xl border border-gray-200 bg-white shadow-sm text-[11px] font-semibold text-gray-700">
                    <i class="fa-solid fa-house text-blue-600 text-base"></i>
                    <span class="mt-1">Rooms</span>
                </button>
                <button type="button" onclick="showSection('rent-details')" class="flex flex-col items-center justify-center py-2 rounded-xl border border-gray-200 bg-white shadow-sm text-[11px] font-semibold text-gray-700">
                    <i class="fa-solid fa-receipt text-purple-600 text-base"></i>
                    <span class="mt-1">Rent</span>
                </button>
                <button type="button" onclick="showSection('water-bill')" class="flex flex-col items-center justify-center py-2 rounded-xl border border-gray-200 bg-white shadow-sm text-[11px] font-semibold text-gray-700">
                    <i class="fa-solid fa-droplet text-blue-600 text-base"></i>
                    <span class="mt-1">Water</span>
                </button>
                <button type="button" onclick="showSection('expenses')" class="flex flex-col items-center justify-center py-2 rounded-xl border border-gray-200 bg-white shadow-sm text-[11px] font-semibold text-gray-700">
                    <i class="fa-solid fa-wallet text-red-600 text-base"></i>
                    <span class="mt-1">Cost</span>
                </button>
            </div>
        </div>

        <div data-admin-only="1" style="display:none" class="fixed bottom-0 inset-x-0 z-40 sm:hidden bg-white/95 backdrop-blur-md border-t border-gray-200">
            <div class="max-w-screen-sm mx-auto px-3 py-2">
                <button type="button" onclick="showSection('admin')" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl border border-gray-200 bg-white shadow-sm text-sm font-semibold text-gray-700">
                    <i class="fa-solid fa-shield-halved text-blue-600"></i>
                    <span>Admin</span>
                </button>
            </div>
        </div>
    </div>

    <!-- WATER READINGS IMPORT MODAL -->
    <div id="waterImportModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="water-import-title" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden border border-gray-100">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <div>
                    <h3 id="water-import-title" class="text-xl font-bold text-gray-800">Import Water Readings</h3>
                    <p class="text-sm text-gray-500 mt-1">Paste rows copied from Excel (CSV or tab-separated).</p>
                </div>
                <button type="button" onclick="closeWaterImportModal()" class="text-gray-500 hover:text-red-600 text-2xl" aria-label="Close">&times;</button>
            </div>

            <div class="p-6 space-y-4">
                <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 text-sm text-gray-700">
                    <p class="font-semibold text-blue-900 mb-2">Supported formats (one row per line)</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><span class="font-mono">RoomId, 2025-Jan, 1234</span></li>
                        <li><span class="font-mono">RoomNo, 2025-Jan, 1234</span></li>
                        <li><span class="font-mono">RoomId, 2025, Jan, 1234</span></li>
                        <li><span class="font-mono">Excel table format:</span> <span class="font-mono">Room No</span>, <span class="font-mono">Room ID</span>, <span class="font-mono">Tenant Name</span>, <span class="font-mono">Apr</span>, <span class="font-mono">May</span>, <span class="font-mono">Jun</span>…</li>
                        <li><span class="font-mono">Excel month headers may include year:</span> <span class="font-mono">Apr-2024</span>, <span class="font-mono">Apr 24</span>, <span class="font-mono">04/2024</span>, <span class="font-mono">2024-Apr</span></li>
                        <li>Separator can be comma or tab</li>
                    </ul>
                    <p class="text-xs text-gray-500 mt-2">If month headers don’t include a year (e.g. “April”), the import uses the Water Bill year currently selected in the app.</p>
                    <p class="text-xs text-gray-500 mt-2">Note: Units are calculated as (current − previous) × 10.</p>
                </div>

                <textarea id="waterImportText" rows="10" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm" placeholder="Paste here..."></textarea>

                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <button type="button" onclick="document.getElementById('waterImportText').value='';" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50 font-semibold text-gray-700">Clear</button>
                    <div class="flex gap-3 justify-end">
                        <button type="button" onclick="closeWaterImportModal()" class="px-4 py-2 rounded-lg border bg-white hover:bg-gray-50 font-semibold text-gray-700">Cancel</button>
                        <button type="button" onclick="runWaterImport()" class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">Import</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TENANT DETAILS MODAL -->
    <div id="tenantDetailsModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="tenant-modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 transform transition-all scale-100 m-4 overflow-y-auto max-h-screen">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="tenant-modal-title" class="text-2xl font-bold text-gray-800">Tenant Details</h3>
                <button onclick="closeTenantDetailsModal()" class="text-gray-500 hover:text-red-500 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            
            <div id="tenantDetailsModalContent" class="space-y-6">
                <!-- Details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ADD TENANT MODAL -->
    <div id="addTenantModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="add-tenant-modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 transform transition-all scale-100 m-4 overflow-y-auto max-h-screen">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="add-tenant-modal-title" class="text-2xl font-bold text-gray-800">Add New Tenant</h3>
                <button onclick="closeAddTenantModal()" class="text-gray-500 hover:text-red-500 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            
            <form id="addTenantForm" class="space-y-4">
                <!-- Room Selector -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Select Room <span class="text-red-500">*</span></label>
                    <select id="roomSelector" onchange="window.prefillRoomDetails()" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Choose a room --</option>
                        <option value="01">Room 01 (G01)</option>
                        <option value="02">Room 02 (G02)</option>
                        <option value="04">Room 04 (102)</option>
                        <option value="05">Room 05 (201)</option>
                        <option value="06">Room 06 (202)</option>
                        <option value="07">Room 07 (203)</option>
                        <option value="08">Room 08 (301)</option>
                        <option value="09">Room 09 (302)</option>
                        <option value="10">Room 10 (303)</option>
                        <option value="11">Room 11 (401)</option>
                        <option value="12">Room 12 (402)</option>
                        <option value="13">Room 13 (403)</option>
                    </select>
                </div>

                <!-- Auto-filled Immutable Room Details (Read-only) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Room No</label>
                        <input type="text" id="tenantRoomNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Room ID</label>
                        <input type="text" id="tenantRoomId" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Key No</label>
                        <input type="text" id="tenantKeyNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">EB Service No</label>
                        <input type="text" id="tenantEbServNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">EB Account No</label>
                        <input type="text" id="tenantEbAcNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                </div>

                <!-- Tenant Details (User Input) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Tenant Name <span class="text-red-500">*</span></label>
                        <input type="text" id="tenantNameInput" required placeholder="e.g. Ramesh" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Contact Number <span class="text-red-500">*</span></label>
                        <input type="tel" id="tenantContact" required placeholder="e.g. 9876543210" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Monthly Rent (₹) <span class="text-red-500">*</span></label>
                        <input type="number" id="tenantRent" required min="1" placeholder="e.g. 5600" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Water Rate (₹/Unit)</label>
                        <input type="number" id="tenantWaterRate" min="0" step="0.01" placeholder="e.g. 0.25" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Defaults to 0.25 (Rooms 11–13 default 0.20). You can edit.</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Security Deposit (₹) <span class="text-red-500">*</span></label>
                        <input type="number" id="tenantDeposit" required min="0" placeholder="e.g. 25000" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Date of Relocation <span class="text-red-500">*</span></label>
                        <input type="date" id="tenantRelocateDate" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Last Rent Revision Date</label>
                        <input type="date" id="tenantLastRevisionDate" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Set when rent is revised; used for next 1-year trigger.</p>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6 border-t pt-4">
                    <button type="button" onclick="closeAddTenantModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" id="saveTenantBtn" disabled class="px-6 py-2 bg-gray-400 text-white rounded-lg font-semibold cursor-not-allowed">
                        <i class="fa-solid fa-save mr-2"></i>Save Tenant
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Room Modal -->
    <div id="propertyModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Add New Room</h3>
                <button onclick="toggleModal('propertyModal')" class="text-gray-500 hover:text-red-500 text-xl" aria-label="Close modal">&times;</button>
            </div>
            
            <form id="addPropertyForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Room No/Address</label>
                    <input type="text" id="propName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 123 Main St, Apt 4B">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Monthly Rent (₹)</label>
                    <input type="number" id="propRent" required min="1" step="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 12000">
                </div>
                
                <div class="mb-4">
                     <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                     <select id="propStatus" onchange="toggleTenantInput()" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <option value="Vacant">Vacant</option>
                        <option value="Occupied">Occupied</option>
                    </select>
                    
                    <div id="tenantInputGroup" class="hidden">
                        <input type="text" id="tenantName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="Enter Tenant Name">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Payment Status</label>
                    <select id="payStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Pending">Pending</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="toggleModal('propertyModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <span id="btn-text">Save Room</span>
                        <i id="btn-loader" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- RENT HISTORY MODAL (New Feature) -->
    <div id="historyModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 relative">
            <button onclick="closeHistoryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            
            <h3 class="text-xl font-bold text-gray-800 mb-1" id="history-title">Rent Ledger</h3>
            <p class="text-sm text-gray-500 mb-6" id="history-subtitle">Track monthly payments</p>

            <!-- Year Selector -->
            <div class="flex justify-between items-center mb-4 bg-gray-50 p-3 rounded-lg">
                <button onclick="changeLedgerYear(-1)" class="text-gray-600 hover:text-blue-600"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="ledger-year" class="text-lg font-bold text-blue-800">2025</span>
                <button onclick="changeLedgerYear(1)" class="text-gray-600 hover:text-blue-600"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <!-- Month Grid -->
            <div class="grid grid-cols-3 gap-3" id="ledger-grid">
                <!-- Months generated by JS -->
            </div>

            <div class="mt-6 text-xs text-gray-400 flex justify-center gap-4">
                <span class="flex items-center"><i class="fa-solid fa-circle text-gray-200 mr-1"></i> No Record</span>
                <span class="flex items-center"><i class="fa-solid fa-circle text-red-500 mr-1"></i> Pending</span>
                <span class="flex items-center"><i class="fa-solid fa-circle text-green-500 mr-1"></i> Paid</span>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULE LOGIC -->
    <script type="module">
        // Imports MUST be at top level
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCH2Q18CquL9IGi9t6KovkSqQj3DYnXf9g",
            authDomain: "munirathnam-illam.firebaseapp.com",
            projectId: "munirathnam-illam",
            storageBucket: "munirathnam-illam.firebasestorage.app",
            messagingSenderId: "852272424128",
            appId: "1:852272424128:web:e5400d3d2f512d7e477925",
            measurementId: "G-7NF6X62CKV"
        };

        // Initialize Firebase (variables at module scope so functions can access them)
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        console.log("✓ Firebase initialized successfully");

        // VIEWPORT / DESKTOP VIEW TOGGLE (for mobile browsers)
        function applyDesktopViewportMode() {
            const meta = document.querySelector('meta[name="viewport"]');
            if (!meta) return;
            meta.setAttribute('content', 'width=1100');
            document.body.classList.add('force-desktop');
        }

        function applyMobileViewportMode() {
            const meta = document.querySelector('meta[name="viewport"]');
            if (!meta) return;
            meta.setAttribute('content', 'width=device-width, initial-scale=1.0');
            document.body.classList.remove('force-desktop');
        }

        function getDesktopViewEnabled() {
            try { return localStorage.getItem('forceDesktopView') === '1'; } catch { return false; }
        }

        function setDesktopViewEnabled(enabled) {
            try { localStorage.setItem('forceDesktopView', enabled ? '1' : '0'); } catch {}
        }

        window.toggleDesktopView = () => {
            const next = !getDesktopViewEnabled();
            setDesktopViewEnabled(next);
            // Reload is the most reliable way to re-layout with a new viewport.
            window.location.reload();
        };

        // Apply stored preference ASAP
        if (getDesktopViewEnabled()) {
            applyDesktopViewportMode();
        } else {
            applyMobileViewportMode();
        }

        const DEFAULT_WATER_RATE = 0.25;
        const DISCOUNTED_WATER_RATE = 0.20;
        const DISCOUNTED_WATER_ROOMS = new Set(['11', '12', '13']);

        // Business rule: water units are (current - previous) multiplied by this factor.
        const WATER_UNITS_MULTIPLIER = 10;

        const RENT_WATER_SERVICE_CHARGE = 60;

        const RENT_REVISION_WINDOW_DAYS = 15;

        function getDefaultWaterRateForRoom(roomNo) {
            const room = String(roomNo || '').trim();
            if (DISCOUNTED_WATER_ROOMS.has(room)) return DISCOUNTED_WATER_RATE;
            return DEFAULT_WATER_RATE;
        }

        function parseDateValue(value) {
            if (!value) return null;
            if (value instanceof Date) return Number.isNaN(value.getTime()) ? null : value;
            if (typeof value?.toDate === 'function') {
                const d = value.toDate();
                return d && !Number.isNaN(d.getTime()) ? d : null;
            }
            if (typeof value?.toMillis === 'function') {
                const d = new Date(value.toMillis());
                return !Number.isNaN(d.getTime()) ? d : null;
            }
            if (typeof value === 'number') {
                const d = new Date(value);
                return !Number.isNaN(d.getTime()) ? d : null;
            }
            if (typeof value === 'string') {
                const trimmed = value.trim();
                if (!trimmed) return null;
                const d = new Date(trimmed);
                return !Number.isNaN(d.getTime()) ? d : null;
            }
            return null;
        }

        function getNextAnniversaryDate(relocateDate, now = new Date()) {
            const base = relocateDate instanceof Date ? relocateDate : parseDateValue(relocateDate);
            if (!base) return null;

            const today = new Date(now);
            today.setHours(0, 0, 0, 0);

            const anniversary = new Date(base);
            anniversary.setHours(0, 0, 0, 0);
            anniversary.setFullYear(today.getFullYear());

            if (anniversary < today) {
                anniversary.setFullYear(anniversary.getFullYear() + 1);
            }
            return anniversary;
        }

        function formatDateForInput(date) {
            const d = date instanceof Date ? date : parseDateValue(date);
            if (!d) return '';
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function formatDateForDisplay(date, fallback = 'N/A') {
            const d = date instanceof Date ? date : parseDateValue(date);
            return d
                ? d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })
                : fallback;
        }

        function addYears(date, years = 1) {
            const d = date instanceof Date ? date : parseDateValue(date);
            if (!d) return null;
            const out = new Date(d);
            out.setHours(0, 0, 0, 0);
            out.setFullYear(out.getFullYear() + years);
            return out;
        }

        // Rent revision is considered due 1 year after last revision date.
        // If last revision is missing, fallback to relocation date.
        // If tenant is marked as `noAnnualRevision`, revision tracking is disabled.
        function getRentRevisionDates(tenantData, today = new Date()) {
            const t = tenantData || {};
            const relocateDate = parseDateValue(t.relocate);
            const lastRevisionDate = parseDateValue(t.lastRentRevisionAt);

            const noAnnualRevision = Boolean(t.noAnnualRevision);
            if (noAnnualRevision) {
                return { relocateDate, lastRevisionDate, nextDue: null, daysTo: null, noAnnualRevision: true };
            }

            const base = lastRevisionDate || relocateDate;

            const normalizedToday = new Date(today);
            normalizedToday.setHours(0, 0, 0, 0);

            const nextDue = base ? addYears(base, 1) : null;
            const daysTo = nextDue
                ? Math.round((nextDue.getTime() - normalizedToday.getTime()) / (1000 * 60 * 60 * 24))
                : null;

            return { relocateDate, lastRevisionDate, nextDue, daysTo, noAnnualRevision: false };
        }

        // GLOBAL STATE
        let currentUser = null;
        let unsubscribe = null;
        let expensesUnsubscribe = null;
        let allPropertiesData = [];
        let allExpensesData = [];
        let currentLedgerPropId = null;
        let currentLedgerYear = new Date().getFullYear();
        let currentRentDetailsYear = new Date().getFullYear();
        let currentWaterBillYear = new Date().getFullYear();
        let currentDashboardYear = new Date().getFullYear();
        let currentExpensesYear = new Date().getFullYear();

        let isAdminSession = false;

        function setLoginMode(mode) {
            const next = (mode === 'admin') ? 'admin' : 'user';
            try { sessionStorage.setItem('loginMode', next); } catch (e) {}
            return next;
        }

        function getLoginMode() {
            try {
                const v = sessionStorage.getItem('loginMode');
                return v === 'admin' ? 'admin' : 'user';
            } catch {
                return 'user';
            }
        }

        function applySessionNavMode() {
            document.querySelectorAll('[data-user-only]').forEach(el => {
                el.style.display = isAdminSession ? 'none' : '';
            });
            document.querySelectorAll('[data-admin-only]').forEach(el => {
                el.style.display = isAdminSession ? '' : 'none';
            });
        }

        async function loadAdminSettings() {
            if (!currentUser || !isAdminSession) return;
            try {
                const ref = doc(db, 'adminSettings', 'main');
                const snap = await getDoc(ref);
                const email = snap.exists() ? (snap.data()?.adminEmail || '') : '';
                const input = document.getElementById('adminEmailInput');
                if (input) input.value = String(email || '');
            } catch (e) {
                console.warn('⚠️ loadAdminSettings failed:', e);
            }
        }

        window.saveAdminEmail = async () => {
            if (!currentUser || !isAdminSession) {
                showNotification('Admin login required', 'warning');
                return;
            }
            const input = document.getElementById('adminEmailInput');
            const email = String(input?.value || '').trim();
            if (!email || !email.includes('@')) {
                showNotification('Please enter a valid admin email', 'warning');
                return;
            }
            try {
                await setDoc(doc(db, 'adminSettings', 'main'), {
                    adminEmail: email,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                }, { merge: true });
                showNotification('✓ Admin email saved', 'success');
            } catch (e) {
                console.error('saveAdminEmail failed', e);
                showNotification('Error: ' + (e?.message || 'Unknown error'), 'error');
            }
        };

        // HELPERS (room matching + occupancy)
        function isOccupiedRecord(record) {
            if (!record) return false;
            const status = String(record.status || '').trim().toLowerCase();
            if (status === 'occupied') return true;
            // Fallback: if tenant details exist but status wasn't updated, treat as occupied
            const tenant = String(record.tenant || '').trim().toLowerCase();
            return Boolean(tenant) && tenant !== 'none' && tenant !== 'assigned';
        }

        function getRecordSortTimeMs(record) {
            if (!record) return 0;
            const ts = record.updatedAt ?? record.createdAt;
            if (!ts) return 0;
            if (typeof ts === 'number') return ts;
            if (typeof ts === 'string') {
                const parsed = Date.parse(ts);
                return Number.isNaN(parsed) ? 0 : parsed;
            }
            if (typeof ts?.toMillis === 'function') return ts.toMillis();
            if (typeof ts?.seconds === 'number') {
                const nanos = typeof ts?.nanoseconds === 'number' ? ts.nanoseconds : 0;
                return (ts.seconds * 1000) + Math.floor(nanos / 1e6);
            }
            return 0;
        }

        function isFutureYearMonth(year, monthIndex, now = new Date()) {
            const y = Number(year);
            const m = Number(monthIndex);
            if (!Number.isFinite(y) || !Number.isFinite(m)) return false;
            const nowY = now.getFullYear();
            const nowM = now.getMonth();
            if (y > nowY) return true;
            if (y < nowY) return false;
            // Post-paid model: lock the current month as well.
            // Example: during Jan, Jan is locked; it becomes editable only in Feb.
            return m >= nowM;
        }

        function findRestoreCandidateForRoomId(roomId) {
            const rid = String(roomId || '').trim();
            if (!rid) return null;
            const candidates = (Array.isArray(allPropertiesData) ? allPropertiesData : [])
                .filter(p => String(p?.roomId || '').trim() === rid);

            const withArchived = candidates.filter(p => p && p.archivedTenant);
            if (withArchived.length === 0) return null;

            const vacantArchived = withArchived.filter(p => !isOccupiedRecord(p));
            const list = vacantArchived.length ? vacantArchived : withArchived;
            const sorted = [...list].sort((a, b) => getRecordSortTimeMs(b) - getRecordSortTimeMs(a));
            return sorted[0] || null;
        }

        function pickBestRoomRecord(records) {
            if (!Array.isArray(records) || records.length === 0) return null;
            const sorted = [...records].sort((a, b) => {
                const occA = isOccupiedRecord(a) ? 1 : 0;
                const occB = isOccupiedRecord(b) ? 1 : 0;
                if (occA !== occB) return occB - occA;

                const timeA = getRecordSortTimeMs(a);
                const timeB = getRecordSortTimeMs(b);
                if (timeA !== timeB) return timeB - timeA;

                const tenantA = String(a?.tenant || '').trim();
                const tenantB = String(b?.tenant || '').trim();
                if (!!tenantA !== !!tenantB) return tenantB ? 1 : -1;

                return 0;
            });
            return sorted[0] || null;
        }

        function findTenantForRoom(roomData) {
            if (!roomData) return null;
            const roomId = String(roomData.roomId || '').trim();
            const roomNo = String(roomData.roomNo || '').trim();

            // NOTE: There can be multiple docs per room in `properties` (older data, manual adds).
            // Prefer an occupied record, then the most recently updated/created.
            const expectedNames = new Set([
                roomNo,
                `Room ${roomNo}`,
                roomId
            ].filter(Boolean));

            const candidates = allPropertiesData.filter(p => {
                const pRoomId = String(p?.roomId || '').trim();
                const pRoomNo = String(p?.roomNo || '').trim();
                const pName = String(p?.name || '').trim();

                if (roomId && pRoomId === roomId) return true;
                if (roomNo && pRoomNo === roomNo) return true;
                if (roomNo && pName === roomNo) return true;
                if (expectedNames.size && expectedNames.has(pName)) return true;
                return false;
            });

            return pickBestRoomRecord(candidates);
        }

        // IMMUTABLE ROOMS DATA - 12 Fixed Rooms (From Image)
        const IMMUTABLE_ROOMS_DATA = {
            '01': { roomNo: '01', roomId: 'G01', keyNo: '124', ebServNo: '19781', ebAcNo: '5097784' },
            '02': { roomNo: '02', roomId: 'G02', keyNo: '153', ebServNo: '19778', ebAcNo: '5097781' },
            '04': { roomNo: '04', roomId: '102', keyNo: '76', ebServNo: '19780', ebAcNo: '5097783' },
            '05': { roomNo: '05', roomId: '201', keyNo: '151', ebServNo: '19779', ebAcNo: '5097782' },
            '06': { roomNo: '06', roomId: '202', keyNo: '185', ebServNo: '19782', ebAcNo: '5097785' },
            '07': { roomNo: '07', roomId: '203', keyNo: '101', ebServNo: '19783', ebAcNo: '5097786' },
            '08': { roomNo: '08', roomId: '301', keyNo: '403', ebServNo: '19784', ebAcNo: '5097787' },
            '09': { roomNo: '09', roomId: '302', keyNo: '249', ebServNo: '19785', ebAcNo: '5097788' },
            '10': { roomNo: '10', roomId: '303', keyNo: '123', ebServNo: '19789', ebAcNo: '5097792' },
            '11': { roomNo: '11', roomId: '401', keyNo: '35', ebServNo: '19788', ebAcNo: '5097791' },
            '12': { roomNo: '12', roomId: '402', keyNo: '144', ebServNo: '19787', ebAcNo: '5097790' },
            '13': { roomNo: '13', roomId: '403', keyNo: '120', ebServNo: '19786', ebAcNo: '5097789' }
        };

        // PREFILL ROOM DETAILS FROM SELECTOR
        window.prefillRoomDetails = () => {
            const roomNo = document.getElementById('roomSelector').value;
            const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
            
            if (roomData) {
                document.getElementById('tenantRoomNo').value = roomData.roomNo;
                document.getElementById('tenantRoomId').value = roomData.roomId;
                document.getElementById('tenantKeyNo').value = roomData.keyNo;
                document.getElementById('tenantEbServNo').value = roomData.ebServNo;
                document.getElementById('tenantEbAcNo').value = roomData.ebAcNo;

                // Water Rate prefill: prefer existing tenant override, else room-based default
                const rateInput = document.getElementById('tenantWaterRate');
                if (rateInput) {
                    const tenantData = findTenantForRoom(roomData);
                    const existing = tenantData?.waterRate;
                    const hasExisting = existing !== null && existing !== undefined && String(existing).trim() !== '';
                    const rateToUse = hasExisting ? parseFloat(existing) : getDefaultWaterRateForRoom(roomData.roomNo);
                    rateInput.value = Number.isFinite(rateToUse) ? String(rateToUse) : '';
                }
            } else {
                // Clear fields if no room selected
                document.getElementById('tenantRoomNo').value = '';
                document.getElementById('tenantRoomId').value = '';
                document.getElementById('tenantKeyNo').value = '';
                document.getElementById('tenantEbServNo').value = '';
                document.getElementById('tenantEbAcNo').value = '';

                const rateInput = document.getElementById('tenantWaterRate');
                if (rateInput) rateInput.value = '';
            }
        };

        // GENERATE 12 IMMUTABLE ROOM CARDS - MINIMAL VIEW (Tenant Name + Status Only)
        window.generateRoomCards = () => {
            const grid = document.getElementById('roomCardsGrid');
            if (!grid) {
                console.warn("❌ roomCardsGrid element not found");
                return;
            }

            function renderRoomCard(roomNo) {
                if (!roomNo) {
                    return `
                        <div class="rounded-xl border-2 border-dashed border-gray-200 bg-white/60 min-h-[120px]"></div>
                    `;
                }

                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                if (!roomData) {
                    return `
                        <div class="rounded-xl border-2 border-dashed border-gray-200 bg-white/60 min-h-[120px]"></div>
                    `;
                }

                const tenantData = findTenantForRoom(roomData);
                const isOccupied = isOccupiedRecord(tenantData);
                const tenantName = tenantData?.tenant || 'No Tenant';
                const borderColor = isOccupied ? 'border-blue-600' : 'border-gray-300';
                const bgColor = isOccupied ? 'bg-gradient-to-br from-blue-50 to-white' : 'bg-gray-50';
                const statusColor = isOccupied ? 'bg-blue-100 text-blue-800 border-blue-200' : 'bg-gray-200 text-gray-700 border-gray-300';

                return `
                    <div class="${bgColor} rounded-xl shadow-lg border-l-8 ${borderColor} p-5 cursor-pointer hover:shadow-2xl transition" onclick="window.openRoomDetailModal('${roomNo}')">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="text-xl font-bold text-gray-800 leading-tight">Room ${roomData.roomNo}</h4>
                                <p class="text-xs text-gray-500 mt-1">ID: <span class="font-mono font-semibold text-blue-700">${roomData.roomId}</span></p>
                            </div>
                            <span class="px-2.5 py-1 rounded-lg text-[11px] font-bold ${statusColor} border">
                                ${isOccupied ? '✓ Occupied' : '◯ Vacant'}
                            </span>
                        </div>

                        <div class="border-t border-gray-200 pt-3">
                            <p class="text-sm text-gray-700 font-semibold truncate" title="${tenantName}">
                                <i class="fa-solid fa-user mr-2 text-blue-600"></i>${tenantName}
                            </p>
                        </div>
                    </div>
                `;
            }

            // Pictorial building layout by floor (left/middle/right positions)
            const floors = [
                { label: 'Ground Floor', rooms: ['01', '02', null] },
                { label: '1st Floor', rooms: [null, '04', null] },
                { label: '2nd Floor', rooms: ['05', '06', '07'] },
                { label: '3rd Floor', rooms: ['08', '09', '10'] },
                { label: '4th Floor', rooms: ['11', '12', '13'] },
            ];

            grid.innerHTML = `
                <div class="bg-white/70 rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5">
                    <div class="space-y-4">
                        ${floors.map(floor => {
                            return `
                                <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                                    <div class="sm:w-28 text-sm font-bold text-gray-600">${escapeHtml(floor.label)}</div>
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 flex-1">
                                        ${floor.rooms.map(r => renderRoomCard(r)).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        // OPEN ROOM DETAIL MODAL (Large Hovering Card)
        window.openRoomDetailModal = (roomNo) => {
            const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
            if (!roomData) return;
            
            const tenantData = findTenantForRoom(roomData);
            const isOccupied = isOccupiedRecord(tenantData);
            const tenantName = tenantData?.tenant || 'No Tenant';
            const contact = tenantData?.contact || 'N/A';
            const rent = tenantData?.rent || 'N/A';
            const deposit = tenantData?.deposit || 'N/A';
            const noAnnualRevision = Boolean(tenantData?.noAnnualRevision);
            const evictionDate = parseDateValue(tenantData?.evictionDate);
            const evictionNoticeDate = parseDateValue(tenantData?.evictionNoticeDate);
            const evictionConfirmed = Boolean(tenantData?.evictionConfirmed);
            const showEvictionControls = Boolean(isOccupied && evictionConfirmed);
            const archivedTenant = tenantData?.archivedTenant || null;
            const restoreCandidate = findRestoreCandidateForRoomId(roomData.roomId);
            const canRestoreArchivedTenant = !isOccupied && !!restoreCandidate;
            const unRevisedRent = tenantData?.unRevisedRent;
            const hasUnRevisedRent = unRevisedRent !== null && unRevisedRent !== undefined && String(unRevisedRent).trim() !== '';
            const unRevisedRentNum = hasUnRevisedRent ? Number(unRevisedRent) : NaN;
            const unRevisedRentLabel = hasUnRevisedRent
                ? (Number.isFinite(unRevisedRentNum) ? `₹${unRevisedRentNum.toLocaleString('en-IN')}` : String(unRevisedRent))
                : 'N/A';
            const revisionInfo = isOccupied ? getRentRevisionDates(tenantData) : null;
            const relocateDate = revisionInfo?.relocateDate || parseDateValue(tenantData?.relocate);
            const lastRevisionDate = revisionInfo?.lastRevisionDate || parseDateValue(tenantData?.lastRentRevisionAt);
            const nextDue = revisionInfo?.nextDue || null;
            const daysTo = revisionInfo?.daysTo;
            const revisionStatus = !isOccupied
                ? 'N/A'
                : (noAnnualRevision
                    ? 'No annual revision'
                    : (daysTo !== null && daysTo !== undefined
                        ? (daysTo < 0
                            ? `Overdue by ${Math.abs(daysTo)} day${Math.abs(daysTo) === 1 ? '' : 's'}`
                            : (daysTo === 0
                                ? 'Due today'
                                : `Due in ${daysTo} day${daysTo === 1 ? '' : 's'}`))
                        : 'N/A'));
            
            const borderColor = isOccupied ? 'border-blue-600' : 'border-gray-300';
            const bgColor = isOccupied ? 'bg-gradient-to-br from-blue-50 to-white' : 'bg-gray-50';
            const statusColor = isOccupied ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';
            
            const settlementPreview = computeEvictionSettlementPreview(tenantData, evictionNoticeDate, evictionDate);

            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" id="roomDetailBackdrop" onclick="if(event.target.id === 'roomDetailBackdrop') window.closeRoomDetailModal()">
                    <div class="bg-white rounded-2xl shadow-2xl border-l-8 ${borderColor} max-w-2xl w-full max-h-screen overflow-y-auto transform transition-all">
                        <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                            <div>
                                <h2 class="text-4xl font-bold text-gray-800">Room ${roomData.roomNo}</h2>
                                <p class="text-gray-600 mt-2">ID: <span class="font-mono font-bold text-blue-600 text-lg">${roomData.roomId}</span></p>
                            </div>
                            <button onclick="window.closeRoomDetailModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold" aria-label="Close">&times;</button>
                        </div>
                        
                        <div class="p-8 space-y-6">
                            <!-- Status Dropdown -->
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-6">
                                <label class="text-sm font-bold text-gray-700 mb-2 block">Room Status</label>
                                <select id="roomStatusDropdown_${roomData.roomId}" class="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg font-semibold text-lg cursor-pointer" onchange="window.updateRoomStatus('${roomData.roomId}', this.value)">
                                    <option value="Occupied" ${isOccupied ? 'selected' : ''}>✓ Occupied - Tenant Present</option>
                                    <option value="Vacant" ${!isOccupied ? 'selected' : ''}>◯ Vacant - No Tenant</option>
                                </select>
                            </div>
                            
                            <!-- Tenant Information Section -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-blue-900 mb-4">👤 Tenant Information</h3>
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Tenant Name</p>
                                        <p class="text-2xl font-bold text-gray-800">${tenantName}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Contact Number</p>
                                        <p class="text-xl font-mono text-gray-800">${contact}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Financial Information Section -->
                            <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-green-900 mb-4">💰 Financial Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Monthly Rent</p>
                                        <p class="text-2xl font-bold text-green-700">₹${typeof rent === 'number' ? rent.toLocaleString() : rent}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Security Deposit</p>
                                        <p class="text-xl font-bold text-green-700">₹${typeof deposit === 'number' ? deposit.toLocaleString() : deposit}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Unrevised Rent (Previous)</p>
                                        <p class="text-xl font-bold text-gray-800">${unRevisedRentLabel}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Room Details Section -->
                            <div class="bg-purple-50 border-l-4 border-purple-500 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-purple-900 mb-4">🏠 Room Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Key No</p>
                                        <p class="text-lg font-bold text-gray-800">${roomData.keyNo}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">EB Service No</p>
                                        <p class="text-lg font-bold text-gray-800">${roomData.ebServNo}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">EB Account No</p>
                                        <p class="text-lg font-bold text-gray-800">${roomData.ebAcNo}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Relocation Date</p>
                                        <p class="text-lg font-bold text-gray-800">${formatDateForDisplay(relocateDate)}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Last Rent Revision</p>
                                        <p class="text-lg font-bold text-gray-800">${formatDateForDisplay(lastRevisionDate)}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Next Revision</p>
                                        <p class="text-lg font-bold ${(!noAnnualRevision && daysTo !== null && daysTo !== undefined && daysTo <= 0) ? 'text-red-700' : 'text-gray-800'}">${noAnnualRevision ? 'Disabled' : (nextDue ? formatDateForDisplay(nextDue) : 'N/A')} <span class="text-xs font-semibold ml-2">(${revisionStatus})</span></p>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="inline-flex items-start gap-3 cursor-pointer">
                                            <input id="evictionConfirmed_${roomData.roomId}" type="checkbox" class="mt-1" ${evictionConfirmed ? 'checked' : ''} ${isOccupied ? '' : 'disabled'} onchange="window.updateEvictionConfirmed('${roomData.roomId}', this.checked)" />
                                            <span>
                                                <span class="text-sm font-semibold text-gray-800">Tenant confirmed eviction</span>
                                                <span class="block text-xs text-gray-500">Enable eviction notice/date and deposit settlement controls.</span>
                                            </span>
                                        </label>
                                    </div>

                                    ${showEvictionControls ? `
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Eviction Date</p>
                                        <p class="text-lg font-bold text-gray-800">${evictionDate ? formatDateForDisplay(evictionDate) : 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Eviction Notice Date</p>
                                        <p class="text-lg font-bold text-gray-800">${evictionNoticeDate ? formatDateForDisplay(evictionNoticeDate) : 'N/A'}</p>
                                    </div>
                                    <div class="col-span-2">
                                        <div class="space-y-3">
                                            <div class="flex flex-wrap gap-3">
                                                <button onclick="window.setEvictionNoticeDate('${roomData.roomId}')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-indigo-600 hover:bg-indigo-700 text-white">
                                                    Set Notice Date
                                                </button>
                                                <button ${evictionNoticeDate ? '' : 'disabled'} onclick="window.clearEvictionNoticeDate('${roomData.roomId}')" class="px-4 py-2 rounded-lg font-semibold text-sm ${evictionNoticeDate ? 'bg-gray-200 hover:bg-gray-300 text-gray-800' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">
                                                    Clear Notice Date
                                                </button>
                                            </div>
                                            <div class="flex flex-wrap gap-3">
                                                <button onclick="window.setEvictionDate('${roomData.roomId}')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-purple-600 hover:bg-purple-700 text-white">
                                                    Set Eviction Date
                                                </button>
                                                <button ${evictionDate ? '' : 'disabled'} onclick="window.clearEvictionDate('${roomData.roomId}')" class="px-4 py-2 rounded-lg font-semibold text-sm ${evictionDate ? 'bg-gray-200 hover:bg-gray-300 text-gray-800' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">
                                                    Clear Eviction Date
                                                </button>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2"><span class="font-semibold">Step 1:</span> Set Notice Date → <span class="font-semibold">Step 2:</span> Set Eviction Date. When the eviction date is reached, the room auto-moves to Vacant (with archive).</p>
                                    </div>
                                    ` : ''}
                                    <div class="col-span-2">
                                        <label class="inline-flex items-start gap-3 cursor-pointer">
                                            <input id="noAnnualRevision_${roomData.roomId}" type="checkbox" class="mt-1" ${noAnnualRevision ? 'checked' : ''} ${isOccupied ? '' : 'disabled'} onchange="window.updateNoAnnualRevision('${roomData.roomId}', this.checked)" />
                                            <span>
                                                <span class="text-sm font-semibold text-gray-800">No annual revision</span>
                                                <span class="block text-xs text-gray-500">Tick to exclude this tenant from the Rent Revision Due Soon list.</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            ${showEvictionControls ? `
                            <!-- Eviction Settlement Section -->
                            <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-red-900 mb-2">🚪 Eviction Settlement (From Deposit)</h3>
                                <p class="text-xs text-gray-600 mb-4">From the notice date till vacating, rent + water + ₹${RENT_WATER_SERVICE_CHARGE} (full months) will be deducted from the security deposit, plus mandatory 1 month rent (rent only).</p>

                                ${settlementPreview.html}

                                <div class="mt-4 flex flex-wrap gap-3">
                                    <button onclick="window.finalizeEvictionSettlementAndVacate('${roomData.roomId}')" class="px-4 py-2 rounded-lg font-semibold text-sm bg-red-600 hover:bg-red-700 text-white">
                                        Finalize Settlement & Mark Vacant
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Action Buttons -->
                            <div class="flex gap-3 pt-4 border-t">
                                <button onclick="window.openAddTenantModal('${roomData.roomId}'); window.closeRoomDetailModal();" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition text-base">
                                    ${isOccupied ? '✎ Edit Tenant' : '+ Add Tenant'}
                                </button>
                                ${(isOccupied && !noAnnualRevision) ? `
                                <button onclick="window.markRentRevised('${roomData.roomId}')" class="flex-1 bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition text-base">
                                    Mark Rent Revised
                                </button>
                                ` : ''}
                                ${canRestoreArchivedTenant ? `
                                <button onclick="window.restoreArchivedTenant('${roomData.roomId}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition text-base">
                                    Restore Tenant (Testing)
                                </button>
                                ` : ''}
                                ${isOccupied ? `
                                <button onclick="window.markTenantVacated('${roomData.roomId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition text-base">
                                    Mark Vacant
                                </button>
                                ` : ''}
                                <button onclick="window.closeRoomDetailModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition text-base">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Inject modal into page
            let modal = document.getElementById('roomDetailModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'roomDetailModal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            console.log(`✓ Opened room detail modal for Room ${roomNo}`);
        };

        // CLOSE ROOM DETAIL MODAL
        window.closeRoomDetailModal = () => {
            const modal = document.getElementById('roomDetailModal');
            if (modal) {
                modal.innerHTML = '';
            }
            console.log("✓ Closed room detail modal");
        };

        // UPDATE ROOM STATUS (Occupied/Vacant)
        window.updateRoomStatus = async (roomId, newStatus) => {
            try {
                // Find the best matching tenant record for this roomId.
                // (There may be multiple docs for a room; pick occupied/newest.)
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));
                if (!tenantRecord) {
                    showNotification("Cannot update status: Tenant record not found", "error");
                    return;
                }

                // If changing to OCCUPIED, validate that tenant details exist
                if (newStatus === 'Occupied') {
                    if (!tenantRecord.tenant || !tenantRecord.contact || !tenantRecord.rent) {
                        showNotification("⚠️ Tenant details required! Please add tenant name, contact, and rent before marking as Occupied", "warning");
                        return;
                    }
                }

                // Get the room number from immutable data for reopening modal
                const roomNo = immutableRoomNo;

                // Prepare update payload
                const updatePayload = { status: newStatus };

                // If changing to VACANT, archive (clear) all tenant details
                if (newStatus === 'Vacant') {
                    const shouldArchive = isOccupiedRecord(tenantRecord) ||
                        String(tenantRecord?.tenant || '').trim() ||
                        String(tenantRecord?.contact || '').trim() ||
                        (tenantRecord?.rent !== null && tenantRecord?.rent !== undefined);

                    if (shouldArchive) {
                        updatePayload.archivedTenant = {
                            archivedAt: serverTimestamp(),
                            reason: 'status-to-vacant',
                            tenant: tenantRecord?.tenant ?? null,
                            contact: tenantRecord?.contact ?? null,
                            rent: tenantRecord?.rent ?? null,
                            waterRate: tenantRecord?.waterRate ?? null,
                            deposit: tenantRecord?.deposit ?? null,
                            ebServNo: tenantRecord?.ebServNo ?? null,
                            ebAcNo: tenantRecord?.ebAcNo ?? null,
                            keyNo: tenantRecord?.keyNo ?? null,
                            relocate: tenantRecord?.relocate ?? null,
                            lastRentRevisionAt: tenantRecord?.lastRentRevisionAt ?? null,
                            noAnnualRevision: Boolean(tenantRecord?.noAnnualRevision),
                            evictionDate: tenantRecord?.evictionDate ?? null,
                            evictionNoticeDate: tenantRecord?.evictionNoticeDate ?? null,
                            evictionSettlement: tenantRecord?.evictionSettlement ?? null,
                            paymentHistory: tenantRecord?.paymentHistory ?? {},
                            paymentTotals: tenantRecord?.paymentTotals ?? {},
                            waterReadings: tenantRecord?.waterReadings ?? {},
                            unRevisedRent: tenantRecord?.unRevisedRent ?? null,
                            unRevisedRentCapturedAt: tenantRecord?.unRevisedRentCapturedAt ?? null,
                        };
                    }

                    updatePayload.tenant = null;
                    updatePayload.contact = null;
                    updatePayload.rent = null;
                    updatePayload.waterRate = null;
                    updatePayload.deposit = null;
                    updatePayload.ebServNo = null;
                    updatePayload.ebAcNo = null;
                    updatePayload.keyNo = null;
                    updatePayload.relocate = null;
                    updatePayload.lastRentRevisionAt = null;
                    updatePayload.noAnnualRevision = false;
                    updatePayload.evictionDate = null;
                    updatePayload.evictionNoticeDate = null;
                    updatePayload.evictionSettlement = null;
                    updatePayload.payStatus = null;
                    updatePayload.paymentHistory = {};
                    updatePayload.paymentTotals = {};
                    updatePayload.waterReadings = {};
                }

                // Update the Firestore document
                const tenantDocRef = doc(db, "properties", tenantRecord.id);
                await updateDoc(tenantDocRef, updatePayload);

                console.log(`✓ Updated Room ${roomId} status to ${newStatus}`);
                showNotification(`✓ Status updated to ${newStatus}${newStatus === 'Vacant' ? ' - Tenant details archived' : ''}`, "success");

                // Wait for Firestore to sync
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Refresh the modal immediately to show updated data
                if (roomNo) {
                    window.closeRoomDetailModal();
                    setTimeout(() => {
                        window.openRoomDetailModal(roomNo);
                    }, 100);
                }

                // Refresh all views
                window.generateRoomCards();
                window.renderRentDetailsTable();
                try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
                window.renderWaterBillTable();
            } catch (error) {
                console.error("Error updating room status:", error);
                showNotification("Error: " + error.message, "error");
            }
        };

        // OPTION 1: MANUAL MOVE-OUT (archive + mark vacant)
        window.markTenantVacated = async (roomId) => {
            if (!currentUser) {
                showNotification("Please login first", "warning");
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const roomData = immutableRoomNo ? IMMUTABLE_ROOMS_DATA[immutableRoomNo] : null;
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(roomData)
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord || !isOccupiedRecord(tenantRecord)) {
                    showNotification('Cannot mark vacant: room is already vacant or tenant not found.', 'warning');
                    return;
                }

                const tenantName = String(tenantRecord?.tenant || '').trim() || 'Tenant';
                const ok = await window.uiConfirm({
                    title: 'Mark room as vacant?',
                    message: `This will archive ${tenantName}'s details and set the room to Vacant.`,
                    confirmText: 'Mark Vacant',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!ok) return;

                const vacateDateStr = await window.uiPrompt({
                    title: 'Vacate date',
                    subtitle: `Room ${roomId}`,
                    label: 'Select the vacate date',
                    value: formatDateForInput(new Date()),
                    inputType: 'date',
                    okText: 'Next',
                    cancelText: 'Cancel'
                });
                if (vacateDateStr === null) return;
                const vacateDateParsed = parseDateValue(String(vacateDateStr).trim());
                if (!vacateDateParsed) {
                    showNotification('Invalid vacate date. Please choose a valid date.', 'warning');
                    return;
                }

                const vacateNotes = await window.uiPrompt({
                    title: 'Vacate notes (optional)',
                    subtitle: `Room ${roomId}`,
                    label: 'Add a short note (optional)',
                    placeholder: 'e.g. Left keys with caretaker',
                    value: '',
                    inputType: 'text',
                    okText: 'Save',
                    cancelText: 'Skip'
                });

                const archivedTenant = {
                    archivedAt: serverTimestamp(),
                    reason: 'manual-vacate',
                    vacateDate: formatDateForInput(vacateDateParsed),
                    vacateNotes: vacateNotes === null ? '' : String(vacateNotes).trim(),
                    tenant: tenantRecord?.tenant ?? null,
                    contact: tenantRecord?.contact ?? null,
                    rent: tenantRecord?.rent ?? null,
                    waterRate: tenantRecord?.waterRate ?? null,
                    deposit: tenantRecord?.deposit ?? null,
                    ebServNo: tenantRecord?.ebServNo ?? null,
                    ebAcNo: tenantRecord?.ebAcNo ?? null,
                    keyNo: tenantRecord?.keyNo ?? null,
                    relocate: tenantRecord?.relocate ?? null,
                    lastRentRevisionAt: tenantRecord?.lastRentRevisionAt ?? null,
                    noAnnualRevision: Boolean(tenantRecord?.noAnnualRevision),
                    evictionDate: tenantRecord?.evictionDate ?? null,
                    evictionNoticeDate: tenantRecord?.evictionNoticeDate ?? null,
                    evictionSettlement: tenantRecord?.evictionSettlement ?? null,
                    paymentHistory: tenantRecord?.paymentHistory ?? {},
                    paymentTotals: tenantRecord?.paymentTotals ?? {},
                    waterReadings: tenantRecord?.waterReadings ?? {},
                    unRevisedRent: tenantRecord?.unRevisedRent ?? null,
                    unRevisedRentCapturedAt: tenantRecord?.unRevisedRentCapturedAt ?? null,
                };

                const updatePayload = {
                    status: 'Vacant',
                    archivedTenant,
                    tenant: null,
                    contact: null,
                    rent: null,
                    waterRate: null,
                    deposit: null,
                    ebServNo: null,
                    ebAcNo: null,
                    keyNo: null,
                    relocate: null,
                    lastRentRevisionAt: null,
                    noAnnualRevision: false,
                    evictionDate: null,
                    evictionNoticeDate: null,
                    evictionSettlement: null,
                    payStatus: null,
                    paymentHistory: {},
                    paymentTotals: {},
                    waterReadings: {},
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                };

                await updateDoc(doc(db, 'properties', tenantRecord.id), updatePayload);

                showNotification(`✓ Room ${roomId} marked as Vacant`, 'success');

                // Refresh modal + views
                if (immutableRoomNo) {
                    window.closeRoomDetailModal();
                    setTimeout(() => window.openRoomDetailModal(immutableRoomNo), 150);
                }
                window.generateRoomCards();
                window.renderRentDetailsTable();
                try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                window.renderWaterBillTable();
            } catch (error) {
                console.error('markTenantVacated failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        // OPTION 2: MARK RENT REVISED (sets last revision date, optional rent update)
        window.markRentRevised = async (roomId) => {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const roomData = immutableRoomNo ? IMMUTABLE_ROOMS_DATA[immutableRoomNo] : null;
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(roomData)
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord || !isOccupiedRecord(tenantRecord)) {
                    showNotification('Cannot mark revised: room is vacant or tenant not found.', 'warning');
                    return;
                }

                if (Boolean(tenantRecord?.noAnnualRevision)) {
                    showNotification('Annual revision is disabled for this tenant.', 'warning');
                    return;
                }

                const tenantName = String(tenantRecord?.tenant || '').trim() || 'Tenant';
                const ok = await window.uiConfirm({
                    title: 'Mark rent as revised?',
                    message: `This will update the last rent revision date for ${tenantName}.`,
                    confirmText: 'Continue',
                    cancelText: 'Cancel',
                    danger: false
                });
                if (!ok) return;

                const revisionDateStr = await window.uiPrompt({
                    title: 'Revision date',
                    subtitle: `Room ${roomId}`,
                    label: 'Select the rent revision date',
                    value: formatDateForInput(new Date()),
                    inputType: 'date',
                    okText: 'Next',
                    cancelText: 'Cancel'
                });
                if (revisionDateStr === null) return;

                const revisionDateParsed = parseDateValue(String(revisionDateStr).trim());
                if (!revisionDateParsed) {
                    showNotification('Invalid revision date. Please choose a valid date.', 'warning');
                    return;
                }

                const currentRentValue = tenantRecord?.rent;
                const currentRentLabel = (currentRentValue === null || currentRentValue === undefined || String(currentRentValue).trim() === '')
                    ? ''
                    : String(currentRentValue);

                const newRentStr = await window.uiPrompt({
                    title: 'New monthly rent (optional)',
                    subtitle: `Room ${roomId}`,
                    label: 'Enter the new rent amount (leave blank to keep same)',
                    placeholder: currentRentLabel ? `Current: ${currentRentLabel}` : 'e.g. 12000',
                    value: '',
                    inputType: 'number',
                    okText: 'Save',
                    cancelText: 'Keep Same'
                });

                let shouldUpdateRent = false;
                let newRentNumber = null;
                if (newRentStr !== null) {
                    const trimmed = String(newRentStr).trim();
                    if (trimmed) {
                        const parsed = Number(trimmed);
                        if (!Number.isFinite(parsed) || parsed <= 0) {
                            showNotification('Invalid rent amount. Please enter a valid number.', 'warning');
                            return;
                        }
                        shouldUpdateRent = true;
                        newRentNumber = parsed;
                    }
                }

                const updatePayload = {
                    lastRentRevisionAt: formatDateForInput(revisionDateParsed),
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                };

                if (shouldUpdateRent) {
                    updatePayload.unRevisedRent = tenantRecord?.rent ?? null;
                    updatePayload.unRevisedRentCapturedAt = serverTimestamp();
                    updatePayload.rent = newRentNumber;
                }

                await updateDoc(doc(db, 'properties', tenantRecord.id), updatePayload);

                showNotification(`✓ Rent revision saved for Room ${roomId}`, 'success');

                // Refresh modal + views
                if (immutableRoomNo) {
                    window.closeRoomDetailModal();
                    setTimeout(() => window.openRoomDetailModal(immutableRoomNo), 150);
                }
                window.generateRoomCards();
                window.renderRentDetailsTable();
                try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                window.renderWaterBillTable();
            } catch (error) {
                console.error('markRentRevised failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        // TESTING HELPER: RESTORE TENANT DATA FROM THE LAST ARCHIVE
        window.restoreArchivedTenant = async (roomId) => {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const roomData = immutableRoomNo ? IMMUTABLE_ROOMS_DATA[immutableRoomNo] : null;
                const currentRecord = roomData
                    ? findTenantForRoom(roomData)
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                // Block restore only if the room is actually occupied.
                if (currentRecord && isOccupiedRecord(currentRecord)) {
                    showNotification('Cannot restore: room is currently occupied.', 'warning');
                    return;
                }

                // Source record holds the archived tenant snapshot (may be a different duplicate doc).
                const sourceRecord = findRestoreCandidateForRoomId(roomId);
                const archivedTenant = sourceRecord?.archivedTenant;
                const targetRecord = (currentRecord && currentRecord.id) ? currentRecord : sourceRecord;

                if (!targetRecord?.id) {
                    showNotification('Cannot restore: tenant record not found.', 'warning');
                    return;
                }

                const hasArchived = !!archivedTenant && (
                    String(archivedTenant?.tenant || '').trim() ||
                    String(archivedTenant?.contact || '').trim() ||
                    (archivedTenant?.rent !== null && archivedTenant?.rent !== undefined)
                );
                if (!hasArchived) {
                    showNotification('No archived tenant data found to restore.', 'warning');
                    return;
                }

                const archivedName = String(archivedTenant?.tenant || '').trim() || 'the archived tenant';
                const ok = await window.uiConfirm({
                    title: 'Restore tenant data (testing)?',
                    message: `This will restore ${archivedName}'s details back into Room ${roomId}.`,
                    confirmText: 'Restore',
                    cancelText: 'Cancel',
                    danger: true
                });
                if (!ok) return;

                const restoredArchivedTenant = {
                    ...(archivedTenant || {}),
                    restoredAt: serverTimestamp(),
                    restoredBy: currentUser.uid
                };

                const updatePayload = {
                    status: 'Occupied',
                    archivedTenant: restoredArchivedTenant,
                    tenant: archivedTenant?.tenant ?? null,
                    contact: archivedTenant?.contact ?? null,
                    rent: archivedTenant?.rent ?? null,
                    waterRate: archivedTenant?.waterRate ?? null,
                    deposit: archivedTenant?.deposit ?? null,
                    ebServNo: archivedTenant?.ebServNo ?? null,
                    ebAcNo: archivedTenant?.ebAcNo ?? null,
                    keyNo: archivedTenant?.keyNo ?? null,
                    relocate: archivedTenant?.relocate ?? null,
                    lastRentRevisionAt: archivedTenant?.lastRentRevisionAt ?? null,
                    noAnnualRevision: Boolean(archivedTenant?.noAnnualRevision),
                    evictionDate: archivedTenant?.evictionDate ?? null,
                    evictionNoticeDate: archivedTenant?.evictionNoticeDate ?? null,
                    evictionSettlement: archivedTenant?.evictionSettlement ?? null,
                    payStatus: null,
                    paymentHistory: archivedTenant?.paymentHistory ?? {},
                    paymentTotals: archivedTenant?.paymentTotals ?? {},
                    waterReadings: archivedTenant?.waterReadings ?? {},
                    unRevisedRent: archivedTenant?.unRevisedRent ?? null,
                    unRevisedRentCapturedAt: archivedTenant?.unRevisedRentCapturedAt ?? null,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                };

                await updateDoc(doc(db, 'properties', targetRecord.id), updatePayload);

                showNotification(`✓ Restored tenant data for Room ${roomId}`, 'success');

                if (immutableRoomNo) {
                    window.closeRoomDetailModal();
                    setTimeout(() => window.openRoomDetailModal(immutableRoomNo), 150);
                }
                window.generateRoomCards();
                window.renderRentDetailsTable();
                try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                window.renderWaterBillTable();
            } catch (error) {
                console.error('restoreArchivedTenant failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        // SET / CLEAR: EVICTION DATE (per-tenant)
        function computeEvictionSettlementPreview(tenantRecord, noticeDate, vacateDate) {
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const servicePerMonth = Number(RENT_WATER_SERVICE_CHARGE) || 0;

            const rent = Number(tenantRecord?.rent) || 0;
            const deposit = Number(tenantRecord?.deposit) || 0;
            const roomNo = String(tenantRecord?.roomNo || '').trim();
            const rateRaw = Number(tenantRecord?.waterRate);
            const waterRate = Number.isFinite(rateRaw) ? rateRaw : getDefaultWaterRateForRoom(roomNo);

            const invalid = {
                html: `
                    <div class="text-sm text-gray-700">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Deposit</p>
                                <p class="text-lg font-bold text-gray-800">₹${Math.round(deposit).toLocaleString('en-IN')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Monthly Rent</p>
                                <p class="text-lg font-bold text-gray-800">₹${Math.round(rent).toLocaleString('en-IN')}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">Set both Notice Date and Eviction Date to see the settlement calculation.</p>
                    </div>
                `,
            };

            if (!noticeDate || !vacateDate) return invalid;

            const start = new Date(noticeDate);
            const end = new Date(vacateDate);
            start.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);
            if (end.getTime() < start.getTime()) {
                return {
                    html: `
                        <div class="text-sm text-gray-700">
                            <p class="text-xs text-red-700 font-semibold">Eviction Date must be on/after Notice Date.</p>
                        </div>
                    `,
                };
            }

            const monthKeys = [];
            let y = start.getFullYear();
            let m = start.getMonth();
            const endY = end.getFullYear();
            const endM = end.getMonth();
            while (y < endY || (y === endY && m <= endM)) {
                monthKeys.push({ year: y, monthIndex: m, key: `${y}-${months[m]}` });
                m += 1;
                if (m >= 12) {
                    m = 0;
                    y += 1;
                }
            }

            const rentMonths = monthKeys.length;
            const rentDeduction = rentMonths * rent;
            const mandatoryNoticeRent = rent; // Always exactly 1 month rent

            const serviceDeduction = rentMonths * servicePerMonth;

            let waterDeductionKnown = 0;
            const missingWater = [];

            const perMonthRows = monthKeys.map(({ year, monthIndex, key }) => {
                const w = computeWaterForMonth(tenantRecord, year, monthIndex, waterRate);
                const amt = Number(w?.amount);
                const units = Number(w?.units);
                const hasAmount = Number.isFinite(amt) && Number.isFinite(units) && units >= 0;
                if (hasAmount) {
                    waterDeductionKnown += amt;
                } else {
                    missingWater.push(key);
                }

                const rentLabel = rent ? `₹${Math.round(rent).toLocaleString('en-IN')}` : '₹0';
                const waterLabel = hasAmount ? `₹${Math.round(amt).toLocaleString('en-IN')}` : '—';
                const waterMeta = hasAmount ? `${Math.round(units)} units + ₹${servicePerMonth}` : `Missing readings + ₹${servicePerMonth}`;

                return `
                    <tr class="border-b">
                        <td class="border px-3 py-2 font-semibold bg-white">${escapeHtml(key)}</td>
                        <td class="border px-3 py-2 text-right bg-white">${rentLabel}</td>
                        <td class="border px-3 py-2 text-right bg-white">${waterLabel}</td>
                        <td class="border px-3 py-2 text-xs text-gray-600 bg-white">${escapeHtml(waterMeta)}</td>
                    </tr>
                `;
            }).join('');

            const totalDeductionKnown = rentDeduction + mandatoryNoticeRent + waterDeductionKnown + serviceDeduction;
            const refundKnown = deposit - totalDeductionKnown;

            const refundLabel = `₹${Math.round(Math.abs(refundKnown)).toLocaleString('en-IN')}`;
            const refundText = refundKnown >= 0 ? `Refund to tenant: ${refundLabel}` : `Tenant owes: ${refundLabel}`;
            const refundClass = refundKnown >= 0 ? 'text-green-800' : 'text-red-800';

            const missingNote = missingWater.length
                ? `<p class="text-xs text-orange-700 mt-2">Water readings missing for: ${escapeHtml(missingWater.join(', '))}. Totals shown are partial.</p>`
                : `<p class="text-xs text-gray-500 mt-2">All required water readings are available for the selected months.</p>`;

            return {
                html: `
                    <div class="text-sm text-gray-800">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Months (Notice → Vacate)</p>
                                <p class="text-lg font-bold">${rentMonths}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Mandatory 1 Month Rent</p>
                                <p class="text-lg font-bold">₹${Math.round(mandatoryNoticeRent).toLocaleString('en-IN')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Rent Deduction (${rentMonths} months)</p>
                                <p class="text-lg font-bold">₹${Math.round(rentDeduction).toLocaleString('en-IN')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Water + Service (known)</p>
                                <p class="text-lg font-bold">₹${Math.round(waterDeductionKnown + serviceDeduction).toLocaleString('en-IN')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Security Deposit</p>
                                <p class="text-lg font-bold">₹${Math.round(deposit).toLocaleString('en-IN')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 font-semibold">Result (known)</p>
                                <p class="text-lg font-bold ${refundClass}">${refundText}</p>
                            </div>
                        </div>

                        <div class="mt-4 bg-white rounded-lg border overflow-hidden">
                            <div class="px-4 py-2 bg-red-100 text-red-900 font-bold text-sm">Month-wise deduction</div>
                            <div class="w-full overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="border px-3 py-2 text-left">Month</th>
                                            <th class="border px-3 py-2 text-right">Rent</th>
                                            <th class="border px-3 py-2 text-right">Water</th>
                                            <th class="border px-3 py-2 text-left">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${perMonthRows || '<tr><td colspan="4" class="border px-3 py-3 text-center text-gray-500">No months</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${missingNote}
                    </div>
                `,
                missingWater,
                monthKeys,
                rent,
                deposit,
                waterRate,
                rentDeduction,
                mandatoryNoticeRent,
                waterDeductionKnown,
                totalDeductionKnown,
                refundKnown,
            };
        }

        window.setEvictionDate = async (roomId) => {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord?.id) {
                    showNotification('Cannot update: Tenant record not found', 'error');
                    return;
                }

                if (!isOccupiedRecord(tenantRecord)) {
                    showNotification('Eviction date can be set only for occupied rooms.', 'warning');
                    return;
                }

                if (!Boolean(tenantRecord?.evictionConfirmed)) {
                    showNotification('Please tick "Tenant confirmed eviction" first.', 'warning');
                    return;
                }

                const existingDate = tenantRecord?.evictionDate;
                const dateStr = await window.uiPrompt({
                    title: 'Eviction date',
                    subtitle: `Room ${roomId}`,
                    label: 'Select the eviction date',
                    value: (typeof existingDate === 'string' ? existingDate : (formatDateForInput(existingDate) || '')),
                    inputType: 'date',
                    okText: 'Save',
                    cancelText: 'Cancel'
                });

                if (dateStr === null) return;

                const trimmed = String(dateStr).trim();
                if (!trimmed) {
                    showNotification('Please select an eviction date.', 'warning');
                    return;
                }

                const parsed = parseDateValue(trimmed);
                if (!parsed) {
                    showNotification('Invalid eviction date. Please choose a valid date.', 'warning');
                    return;
                }

                await updateDoc(doc(db, 'properties', tenantRecord.id), {
                    evictionDate: formatDateForInput(parsed),
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                });

                showNotification(`✓ Eviction date saved for Room ${roomId}`, 'success');

                if (immutableRoomNo) {
                    setTimeout(() => {
                        window.closeRoomDetailModal();
                        window.openRoomDetailModal(immutableRoomNo);
                    }, 150);
                }
            } catch (error) {
                console.error('setEvictionDate failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        window.clearEvictionDate = async (roomId) => {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord?.id) {
                    showNotification('Cannot update: Tenant record not found', 'error');
                    return;
                }

                if (!Boolean(tenantRecord?.evictionConfirmed)) {
                    showNotification('Please tick "Tenant confirmed eviction" first.', 'warning');
                    return;
                }

                const ok = await window.uiConfirm({
                    title: 'Clear eviction date?',
                    message: `Room ${roomId} will no longer auto-vacate by eviction date.`,
                    confirmText: 'Clear',
                    cancelText: 'Cancel',
                    danger: false
                });
                if (!ok) return;

                await updateDoc(doc(db, 'properties', tenantRecord.id), {
                    evictionDate: null,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                });

                showNotification(`✓ Eviction date cleared for Room ${roomId}`, 'success');

                if (immutableRoomNo) {
                    setTimeout(() => {
                        window.closeRoomDetailModal();
                        window.openRoomDetailModal(immutableRoomNo);
                    }, 150);
                }
            } catch (error) {
                console.error('clearEvictionDate failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        // SET / CLEAR: EVICTION NOTICE DATE (per-tenant)
        window.setEvictionNoticeDate = async (roomId) => {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord?.id) {
                    showNotification('Cannot update: Tenant record not found', 'error');
                    return;
                }

                if (!isOccupiedRecord(tenantRecord)) {
                    showNotification('Notice date can be set only for occupied rooms.', 'warning');
                    return;
                }

                if (!Boolean(tenantRecord?.evictionConfirmed)) {
                    showNotification('Please tick "Tenant confirmed eviction" first.', 'warning');
                    return;
                }

                const existingDate = tenantRecord?.evictionNoticeDate;
                const dateStr = await window.uiPrompt({
                    title: 'Eviction notice date',
                    subtitle: `Room ${roomId}`,
                    label: 'Select the notice date',
                    value: (typeof existingDate === 'string' ? existingDate : (formatDateForInput(existingDate) || '')),
                    inputType: 'date',
                    okText: 'Save',
                    cancelText: 'Cancel'
                });
                if (dateStr === null) return;

                const trimmed = String(dateStr).trim();
                if (!trimmed) {
                    showNotification('Please select a notice date.', 'warning');
                    return;
                }

                const parsed = parseDateValue(trimmed);
                if (!parsed) {
                    showNotification('Invalid notice date. Please choose a valid date.', 'warning');
                    return;
                }

                await updateDoc(doc(db, 'properties', tenantRecord.id), {
                    evictionNoticeDate: formatDateForInput(parsed),
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                });

                showNotification(`✓ Notice date saved for Room ${roomId}`, 'success');

                if (immutableRoomNo) {
                    setTimeout(() => {
                        window.closeRoomDetailModal();
                        window.openRoomDetailModal(immutableRoomNo);
                    }, 150);
                }
            } catch (error) {
                console.error('setEvictionNoticeDate failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        window.clearEvictionNoticeDate = async (roomId) => {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord?.id) {
                    showNotification('Cannot update: Tenant record not found', 'error');
                    return;
                }

                if (!Boolean(tenantRecord?.evictionConfirmed)) {
                    showNotification('Please tick "Tenant confirmed eviction" first.', 'warning');
                    return;
                }

                const ok = await window.uiConfirm({
                    title: 'Clear notice date?',
                    message: `Room ${roomId} will no longer have a notice date for settlement calculations.`,
                    confirmText: 'Clear',
                    cancelText: 'Cancel',
                    danger: false
                });
                if (!ok) return;

                await updateDoc(doc(db, 'properties', tenantRecord.id), {
                    evictionNoticeDate: null,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                });

                showNotification(`✓ Notice date cleared for Room ${roomId}`, 'success');

                if (immutableRoomNo) {
                    setTimeout(() => {
                        window.closeRoomDetailModal();
                        window.openRoomDetailModal(immutableRoomNo);
                    }, 150);
                }
            } catch (error) {
                console.error('clearEvictionNoticeDate failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        // FINALIZE: Settlement + Mark Vacant (archives settlement snapshot)
        window.finalizeEvictionSettlementAndVacate = async (roomId) => {
            if (!currentUser) {
                showNotification('Please login first', 'warning');
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const roomData = immutableRoomNo ? IMMUTABLE_ROOMS_DATA[immutableRoomNo] : null;
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(roomData)
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord || !isOccupiedRecord(tenantRecord)) {
                    showNotification('Cannot finalize: room is vacant or tenant not found.', 'warning');
                    return;
                }

                if (!Boolean(tenantRecord?.evictionConfirmed)) {
                    showNotification('Please tick "Tenant confirmed eviction" first.', 'warning');
                    return;
                }

                const noticeDate = parseDateValue(tenantRecord?.evictionNoticeDate);
                if (!noticeDate) {
                    showNotification('Please set Eviction Notice Date first.', 'warning');
                    return;
                }

                const defaultVacate = parseDateValue(tenantRecord?.evictionDate) || new Date();
                const vacateDateStr = await window.uiPrompt({
                    title: 'Finalize vacate date',
                    subtitle: `Room ${roomId}`,
                    label: 'Select the actual vacate date',
                    value: formatDateForInput(defaultVacate),
                    inputType: 'date',
                    okText: 'Next',
                    cancelText: 'Cancel'
                });
                if (vacateDateStr === null) return;
                const vacateDate = parseDateValue(String(vacateDateStr).trim());
                if (!vacateDate) {
                    showNotification('Invalid vacate date. Please choose a valid date.', 'warning');
                    return;
                }

                const preview = computeEvictionSettlementPreview(tenantRecord, noticeDate, vacateDate);
                const missing = Array.isArray(preview?.missingWater) ? preview.missingWater : [];
                if (missing.length) {
                    const okMissing = await window.uiConfirm({
                        title: 'Missing water readings',
                        message: `Water readings are missing for: ${missing.join(', ')}.\n\nFinalize with water for these months treated as 0? (₹${RENT_WATER_SERVICE_CHARGE} service will still be applied per month)`,
                        confirmText: 'Finalize anyway',
                        cancelText: 'Cancel',
                        danger: true
                    });
                    if (!okMissing) return;
                }

                const vacateNotes = await window.uiPrompt({
                    title: 'Vacate notes (optional)',
                    subtitle: `Room ${roomId}`,
                    label: 'Add a short note (optional)',
                    placeholder: 'e.g. Deposit settlement done and keys returned',
                    value: '',
                    inputType: 'text',
                    okText: 'Finalize',
                    cancelText: 'Skip'
                });

                // Build final settlement snapshot (treat missing water months as 0 but record them)
                const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                const servicePerMonth = Number(RENT_WATER_SERVICE_CHARGE) || 0;
                const rateRaw = Number(tenantRecord?.waterRate);
                const roomNo = String(tenantRecord?.roomNo || '').trim();
                const waterRate = Number.isFinite(rateRaw) ? rateRaw : getDefaultWaterRateForRoom(roomNo);
                const rent = Number(tenantRecord?.rent) || 0;
                const deposit = Number(tenantRecord?.deposit) || 0;

                const start = new Date(noticeDate);
                const end = new Date(vacateDate);
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);
                if (end.getTime() < start.getTime()) {
                    showNotification('Vacate date must be on/after notice date.', 'warning');
                    return;
                }

                const monthList = [];
                let y = start.getFullYear();
                let m = start.getMonth();
                const endY = end.getFullYear();
                const endM = end.getMonth();
                while (y < endY || (y === endY && m <= endM)) {
                    monthList.push({ year: y, monthIndex: m, key: `${y}-${months[m]}` });
                    m += 1;
                    if (m >= 12) {
                        m = 0;
                        y += 1;
                    }
                }

                const waterByMonth = {};
                const serviceByMonth = {};
                let waterTotal = 0;
                const missingWaterMonths = [];
                for (const it of monthList) {
                    const w = computeWaterForMonth(tenantRecord, it.year, it.monthIndex, waterRate);
                    const amt = Number(w?.amount);
                    const units = Number(w?.units);
                    const hasAmount = Number.isFinite(amt) && Number.isFinite(units) && units >= 0;
                    if (hasAmount) {
                        waterByMonth[it.key] = Math.round(amt);
                        waterTotal += amt;
                    } else {
                        waterByMonth[it.key] = 0;
                        missingWaterMonths.push(it.key);
                    }

                    serviceByMonth[it.key] = servicePerMonth;
                }

                const rentMonths = monthList.length;
                const rentDeduction = rentMonths * rent;
                const mandatoryNoticeRent = rent;
                const serviceDeduction = rentMonths * servicePerMonth;
                const totalDeduction = rentDeduction + mandatoryNoticeRent + waterTotal + serviceDeduction;
                const refund = deposit - totalDeduction;

                const evictionSettlement = {
                    noticeDate: formatDateForInput(noticeDate),
                    vacateDate: formatDateForInput(vacateDate),
                    months: monthList.map(x => x.key),
                    rentPerMonth: rent,
                    waterRate,
                    serviceChargePerMonth: servicePerMonth,
                    serviceChargeTotal: Math.round(serviceDeduction),
                    mandatoryNoticeRent,
                    rentDeduction,
                    waterDeduction: Math.round(waterTotal),
                    totalDeduction: Math.round(totalDeduction),
                    deposit,
                    refund: Math.round(refund),
                    waterByMonth,
                    serviceByMonth,
                    missingWaterMonths,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                };

                const archivedTenant = {
                    archivedAt: serverTimestamp(),
                    reason: 'manual-vacate',
                    vacateDate: formatDateForInput(vacateDate),
                    vacateNotes: vacateNotes === null ? '' : String(vacateNotes).trim(),
                    tenant: tenantRecord?.tenant ?? null,
                    contact: tenantRecord?.contact ?? null,
                    rent: tenantRecord?.rent ?? null,
                    waterRate: tenantRecord?.waterRate ?? null,
                    deposit: tenantRecord?.deposit ?? null,
                    ebServNo: tenantRecord?.ebServNo ?? null,
                    ebAcNo: tenantRecord?.ebAcNo ?? null,
                    keyNo: tenantRecord?.keyNo ?? null,
                    relocate: tenantRecord?.relocate ?? null,
                    lastRentRevisionAt: tenantRecord?.lastRentRevisionAt ?? null,
                    noAnnualRevision: Boolean(tenantRecord?.noAnnualRevision),
                    evictionDate: tenantRecord?.evictionDate ?? null,
                    evictionNoticeDate: tenantRecord?.evictionNoticeDate ?? null,
                    evictionSettlement,
                    paymentHistory: tenantRecord?.paymentHistory ?? {},
                    paymentTotals: tenantRecord?.paymentTotals ?? {},
                    waterReadings: tenantRecord?.waterReadings ?? {},
                    unRevisedRent: tenantRecord?.unRevisedRent ?? null,
                    unRevisedRentCapturedAt: tenantRecord?.unRevisedRentCapturedAt ?? null,
                };

                const updatePayload = {
                    status: 'Vacant',
                    archivedTenant,
                    tenant: null,
                    contact: null,
                    rent: null,
                    waterRate: null,
                    deposit: null,
                    ebServNo: null,
                    ebAcNo: null,
                    keyNo: null,
                    relocate: null,
                    lastRentRevisionAt: null,
                    noAnnualRevision: false,
                    evictionDate: null,
                    evictionNoticeDate: null,
                    evictionSettlement: null,
                    payStatus: null,
                    paymentHistory: {},
                    paymentTotals: {},
                    waterReadings: {},
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                };

                await updateDoc(doc(db, 'properties', tenantRecord.id), updatePayload);

                showNotification(`✓ Settlement finalized and Room ${roomId} marked Vacant`, 'success');

                if (immutableRoomNo) {
                    window.closeRoomDetailModal();
                    setTimeout(() => window.openRoomDetailModal(immutableRoomNo), 150);
                }
                window.generateRoomCards();
                window.renderRentDetailsTable();
                try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                window.renderWaterBillTable();
            } catch (error) {
                console.error('finalizeEvictionSettlementAndVacate failed', error);
                showNotification('Error: ' + (error?.message || 'Unknown error'), 'error');
            }
        };

        let autoEvictionVacateRunning = false;
        async function autoVacateEvictedTenants(today = new Date()) {
            if (autoEvictionVacateRunning) return;
            if (!currentUser) return;

            const normalizedToday = new Date(today);
            normalizedToday.setHours(0, 0, 0, 0);

            autoEvictionVacateRunning = true;
            try {
                const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
                for (const roomNo of roomNos) {
                    const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                    const tenantRecord = findTenantForRoom(roomData);
                    if (!tenantRecord || !isOccupiedRecord(tenantRecord)) continue;

                    const evictDate = parseDateValue(tenantRecord?.evictionDate);
                    if (!evictDate) continue;

                    const evictDay = new Date(evictDate);
                    evictDay.setHours(0, 0, 0, 0);
                    if (evictDay.getTime() > normalizedToday.getTime()) continue;

                    // Best-effort: build a settlement snapshot for emailing, if notice date exists.
                    let autoEvictionSettlement = null;
                    try {
                        const noticeDate = parseDateValue(tenantRecord?.evictionNoticeDate);
                        if (noticeDate) {
                            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                            const servicePerMonth = Number(RENT_WATER_SERVICE_CHARGE) || 0;
                            const rateRaw = Number(tenantRecord?.waterRate);
                            const roomNo2 = String(tenantRecord?.roomNo || '').trim();
                            const waterRate2 = Number.isFinite(rateRaw) ? rateRaw : getDefaultWaterRateForRoom(roomNo2);
                            const rent2 = Number(tenantRecord?.rent) || 0;
                            const deposit2 = Number(tenantRecord?.deposit) || 0;

                            const start = new Date(noticeDate);
                            const end = new Date(evictDay);
                            start.setHours(0, 0, 0, 0);
                            end.setHours(0, 0, 0, 0);
                            if (end.getTime() >= start.getTime()) {
                                const monthList = [];
                                let y = start.getFullYear();
                                let m = start.getMonth();
                                const endY = end.getFullYear();
                                const endM = end.getMonth();
                                while (y < endY || (y === endY && m <= endM)) {
                                    monthList.push({ year: y, monthIndex: m, key: `${y}-${months[m]}` });
                                    m += 1;
                                    if (m >= 12) { m = 0; y += 1; }
                                }

                                const waterByMonth = {};
                                const serviceByMonth = {};
                                let waterTotal = 0;
                                const missingWaterMonths = [];
                                for (const it of monthList) {
                                    const w = computeWaterForMonth(tenantRecord, it.year, it.monthIndex, waterRate2);
                                    const amt = Number(w?.amount);
                                    const units = Number(w?.units);
                                    const hasAmount = Number.isFinite(amt) && Number.isFinite(units) && units >= 0;
                                    if (hasAmount) {
                                        waterByMonth[it.key] = Math.round(amt);
                                        waterTotal += amt;
                                    } else {
                                        waterByMonth[it.key] = 0;
                                        missingWaterMonths.push(it.key);
                                    }
                                    serviceByMonth[it.key] = servicePerMonth;
                                }

                                const rentMonths = monthList.length;
                                const rentDeduction = rentMonths * rent2;
                                const mandatoryNoticeRent = rent2;
                                const serviceDeduction = rentMonths * servicePerMonth;
                                const totalDeduction = rentDeduction + mandatoryNoticeRent + waterTotal + serviceDeduction;
                                const refund = deposit2 - totalDeduction;

                                autoEvictionSettlement = {
                                    noticeDate: formatDateForInput(noticeDate),
                                    vacateDate: formatDateForInput(evictDay),
                                    months: monthList.map(x => x.key),
                                    rentPerMonth: rent2,
                                    waterRate: waterRate2,
                                    serviceChargePerMonth: servicePerMonth,
                                    serviceChargeTotal: Math.round(serviceDeduction),
                                    mandatoryNoticeRent,
                                    rentDeduction,
                                    waterDeduction: Math.round(waterTotal),
                                    totalDeduction: Math.round(totalDeduction),
                                    deposit: Math.round(deposit2),
                                    refund: Math.round(refund),
                                    waterByMonth,
                                    serviceByMonth,
                                    missingWaterMonths,
                                    autoGenerated: true,
                                    finalized: false,
                                    createdAt: serverTimestamp(),
                                    createdBy: currentUser.uid
                                };
                            }
                        }
                    } catch (e) {
                        console.warn('⚠️ Auto settlement snapshot failed:', e);
                    }

                    // Archive old tenant details into a snapshot before clearing
                    const archivedTenant = {
                        archivedAt: serverTimestamp(),
                        reason: 'eviction',
                        vacateDate: formatDateForInput(evictDay),
                        vacateNotes: 'Auto-vacated (eviction date reached)',
                        tenant: tenantRecord?.tenant ?? null,
                        contact: tenantRecord?.contact ?? null,
                        rent: tenantRecord?.rent ?? null,
                        waterRate: tenantRecord?.waterRate ?? null,
                        deposit: tenantRecord?.deposit ?? null,
                        ebServNo: tenantRecord?.ebServNo ?? null,
                        ebAcNo: tenantRecord?.ebAcNo ?? null,
                        keyNo: tenantRecord?.keyNo ?? null,
                        relocate: tenantRecord?.relocate ?? null,
                        lastRentRevisionAt: tenantRecord?.lastRentRevisionAt ?? null,
                        noAnnualRevision: Boolean(tenantRecord?.noAnnualRevision),
                        evictionDate: tenantRecord?.evictionDate ?? null,
                        evictionNoticeDate: tenantRecord?.evictionNoticeDate ?? null,
                        evictionSettlement: autoEvictionSettlement ?? (tenantRecord?.evictionSettlement ?? null),
                        paymentHistory: tenantRecord?.paymentHistory ?? {},
                        paymentTotals: tenantRecord?.paymentTotals ?? {},
                        waterReadings: tenantRecord?.waterReadings ?? {},
                        unRevisedRent: tenantRecord?.unRevisedRent ?? null,
                        unRevisedRentCapturedAt: tenantRecord?.unRevisedRentCapturedAt ?? null,
                    };

                    const updatePayload = {
                        status: 'Vacant',
                        archivedTenant,
                        tenant: null,
                        contact: null,
                        rent: null,
                        waterRate: null,
                        deposit: null,
                        ebServNo: null,
                        ebAcNo: null,
                        keyNo: null,
                        relocate: null,
                        lastRentRevisionAt: null,
                        noAnnualRevision: false,
                        evictionDate: null,
                        evictionNoticeDate: null,
                        evictionSettlement: null,
                        payStatus: null,
                        paymentHistory: {},
                        paymentTotals: {},
                        waterReadings: {},
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUser.uid
                    };

                    try {
                        await updateDoc(doc(db, 'properties', tenantRecord.id), updatePayload);
                        console.log(`✓ Auto-vacated Room ${roomData.roomId} (eviction date reached)`);
                    } catch (e) {
                        console.warn('⚠️ Auto-vacate failed for', roomData.roomId, e?.message || e);
                    }
                }
            } finally {
                autoEvictionVacateRunning = false;
            }
        }

        // TOGGLE: NO ANNUAL REVISION (per-tenant)
        window.updateNoAnnualRevision = async (roomId, checked) => {
            if (!currentUser) {
                showNotification("Please login first", "warning");
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord?.id) {
                    showNotification("Cannot update: Tenant record not found", "error");
                    return;
                }

                await updateDoc(doc(db, "properties", tenantRecord.id), {
                    noAnnualRevision: Boolean(checked),
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                });

                showNotification(`✓ Annual revision ${checked ? 'disabled' : 'enabled'} for Room ${roomId}`, "success");

                // Refresh dependent UI
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                // Keep the modal text in sync quickly
                if (immutableRoomNo) {
                    setTimeout(() => {
                        window.closeRoomDetailModal();
                        window.openRoomDetailModal(immutableRoomNo);
                    }, 150);
                }
            } catch (error) {
                console.error("Error updating noAnnualRevision:", error);
                showNotification("Error: " + error.message, "error");

                // Best-effort: revert checkbox visual state
                const el = document.getElementById(`noAnnualRevision_${roomId}`);
                if (el) el.checked = !Boolean(checked);
            }
        };

        // TOGGLE: TENANT CONFIRMED EVICTION (gates notice/eviction controls)
        window.updateEvictionConfirmed = async (roomId, checked) => {
            if (!currentUser) {
                showNotification("Please login first", "warning");
                return;
            }

            try {
                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord?.id) {
                    showNotification("Cannot update: Tenant record not found", "error");
                    return;
                }

                if (!isOccupiedRecord(tenantRecord)) {
                    showNotification('Eviction confirmation can be set only for occupied rooms.', 'warning');
                    return;
                }

                const payload = {
                    evictionConfirmed: Boolean(checked),
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                };

                if (!checked) {
                    const ok = await window.uiConfirm({
                        title: 'Turn off eviction confirmation?',
                        message: 'This will disable eviction/notice controls. Do you also want to clear Notice Date and Eviction Date?',
                        confirmText: 'Yes, clear dates',
                        cancelText: 'Keep dates',
                        danger: false
                    });
                    if (ok) {
                        payload.evictionDate = null;
                        payload.evictionNoticeDate = null;
                        payload.evictionSettlement = null;
                    }
                }

                await updateDoc(doc(db, "properties", tenantRecord.id), payload);
                showNotification(`✓ Eviction confirmation ${checked ? 'enabled' : 'disabled'} for Room ${roomId}`, "success");

                if (immutableRoomNo) {
                    setTimeout(() => {
                        window.closeRoomDetailModal();
                        window.openRoomDetailModal(immutableRoomNo);
                    }, 150);
                }
            } catch (error) {
                console.error('updateEvictionConfirmed failed', error);
                showNotification("Error: " + error.message, "error");

                const el = document.getElementById(`evictionConfirmed_${roomId}`);
                if (el) el.checked = !Boolean(checked);
            }
        };

        // NOTIFICATION HELPER - Show in-card messages instead of popups
        window.showNotification = (message, type = "info") => {
            // Remove existing notification if any
            const existingNotif = document.getElementById('notificationContainer');
            if (existingNotif) existingNotif.remove();

            const notifContainer = document.createElement('div');
            notifContainer.id = 'notificationContainer';
            
            let bgColor, textColor, icon;
            if (type === 'success') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                icon = '✓';
            } else if (type === 'error') {
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                icon = '✗';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-100';
                textColor = 'text-yellow-800';
                icon = '⚠️';
            } else {
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-800';
                icon = 'ℹ️';
            }

            notifContainer.innerHTML = `
                <div class="fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg border-l-4 ${bgColor.replace('bg-', 'border-')} max-w-md z-50 animate-pulse">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${icon}</span>
                        <span class="font-medium">${message}</span>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notifContainer);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                notifContainer.remove();
            }, 4000);
        };

        // HOVER-CARD MODALS (avoid browser prompt/confirm)
        window.showHoverInputModal = ({
            title = 'Input required',
            subtitle = '',
            label = 'Value',
            placeholder = '',
            value = '',
            infoRows = [],
            inputType = 'text',
            inputMode = undefined,
            okText = 'Save',
            cancelText = 'Cancel',
            extraButtonText = '',
            extraButtonClass = 'bg-green-600 hover:bg-green-700 text-white font-semibold',
            onExtra = null,
        } = {}) => {
            return new Promise((resolve) => {
                const existing = document.getElementById('hoverInputModal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'hoverInputModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

                const safeTitle = escapeHtml(String(title ?? ''));
                const safeSubtitle = escapeHtml(String(subtitle ?? ''));
                const safeLabel = escapeHtml(String(label ?? ''));
                const safePlaceholder = escapeHtml(String(placeholder ?? ''));
                const safeValue = escapeHtml(String(value ?? ''));
                const safeOkText = escapeHtml(String(okText ?? 'OK'));
                const safeCancelText = escapeHtml(String(cancelText ?? 'Cancel'));
                const safeExtraText = escapeHtml(String(extraButtonText ?? ''));

                const normalizedInfoRows = Array.isArray(infoRows) ? infoRows : [];
                const infoRowsHtml = normalizedInfoRows
                    .filter(r => r && (r.label !== undefined || r.value !== undefined))
                    .map(r => {
                        const l = escapeHtml(String(r?.label ?? ''));
                        const v = escapeHtml(String(r?.value ?? ''));
                        if (!l && !v) return '';
                        return `
                            <div class="mb-3">
                                ${l ? `<div class=\"block text-xs font-semibold text-gray-600 mb-1\">${l}</div>` : ''}
                                <input class="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-700" value="${v}" readonly disabled />
                            </div>
                        `;
                    })
                    .filter(Boolean)
                    .join('');

                const inputModeAttr = inputMode ? ` inputmode="${escapeHtml(String(inputMode))}"` : '';

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md border-l-8 border-blue-600" role="dialog" aria-modal="true" aria-labelledby="hoverInputTitle">
                        <div class="p-6 border-b">
                            <h3 id="hoverInputTitle" class="text-xl font-bold text-gray-800">${safeTitle}</h3>
                            ${safeSubtitle ? `<p class=\"text-sm text-gray-500 mt-1\">${safeSubtitle}</p>` : ''}
                        </div>
                        <div class="p-6">
                            ${infoRowsHtml ? `<div class=\"mb-4\">${infoRowsHtml}</div>` : ''}
                            <label for="hoverInputField" class="block text-sm font-semibold text-gray-700 mb-2">${safeLabel}</label>
                            <input id="hoverInputField" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" type="${escapeHtml(String(inputType))}"${inputModeAttr} placeholder="${safePlaceholder}" value="${safeValue}" />
                        </div>
                        <div class="p-6 pt-0 flex justify-end gap-3">
                            <button type="button" id="hoverInputCancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">${safeCancelText}</button>
                            ${safeExtraText ? `<button type="button" id="hoverInputExtra" class="px-4 py-2 rounded-lg ${escapeHtml(String(extraButtonClass || ''))}">${safeExtraText}</button>` : ''}
                            <button type="button" id="hoverInputOk" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">${safeOkText}</button>
                        </div>
                    </div>
                `;

                const cleanup = () => {
                    document.removeEventListener('keydown', onKeyDown);
                    modal.remove();
                };

                const onKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        resolve(null);
                    }
                };

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        cleanup();
                        resolve(null);
                    }
                });

                document.body.appendChild(modal);
                document.addEventListener('keydown', onKeyDown);

                const inputEl = modal.querySelector('#hoverInputField');
                const okBtn = modal.querySelector('#hoverInputOk');
                const cancelBtn = modal.querySelector('#hoverInputCancel');
                const extraBtn = modal.querySelector('#hoverInputExtra');

                if (inputEl) {
                    setTimeout(() => {
                        inputEl.focus();
                        if (typeof inputEl.select === 'function') inputEl.select();
                    }, 0);
                    inputEl.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            okBtn?.click();
                        }
                    });
                }

                cancelBtn?.addEventListener('click', () => {
                    cleanup();
                    resolve(null);
                });

                extraBtn?.addEventListener('click', async () => {
                    if (typeof onExtra !== 'function') return;
                    try {
                        const v = inputEl ? String(inputEl.value ?? '') : '';
                        await onExtra(v, { close: () => { cleanup(); resolve(null); } });
                    } catch (e) {
                        console.error('hoverInputModal extra action failed', e);
                    }
                });

                okBtn?.addEventListener('click', () => {
                    const v = inputEl ? String(inputEl.value ?? '') : '';
                    cleanup();
                    resolve(v);
                });
            });
        };

        window.showHoverConfirmModal = ({
            title = 'Confirm',
            message = '',
            confirmText = 'OK',
            cancelText = 'Cancel',
            danger = false,
            hideCancel = false,
            dismissValue = false,
        } = {}) => {
            return new Promise((resolve) => {
                const existing = document.getElementById('hoverConfirmModal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'hoverConfirmModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

                const safeTitle = escapeHtml(String(title ?? ''));
                const safeMessage = escapeHtml(String(message ?? ''));
                const safeConfirmText = escapeHtml(String(confirmText ?? 'OK'));
                const safeCancelText = escapeHtml(String(cancelText ?? 'Cancel'));
                const borderClass = danger ? 'border-red-600' : 'border-blue-600';
                const confirmClass = danger ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md border-l-8 ${borderClass}" role="dialog" aria-modal="true" aria-labelledby="hoverConfirmTitle">
                        <div class="p-6 border-b">
                            <h3 id="hoverConfirmTitle" class="text-xl font-bold text-gray-800">${safeTitle}</h3>
                        </div>
                        <div class="p-6">
                            <p class="text-sm text-gray-600">${safeMessage}</p>
                        </div>
                        <div class="p-6 pt-0 flex justify-end gap-3">
                            ${hideCancel ? '' : `<button type="button" id="hoverConfirmCancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">${safeCancelText}</button>`}
                            <button type="button" id="hoverConfirmOk" class="px-4 py-2 rounded-lg ${confirmClass} text-white font-semibold">${safeConfirmText}</button>
                        </div>
                    </div>
                `;

                const cleanup = () => {
                    document.removeEventListener('keydown', onKeyDown);
                    modal.remove();
                };

                const onKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        resolve(Boolean(dismissValue));
                    }
                };

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        cleanup();
                        resolve(Boolean(dismissValue));
                    }
                });

                document.body.appendChild(modal);
                document.addEventListener('keydown', onKeyDown);

                const okBtn = modal.querySelector('#hoverConfirmOk');
                const cancelBtn = modal.querySelector('#hoverConfirmCancel');

                setTimeout(() => {
                    okBtn?.focus();
                }, 0);

                cancelBtn?.addEventListener('click', () => {
                    cleanup();
                    resolve(false);
                });

                okBtn?.addEventListener('click', () => {
                    cleanup();
                    resolve(true);
                });
            });
        };

        // Feature flag: set to false to use native browser dialogs (quick rollback)
        const USE_HOVER_CARD_DIALOGS = true;

        // Wrapper APIs so dialog UX is easy to roll back
        window.uiAlert = async ({
            title = 'Notice',
            message = '',
            okText = 'OK',
            danger = false,
        } = {}) => {
            if (!USE_HOVER_CARD_DIALOGS) {
                alert(String(message ?? ''));
                return true;
            }
            return window.showHoverConfirmModal({
                title,
                message,
                confirmText: okText,
                hideCancel: true,
                danger,
                dismissValue: true,
            });
        };

        window.uiConfirm = async ({
            title = 'Confirm',
            message = '',
            confirmText = 'OK',
            cancelText = 'Cancel',
            danger = false,
        } = {}) => {
            if (!USE_HOVER_CARD_DIALOGS) {
                return confirm(String(message ?? ''));
            }
            return window.showHoverConfirmModal({ title, message, confirmText, cancelText, danger });
        };

        window.uiPrompt = async ({
            title = 'Input required',
            subtitle = '',
            label = 'Value',
            placeholder = '',
            value = '',
            infoRows = [],
            inputType = 'text',
            inputMode = undefined,
            okText = 'Save',
            cancelText = 'Cancel',
            extraButtonText = '',
            extraButtonClass = undefined,
            onExtra = null,
        } = {}) => {
            if (!USE_HOVER_CARD_DIALOGS) {
                const promptLabel = [title, subtitle, label].filter(Boolean).join('\n');
                return prompt(promptLabel, String(value ?? ''));
            }
            return window.showHoverInputModal({ title, subtitle, label, placeholder, value, infoRows, inputType, inputMode, okText, cancelText, extraButtonText, extraButtonClass, onExtra });
        };

        // UPDATE OCCUPANCY METRICS - Count only the 12 immutable rooms
        window.updateOccupancyMetrics = () => {
            // Count only the 12 immutable rooms
            let occupiedCount = 0;
            let totalPending = 0;
            let totalReceived = 0;

            const now = new Date();
            const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            // Post-paid model: show stats for the previous month.
            const prev = getPrevYearMonth(now.getFullYear(), now.getMonth());
            const targetMonthKey = `${prev.year}-${monthNames[prev.monthIndex]}`;
            
            Object.keys(IMMUTABLE_ROOMS_DATA).forEach(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);
                
                if (isOccupiedRecord(tenantData)) {
                    occupiedCount++;

                    const history = tenantData?.paymentHistory || {};
                    const totals = tenantData?.paymentTotals || {};
                    const rent = parseFloat(tenantData?.rent) || 0;
                    const hasAnyHistory = history && Object.keys(history).some(k => {
                        const v = history[k];
                        return v !== null && v !== undefined && String(v).trim() !== '';
                    });
                    const status = history[targetMonthKey] || (!hasAnyHistory ? (tenantData?.payStatus || 'None') : 'None');

                    if (status === 'Pending') {
                        totalPending += rent;
                    } else if (status === 'Rent Only') {
                        totalReceived += rent;
                    } else if (status === 'Paid') {
                        const storedTotal = Number(totals?.[targetMonthKey]);
                        if (Number.isFinite(storedTotal)) {
                            totalReceived += storedTotal;
                        } else {
                            // Back-compat: if totals aren't stored, fallback to rent only
                            totalReceived += rent;
                        }
                    }
                }
            });
            
            const vacantCount = 12 - occupiedCount;
            
            const occupiedEl = document.getElementById('occupied-count');
            const vacantEl = document.getElementById('vacant-count');
            const pendingEl = document.getElementById('pending-rent');
            const receivedEl = document.getElementById('rent-received');
            
            if (occupiedEl) occupiedEl.innerText = occupiedCount;
            if (vacantEl) vacantEl.innerText = vacantCount;
            if (pendingEl) pendingEl.innerText = '₹' + totalPending.toLocaleString();
            if (receivedEl) receivedEl.innerText = '₹' + totalReceived.toLocaleString();

            // Keep quick lists in sync
            try { window.renderPendingThisMonthCard(); } catch (e) { console.warn("⚠️ renderPendingThisMonthCard failed:", e); }

            // Keep dashboards in sync
            try { window.renderFinancialDashboard(); } catch (e) { console.warn("⚠️ renderFinancialDashboard failed:", e); }
        };

        // DASHBOARD (Financial Summary)
        function getMonthKey(year, monthIndex) {
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            return `${year}-${months[monthIndex]}`;
        }

        function formatMonthLabel(year, monthIndex) {
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            return `${months[monthIndex]} ${year}`;
        }

        function sumExpensesForMonth(monthKey) {
            if (!Array.isArray(allExpensesData)) return 0;
            return allExpensesData
                .filter(e => String(e?.monthKey || '') === String(monthKey))
                .reduce((sum, e) => sum + (Number(e?.amount) || 0), 0);
        }

        function computeRentCollectedForMonth(year, monthIndex) {
            const key = getMonthKey(year, monthIndex);
            let total = 0;

            Object.keys(IMMUTABLE_ROOMS_DATA).forEach(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);

                const history = tenantData?.paymentHistory || {};
                const totals = tenantData?.paymentTotals || {};
                const status = history?.[key] || null;

                const archived = tenantData?.archivedTenant || null;
                const archivedHistory = archived?.paymentHistory || {};
                const archivedTotals = archived?.paymentTotals || {};
                const archivedStatus = archivedHistory?.[key] || null;

                const useArchived = (!status || status === 'None') && archivedStatus;
                const effectiveStatus = useArchived ? archivedStatus : status;
                if (effectiveStatus !== 'Paid') return;

                const effectiveTotals = useArchived ? archivedTotals : totals;
                const effectiveRent = useArchived ? (Number(archived?.rent) || 0) : (Number(tenantData?.rent) || 0);

                const storedTotal = Number(effectiveTotals?.[key]);
                if (Number.isFinite(storedTotal)) total += storedTotal;
                else total += effectiveRent;
            });

            return total;
        }

        function computePendingRentForMonth(year, monthIndex) {
            const key = getMonthKey(year, monthIndex);
            let total = 0;

            Object.keys(IMMUTABLE_ROOMS_DATA).forEach(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);

                const history = tenantData?.paymentHistory || {};
                const status = history?.[key] || null;

                const archived = tenantData?.archivedTenant || null;
                const archivedHistory = archived?.paymentHistory || {};
                const archivedStatus = archivedHistory?.[key] || null;

                const useArchived = (!status || status === 'None') && archivedStatus;
                const effectiveStatus = useArchived ? archivedStatus : status;
                if (effectiveStatus !== 'Pending') return;

                const effectiveRent = useArchived ? (Number(archived?.rent) || 0) : (Number(tenantData?.rent) || 0);
                total += effectiveRent;
            });

            return total;
        }

        function computeWaterChargesForMonth(year, monthIndex) {
            let total = 0;
            Object.keys(IMMUTABLE_ROOMS_DATA).forEach(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);

                const rate = Number(tenantData?.waterRate);
                const effectiveRate = Number.isFinite(rate) ? rate : getDefaultWaterRateForRoom(roomData.roomNo);
                const result = computeWaterForMonth(tenantData, year, monthIndex, effectiveRate);

                let amt = Number(result?.amount);
                if (!Number.isFinite(amt)) {
                    const archived = tenantData?.archivedTenant || null;
                    if (archived) {
                        const archivedRate = Number(archived?.waterRate);
                        const archivedEffectiveRate = Number.isFinite(archivedRate) ? archivedRate : getDefaultWaterRateForRoom(roomData.roomNo);
                        const archivedResult = computeWaterForMonth(archived, year, monthIndex, archivedEffectiveRate);
                        amt = Number(archivedResult?.amount);
                    }
                }

                if (!Number.isFinite(amt)) return;
                total += amt;
            });
            return total;
        }

        // ONE-TIME CLEANUP: Clear any saved Rent/Water statuses & totals for locked months (current+future).
        // This prevents old future-month data from polluting dashboards after switching to post-paid locking.
        window.runLockedMonthsCleanup = async () => {
            const now = new Date();
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

            const ok = await window.uiConfirm({
                title: 'One-time cleanup',
                message: `This will clear any saved Rent/Water statuses & totals for locked months (current & future) across all tenants.\n\nIt will not affect past months.\n\nContinue?`,
                confirmText: 'Yes, cleanup',
                cancelText: 'Cancel',
                danger: true,
            });
            if (!ok) return;

            const parseKey = (keyRaw) => {
                const s = String(keyRaw || '').trim();
                const parts = s.split('-');
                if (parts.length < 2) return null;
                const year = Number(parts[0]);
                const monthLabel = String(parts.slice(1).join('-') || '').trim();
                const monthIndex = months.indexOf(monthLabel);
                if (!Number.isFinite(year) || monthIndex < 0) return null;
                return { year, monthIndex };
            };

            let docsTouched = 0;
            let fieldsCleared = 0;

            const props = Array.isArray(allPropertiesData) ? allPropertiesData : [];
            if (props.length === 0) {
                showNotification('No properties loaded yet. Please wait for data to load and try again.', 'info');
                return;
            }

            // Process sequentially to avoid burst writes.
            for (const prop of props) {
                const payload = {};

                const history = prop?.paymentHistory || {};
                const totals = prop?.paymentTotals || {};

                for (const key of Object.keys(history)) {
                    const parsed = parseKey(key);
                    if (!parsed) continue;
                    if (!isFutureYearMonth(parsed.year, parsed.monthIndex, now)) continue;
                    payload[`paymentHistory.${key}`] = null;
                    fieldsCleared++;
                }
                for (const key of Object.keys(totals)) {
                    const parsed = parseKey(key);
                    if (!parsed) continue;
                    if (!isFutureYearMonth(parsed.year, parsed.monthIndex, now)) continue;
                    payload[`paymentTotals.${key}`] = null;
                    fieldsCleared++;
                }

                const archived = prop?.archivedTenant || null;
                const archivedHistory = archived?.paymentHistory || {};
                const archivedTotals = archived?.paymentTotals || {};

                for (const key of Object.keys(archivedHistory)) {
                    const parsed = parseKey(key);
                    if (!parsed) continue;
                    if (!isFutureYearMonth(parsed.year, parsed.monthIndex, now)) continue;
                    payload[`archivedTenant.paymentHistory.${key}`] = null;
                    fieldsCleared++;
                }
                for (const key of Object.keys(archivedTotals)) {
                    const parsed = parseKey(key);
                    if (!parsed) continue;
                    if (!isFutureYearMonth(parsed.year, parsed.monthIndex, now)) continue;
                    payload[`archivedTenant.paymentTotals.${key}`] = null;
                    fieldsCleared++;
                }

                const keysToUpdate = Object.keys(payload);
                if (keysToUpdate.length === 0) continue;

                try {
                    const propRef = doc(db, 'properties', prop.id);
                    await updateDoc(propRef, payload);
                    docsTouched++;
                } catch (e) {
                    console.error('Cleanup update failed for property', prop?.id, e);
                    showNotification(`Cleanup failed for a property: ${e.message}`, 'error');
                    // Continue with the rest.
                }
            }

            showNotification(`✓ Cleanup complete: ${docsTouched} properties updated, ${fieldsCleared} fields cleared.`, 'success');

            // Hide button for this browser session (optional UX).
            try {
                const btns = Array.from(document.querySelectorAll('[data-cleanup-btn="1"]'));
                btns.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-60', 'cursor-not-allowed');
                    btn.textContent = 'Cleanup done';
                });
            } catch (e) { /* ignore */ }

            // Force a UI refresh immediately; Firestore snapshot will also refresh.
            try { window.renderRentDetailsTable(); } catch (e) { /* ignore */ }
            try { window.renderRentWaterTable(); } catch (e) { /* ignore */ }
            try { window.updateOccupancyMetrics(); } catch (e) { /* ignore */ }
            try { window.renderFinancialDashboard(); } catch (e) { /* ignore */ }
        };

        window.renderFinancialDashboard = () => {
            const yearLabel = document.getElementById('dashboard-year');
            if (yearLabel) yearLabel.textContent = String(currentDashboardYear);

            const body = document.getElementById('dashboardBody');
            if (!body) return;

            const year = (typeof currentDashboardYear === 'number' && Number.isFinite(currentDashboardYear))
                ? currentDashboardYear
                : new Date().getFullYear();

            const rows = [];
            const now = new Date();
            for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
                const key = getMonthKey(year, monthIndex);
                const locked = isFutureYearMonth(year, monthIndex, now);

                // Post-paid model: current & future months are locked (ignore any old saved data).
                const rentCollected = locked ? 0 : computeRentCollectedForMonth(year, monthIndex);
                const pendingRent = locked ? 0 : computePendingRentForMonth(year, monthIndex);
                const waterCharges = locked ? 0 : computeWaterChargesForMonth(year, monthIndex);
                const expenses = sumExpensesForMonth(key);

                rows.push({
                    monthLabel: formatMonthLabel(year, monthIndex),
                    rentCollected,
                    expenses,
                    waterCharges,
                    pendingRent,
                    locked
                });
            }

            body.innerHTML = rows.map(r => {
                const rentText = r.locked ? '—' : `₹${Math.round(r.rentCollected).toLocaleString('en-IN')}`;
                const expText = `₹${Math.round(r.expenses).toLocaleString('en-IN')}`;
                const waterText = r.locked ? '—' : `₹${Math.round(Number(r.waterCharges) || 0).toLocaleString('en-IN')}`;
                const pendingText = r.locked ? '—' : `₹${Math.round(r.pendingRent).toLocaleString('en-IN')}`;

                const rowClass = r.locked ? 'border-b bg-gray-50' : 'border-b hover:bg-gray-50';
                const valueCellClass = r.locked ? 'text-gray-400' : '';

                return `
                    <tr class="${rowClass}">
                        <td class="border px-4 py-3 font-semibold text-gray-800 bg-white">${escapeHtml(r.monthLabel)}</td>
                        <td class="border px-4 py-3 text-right font-semibold text-green-700 bg-white ${valueCellClass}">${rentText}</td>
                        <td class="border px-4 py-3 text-right font-semibold text-red-700 bg-white">${expText}</td>
                        <td class="border px-4 py-3 text-right font-semibold text-blue-700 bg-white ${valueCellClass}">${waterText}</td>
                        <td class="border px-4 py-3 text-right font-semibold text-orange-700 bg-white ${valueCellClass}">${pendingText}</td>
                    </tr>
                `;
            }).join('');
        };

        window.changeDashboardYear = (delta) => {
            currentDashboardYear = (Number(currentDashboardYear) || new Date().getFullYear()) + (Number(delta) || 0);
            window.renderFinancialDashboard();
        };

        // EXPENSES
        window.changeExpensesYear = (delta) => {
            currentExpensesYear = (Number(currentExpensesYear) || new Date().getFullYear()) + (Number(delta) || 0);
            window.renderExpensesList();
            window.renderFinancialDashboard();
        };

        window.renderExpensesList = () => {
            const yearLabel = document.getElementById('expenses-year');
            if (yearLabel) yearLabel.textContent = String(currentExpensesYear);

            const tbody = document.getElementById('expensesBody');
            if (!tbody) return;

            const year = (typeof currentExpensesYear === 'number' && Number.isFinite(currentExpensesYear))
                ? currentExpensesYear
                : new Date().getFullYear();

            const filtered = (Array.isArray(allExpensesData) ? allExpensesData : [])
                .filter(e => {
                    const d = parseDateValue(e?.date);
                    return d ? d.getFullYear() === year : (Number(e?.year) === year);
                });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-400">No expenses for this year.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(e => {
                const monthKey = String(e?.monthKey || '');
                const dateStr = String(e?.date || '');
                const category = String(e?.category || '');
                const note = String(e?.note || '');
                const amount = Number(e?.amount) || 0;
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="border px-4 py-3 text-sm bg-white">${escapeHtml(monthKey)}</td>
                        <td class="border px-4 py-3 text-sm bg-white">${escapeHtml(dateStr)}</td>
                        <td class="border px-4 py-3 text-sm font-semibold bg-white">${escapeHtml(category)}</td>
                        <td class="border px-4 py-3 text-sm bg-white">${escapeHtml(note)}</td>
                        <td class="border px-4 py-3 text-right font-semibold bg-white">₹${amount.toLocaleString('en-IN')}</td>
                    </tr>
                `;
            }).join('');
        };

        // DASHBOARD: PENDING THIS MONTH (compact list)
        window.renderPendingThisMonthCard = () => {
            const listEl = document.getElementById('pendingThisMonthList');
            const countEl = document.getElementById('pending-this-month-count');
            const cardEl = document.getElementById('pendingThisMonthCard');
            if (!listEl) return;

            const now = new Date();
            const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const prev = getPrevYearMonth(now.getFullYear(), now.getMonth());
            const targetMonthKey = `${prev.year}-${monthNames[prev.monthIndex]}`;

            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            const pending = [];

            for (const roomNoKey of roomNos) {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNoKey];
                const tenantData = findTenantForRoom(roomData);
                if (!isOccupiedRecord(tenantData)) continue;

                const history = tenantData?.paymentHistory || {};
                const status = history[targetMonthKey] || tenantData?.payStatus || 'None';
                if (status !== 'Pending') continue;

                const rent = Number(tenantData?.rent) || 0;
                pending.push({
                    roomNoKey,
                    roomNoLabel: roomData?.roomNo ?? roomNoKey,
                    roomId: roomData?.roomId ?? null,
                    tenant: tenantData?.tenant || 'Tenant',
                    amount: rent
                });
            }

            if (countEl) countEl.textContent = String(pending.length);

            if (cardEl) {
                cardEl.style.display = pending.length > 0 ? '' : 'none';
            }

            if (pending.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">No pending rents for last month.</p>';
                return;
            }

            listEl.innerHTML = pending.map(item => {
                const amountLabel = item.amount ? `₹${item.amount.toLocaleString('en-IN')}` : '₹0';
                const safeTenant = escapeHtml(String(item.tenant || 'Tenant'));
                return `
                    <button type="button" class="w-full text-left p-4 rounded-lg border border-gray-200 hover:bg-orange-50 hover:border-orange-200 transition" onclick="window.openRentDetailsForRoom('${item.roomNoKey}', '${escapeHtml(String(item.roomId || ''))}')">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-sm font-bold text-gray-800">Room ${escapeHtml(String(item.roomNoLabel))}</div>
                                <div class="text-xs text-gray-600 mt-1 truncate">${safeTenant}</div>
                            </div>
                            <div class="text-sm font-bold text-orange-700">${amountLabel}</div>
                        </div>
                    </button>
                `;
            }).join('');
        };

        // Jump helper: open Rent Details and focus a room row
        window.openRentDetailsForRoom = (roomNoKey, roomId = '') => {
            try {
                window.showSection('rent-details');

                // Ensure table is present and up to date
                try { window.renderRentDetailsTable(); } catch (e) { /* ignore */ }

                setTimeout(() => {
                    const tbody = document.getElementById('rentDetailsBody');
                    if (!tbody) return;

                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const match = rows.find(tr => {
                        const rid = String(tr?.dataset?.roomId || '').trim();
                        const rkey = String(tr?.dataset?.roomNoKey || '').trim();
                        if (roomId && rid && rid === String(roomId).trim()) return true;
                        return String(roomNoKey).trim() && rkey === String(roomNoKey).trim();
                    });

                    if (!match) return;

                    match.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    match.classList.add('ring-2', 'ring-orange-300');
                    setTimeout(() => match.classList.remove('ring-2', 'ring-orange-300'), 1200);
                }, 150);
            } catch (e) {
                console.warn('openRentDetailsForRoom failed', e);
            }
        };

        // DASHBOARD: RENT REVISION DUE SOON (based on relocation anniversary)
        window.renderRentRevisionDueCard = () => {
            const listEl = document.getElementById('rentRevisionList');
            const countEl = document.getElementById('rent-revision-count');
            const cardEl = document.getElementById('rentRevisionDueCard');
            if (!listEl) return;

            const now = new Date();
            const today = new Date(now);
            today.setHours(0, 0, 0, 0);

            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            const due = [];

            for (const roomNo of roomNos) {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);
                if (!isOccupiedRecord(tenantData)) continue;
                if (tenantData?.noAnnualRevision) continue;

                const { relocateDate, lastRevisionDate, nextDue, daysTo } = getRentRevisionDates(tenantData, today);
                if (!nextDue || daysTo === null || daysTo === undefined) continue;

                // Include tenants already overdue (crossed 1 year) and those due soon within window.
                if (daysTo > RENT_REVISION_WINDOW_DAYS) continue;

                due.push({
                    roomNo: roomData.roomNo,
                    roomId: roomData.roomId,
                    tenant: tenantData?.tenant || 'Tenant',
                    relocateDate,
                    lastRevisionDate,
                    nextDue,
                    daysTo
                });
            }

            // Overdue first, then soonest upcoming
            due.sort((a, b) => {
                const aOver = a.daysTo < 0;
                const bOver = b.daysTo < 0;
                if (aOver !== bOver) return aOver ? -1 : 1;
                return a.daysTo - b.daysTo;
            });
            if (countEl) countEl.textContent = String(due.length);

            if (cardEl) {
                cardEl.style.display = due.length > 0 ? '' : 'none';
            }

            if (due.length === 0) {
                listEl.innerHTML = `<p class="text-gray-400">No tenants due/overdue for rent revision.</p>`;
                return;
            }

            listEl.innerHTML = due.map(item => {
                const daysLabel = item.daysTo < 0
                    ? `Overdue by ${Math.abs(item.daysTo)} day${Math.abs(item.daysTo) === 1 ? '' : 's'}`
                    : (item.daysTo === 0 ? 'Due today' : `Due in ${item.daysTo} day${item.daysTo === 1 ? '' : 's'}`);
                const badgeClass = item.daysTo < 0
                    ? 'bg-red-100 text-red-800 border-red-200'
                    : 'bg-purple-100 text-purple-800 border-purple-200';
                return `
                    <button type="button" class="w-full text-left p-4 rounded-lg border border-gray-200 hover:bg-purple-50 hover:border-purple-200 transition" onclick="window.showSection('room-details'); window.openRoomDetailModal('${item.roomNo}')">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <p class="font-semibold text-gray-800">Room ${item.roomNo} • ${item.tenant}</p>
                                <p class="text-xs text-gray-500 mt-1">Relocation: ${formatDateForDisplay(item.relocateDate)} • Last revision: ${formatDateForDisplay(item.lastRevisionDate)} • Next: ${formatDateForDisplay(item.nextDue)}</p>
                            </div>
                            <span class="shrink-0 inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold ${badgeClass} border">${daysLabel}</span>
                        </div>
                    </button>
                `;
            }).join('');
        };

        // AUTH FUNCTIONS - Expose to window
        window.loginWithGoogle = async (mode = 'user') => {
            const nextMode = setLoginMode(mode);
            console.log("✓ loginWithGoogle clicked (mode):", nextMode);
            const errorMsg = document.getElementById('login-error');
            if (errorMsg) errorMsg.classList.add('hidden');
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("✓ Sign-in successful:", result.user.email);
                // For user sessions, kick UI refresh quickly (admin portal skips app data)
                if (getLoginMode() !== 'admin') {
                    setTimeout(() => {
                        window.generateRoomCards();
                        window.updateOccupancyMetrics();
                        try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                    }, 100);
                }
            } catch (error) {
                console.error("❌ Login failed:", error);
                let message = "Login failed: " + error.message;
                if (error.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    message = `⚠️ Domain Unauthorized: "${domain}"\n\nAdd to Firebase:\n1. Console → Authentication\n2. Settings → Authorized Domains\n3. Add: ${domain}`;
                }
                if (errorMsg) {
                    errorMsg.innerText = message;
                    errorMsg.classList.remove('hidden');
                }
            }
        };
        
        // Initialize room cards on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log("✓ Page loaded, initializing room cards");
            try { window.showSection('dashboard'); } catch (e) { console.warn("⚠️ showSection('dashboard') failed:", e); }
            if (getLoginMode() !== 'admin') {
                window.generateRoomCards();
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
            }

            // Expenses form submit
            const expenseForm = document.getElementById('expenseForm');
            if (expenseForm) {
                expenseForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (typeof window.addExpense === 'function') {
                        await window.addExpense();
                    }
                });
            }
        });

        window.logout = async () => {
            console.log("✓ logout clicked");
            if (unsubscribe) unsubscribe();
            if (expensesUnsubscribe) expensesUnsubscribe();
            try { sessionStorage.removeItem('loginMode'); } catch (e) {}
            await signOut(auth);
            window.location.reload();
        };

        // SECTION NAVIGATION
        window.showSection = (sectionName) => {
            if (isAdminSession && sectionName !== 'admin') {
                showNotification('Admin Portal: only Admin section is available', 'warning');
                sectionName = 'admin';
            }
            if (!isAdminSession && sectionName === 'admin') {
                showNotification('Admin access required', 'warning');
                sectionName = 'dashboard';
            }
            // Hide all sections
            document.querySelectorAll('.section-tab').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show the selected section
            const activeSection = document.getElementById(sectionName);
            if (activeSection) {
                activeSection.classList.add('active');
            }

            // Update active nav link styling
            document.querySelectorAll('[data-section]').forEach(link => {
                const isActive = link.getAttribute('data-section') === sectionName;
                link.classList.toggle('nav-active', isActive);
                if (isActive) link.setAttribute('aria-current', 'page');
                else link.removeAttribute('aria-current');
            });
            
            console.log("✓ Showing section:", sectionName);
        };

        // Auth State Listener - Check Authorization
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("✓ User signed in:", user.email);
                
                // Check authorization against Firestore authorizedUsers/adminUsers collections
                try {
                    const mode = getLoginMode();
                    const authCol = (mode === 'admin') ? 'adminUsers' : 'authorizedUsers';
                    const authRef = doc(db, authCol, user.email);
                    const authSnapshot = await getDoc(authRef);

                    if (!authSnapshot.exists()) {
                        console.error("❌ Unauthorized user:", user.email, 'mode=', mode);
                        await signOut(auth);
                        const msg = (mode === 'admin')
                            ? `❌ ADMIN ACCESS DENIED\n\nYour email (${user.email}) is not an admin.\n\nPlease contact the administrator.`
                            : `❌ ACCESS DENIED\n\nYour email (${user.email}) is not authorized.\n\nPlease contact the administrator for access.`;
                        document.getElementById('login-error').innerText = msg;
                        document.getElementById('login-error').classList.remove('hidden');
                        return;
                    }

                    isAdminSession = (mode === 'admin');
                    applySessionNavMode();

                    // User is authorized - proceed with login
                    currentUser = user;
                    console.log("✓ User authorized:", user.email, 'mode=', mode);
                    document.getElementById('user-name').innerText = user.displayName || 'User';
                    let photoURL = user.photoURL && (user.photoURL.startsWith('http://') || user.photoURL.startsWith('https://')) ? user.photoURL : 'https://via.placeholder.com/150';
                    document.getElementById('user-photo').src = photoURL;
                    document.getElementById('login-screen').classList.add('hidden-section');
                    document.getElementById('app-content').classList.remove('hidden-section');
                    document.getElementById('login-error').classList.add('hidden');

                    // Initialize year labels
                    try {
                        const dy = document.getElementById('dashboard-year');
                        if (dy) dy.textContent = String(currentDashboardYear);
                        const ey = document.getElementById('expenses-year');
                        if (ey) ey.textContent = String(currentExpensesYear);
                    } catch (e) {
                        console.warn('⚠️ Year label init failed:', e);
                    }

                    if (!isAdminSession) {
                        initDataListener();
                        subscribeExpenses();

                        // Initial renders (safe if data not loaded yet)
                        try { window.renderFinancialDashboard(); } catch (e) { console.warn('⚠️ renderFinancialDashboard failed:', e); }
                        try { window.renderExpensesList(); } catch (e) { console.warn('⚠️ renderExpensesList failed:', e); }
                    } else {
                        try { await loadAdminSettings(); } catch (e) { console.warn('⚠️ loadAdminSettings failed:', e); }
                        try { window.showSection('admin'); } catch (e) { console.warn("⚠️ showSection('admin') failed:", e); }
                    }
                } catch (err) {
                    console.error("Authorization check error:", err);
                    await signOut(auth);
                    document.getElementById('login-error').innerText = `⚠️ System Error\n\n${err.message}\n\nPlease try again.`;
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } else {
                console.log("✓ User signed out");
                isAdminSession = false;
                applySessionNavMode();
                if (unsubscribe) { try { unsubscribe(); } catch {} unsubscribe = null; }
                if (expensesUnsubscribe) { try { expensesUnsubscribe(); } catch {} expensesUnsubscribe = null; }
                document.getElementById('login-screen').classList.remove('hidden-section');
                document.getElementById('app-content').classList.add('hidden-section');
            }
        });

        // DATA LISTENER
        function initDataListener() {
            console.log("✓ Initializing data listener");
            const q = query(collection(db, "properties"), orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, async (snapshot) => {
                allPropertiesData = [];
                snapshot.forEach((doc) => {
                    allPropertiesData.push({ id: doc.id, ...doc.data() });
                });

                console.log(`✓ Loaded ${allPropertiesData.length} properties from Firestore`);

                // Also load rooms collection to populate dashboard inputs
                try {
                    await loadDashboardDataFromFirestore();
                } catch (e) {
                    console.warn("⚠️ loadDashboardDataFromFirestore failed:", e);
                }

                // Always refresh core dashboard views even if optional sections are missing/broken
                try { window.updateOccupancyMetrics(); } catch (e) { console.warn("⚠️ updateOccupancyMetrics failed:", e); }
                try { window.safeApplyFilters(); } catch (e) { console.warn("⚠️ safeApplyFilters failed:", e); }
                try { window.generateRoomCards(); } catch (e) { console.warn("⚠️ generateRoomCards failed:", e); }
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                try { window.renderWaterBillTable(); } catch (e) { console.warn("⚠️ renderWaterBillTable failed:", e); }

                // Auto-vacate tenants whose confirmed eviction date has passed
                try { await autoVacateEvictedTenants(); } catch (e) { console.warn("⚠️ autoVacateEvictedTenants failed:", e); }
            }, (error) => {
                console.error("Data fetch error:", error);
                if (error.code === 'permission-denied') {
                    void window.uiAlert({
                        title: 'Permission denied',
                        message: 'Access was blocked by Firestore rules. Please check your Firebase permissions/rules and try again.',
                        danger: true,
                        okText: 'OK'
                    });
                }
            });
        }

        function parseAmountSafe(raw) {
            const cleaned = String(raw || '').replace(/,/g, '').trim();
            const n = Number(cleaned);
            return Number.isFinite(n) ? n : null;
        }

        function subscribeExpenses() {
            try {
                if (expensesUnsubscribe) {
                    expensesUnsubscribe();
                    expensesUnsubscribe = null;
                }

                const expensesCol = collection(db, 'expenses');
                const qExp = query(expensesCol, orderBy('date', 'desc'));
                expensesUnsubscribe = onSnapshot(qExp, (snap) => {
                    const items = [];
                    snap.forEach(docSnap => {
                        items.push({ id: docSnap.id, ...docSnap.data() });
                    });
                    allExpensesData = items;
                    try { window.renderExpensesList(); } catch (e) { console.warn('⚠️ renderExpensesList failed:', e); }
                    try { window.renderFinancialDashboard(); } catch (e) { console.warn('⚠️ renderFinancialDashboard failed:', e); }
                }, (err) => {
                    console.error('❌ Expenses subscription failed:', err);
                });
            } catch (e) {
                console.error('❌ subscribeExpenses error:', e);
            }
        }

        window.addExpense = async () => {
            const dateEl = document.getElementById('expenseDate');
            const categoryEl = document.getElementById('expenseCategory');
            const amountEl = document.getElementById('expenseAmount');
            const noteEl = document.getElementById('expenseNote');

            const dateStr = String(dateEl?.value || '').trim();
            const category = String(categoryEl?.value || '').trim();
            const amount = parseAmountSafe(amountEl?.value);
            const note = String(noteEl?.value || '').trim();

            if (!dateStr) {
                await uiAlert('Please select a date.');
                return;
            }
            if (!category) {
                await uiAlert('Please select a category.');
                return;
            }
            if (amount === null || amount <= 0) {
                await uiAlert('Please enter a valid amount.');
                return;
            }

            const d = parseDateValue(dateStr);
            if (!d) {
                await uiAlert('Invalid date.');
                return;
            }

            const year = d.getFullYear();
            const monthIndex = d.getMonth();
            const monthKey = getMonthKey(year, monthIndex);

            try {
                await addDoc(collection(db, 'expenses'), {
                    date: dateStr,
                    year,
                    monthKey,
                    category,
                    amount,
                    note,
                    createdAt: serverTimestamp(),
                    createdBy: String(auth.currentUser?.email || '')
                });

                if (amountEl) amountEl.value = '';
                if (noteEl) noteEl.value = '';

                currentExpensesYear = year;
                currentDashboardYear = year;
                try {
                    const dy = document.getElementById('dashboard-year');
                    if (dy) dy.textContent = String(currentDashboardYear);
                    const ey = document.getElementById('expenses-year');
                    if (ey) ey.textContent = String(currentExpensesYear);
                } catch {}

                showNotification('✓ Expense saved', 'success');
                try { window.renderExpensesList(); } catch {}
                try { window.renderFinancialDashboard(); } catch {}
            } catch (e) {
                console.error('❌ addExpense failed:', e);
                showNotification('Failed to save expense: ' + (e?.message || e), 'error');
            }
        };

        // Load dashboard row data from Firestore rooms collection
        async function loadDashboardDataFromFirestore() {
            try {
                const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const roomsSnapshot = await getDocs(collection(db, "rooms"));
                
                // Create a map of roomId -> room data
                const roomsMap = {};
                roomsSnapshot.forEach((doc) => {
                    roomsMap[doc.id] = doc.data();
                });

                console.log(`📦 Found ${Object.keys(roomsMap).length} rooms in Firestore`);

                // Populate dashboard inputs with rooms data (limit to first 12 rows)
                let rowIndex = 0;
                Object.entries(roomsMap).forEach(([roomId, roomData]) => {
                    if (rowIndex < 12) {
                        const row = document.getElementById(`row-${rowIndex}-roomNo`);
                        if (row) {
                            document.getElementById(`row-${rowIndex}-roomNo`).value = roomData.roomNo || '';
                            document.getElementById(`row-${rowIndex}-roomId`).value = roomData.roomId || roomId;
                            document.getElementById(`row-${rowIndex}-keyNo`).value = roomData.keyNo || '';
                            document.getElementById(`row-${rowIndex}-ebServNo`).value = roomData.ebServNo || '';
                            document.getElementById(`row-${rowIndex}-ebAcNo`).value = roomData.ebAcNo || '';
                            document.getElementById(`row-${rowIndex}-tenantName`).value = roomData.tenantName || '';
                            document.getElementById(`row-${rowIndex}-rent`).value = roomData.rent || '';
                            document.getElementById(`row-${rowIndex}-contact`).value = roomData.contact || '';
                            document.getElementById(`row-${rowIndex}-deposit`).value = roomData.deposit || '';
                            document.getElementById(`row-${rowIndex}-relocate`).value = roomData.relocate || '';
                            console.log(`✓ Loaded room ${rowIndex}: ${roomData.roomNo} (${roomData.roomId})`);
                            rowIndex++;
                        }
                    }
                });

                console.log(`✓ Populated ${rowIndex} dashboard rows`);
                // After populating dashboard, render Rent Details table
                renderRentDetailsTable();
                try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
                try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                try { window.renderWaterBillTable(); } catch (e) { console.warn("⚠️ renderWaterBillTable failed:", e); }
                return true;
            } catch (error) {
                console.error("❌ Error loading dashboard data:", error);
                return false;
            }
        }

        // RENDER & LOGIC
        window.safeApplyFilters = () => {
            try {
                window.applyFilters();
            } catch (e) {
                console.warn("⚠️ applyFilters crashed:", e);
            }
        };

        window.applyFilters = () => {
            const searchText = String(document.getElementById('searchInput')?.value || '').toLowerCase();
            const filterStatus = String(document.getElementById('filterStatus')?.value || 'All');
            const filterPayment = String(document.getElementById('filterPayment')?.value || 'All');

            const filteredData = allPropertiesData.filter(prop => {
                const nameLc = String(prop?.name || '').toLowerCase();
                const tenantLc = String(prop?.tenant || '').toLowerCase();
                const status = String(prop?.status || '');
                const payStatus = String(prop?.payStatus || '');

                const matchesSearch = nameLc.includes(searchText) || tenantLc.includes(searchText);
                const matchesStatus = (filterStatus === 'All') || (status === filterStatus);
                const matchesPayment = (filterPayment === 'All') || (payStatus === filterPayment);
                
                return matchesSearch && matchesStatus && matchesPayment;
            });
            renderProperties(filteredData);
            renderTenants(filteredData);
            updateStats(allPropertiesData);
            
            // Generate room cards and update metrics
            window.generateRoomCards();
            window.updateOccupancyMetrics();
            renderTenantDetailsCards(allPropertiesData);
            try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
            try { window.renderWaterBillTable(); } catch (e) { console.warn("⚠️ renderWaterBillTable failed:", e); }
            // renderRentDetailsTable(); // Now called after dashboard data loads
        };

        // TENANT DETAILS RENDERING
        window.renderTenantDetailsCards = (tenantList) => {
            const grid = document.getElementById('tenantDetailsGrid');
            if (!grid) {
                // Tenant details section isn't present in the DOM in the current UI.
                // Avoid throwing here because it can stop dashboard refreshes.
                return;
            }
            if (!tenantList || tenantList.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">No tenants found.</p>';
                return;
            }

            // Only show occupied properties
            const occupiedTenants = tenantList.filter(p => p.status === 'Occupied' && p.tenant && p.tenant !== 'None');

            if (occupiedTenants.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">No occupied units at the moment.</p>';
                return;
            }

            grid.innerHTML = occupiedTenants.map(tenant => `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition cursor-pointer border-l-4 border-blue-500 p-6" onclick="openTenantDetailsModal('${tenant.id}')">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${escapeHtml(tenant.tenant)}</h3>
                            <p class="text-sm text-gray-600"><i class="fa-solid fa-door-open mr-1"></i>Room: ${escapeHtml(tenant.name || 'N/A')}</p>
                        </div>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Occupied</span>
                    </div>
                    <div class="border-t pt-3 space-y-2">
                        <p class="text-sm"><span class="font-semibold text-gray-700">Rent:</span> <span class="text-blue-600 font-bold">₹${tenant.rent || 0}</span></p>
                        <p class="text-sm"><span class="font-semibold text-gray-700">Contact:</span> ${escapeHtml(tenant.contact || 'N/A')}</p>
                    </div>
                    <button class="w-full mt-4 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition text-sm font-semibold">
                        View Details
                    </button>
                </div>
            `).join('');
        };

        window.openTenantDetailsModal = (tenantId) => {
            const tenant = allPropertiesData.find(p => p.id === tenantId);
            if (!tenant) return;

            const relocateDate = tenant.relocate ? new Date(tenant.relocate) : null;
            let nextRevisionDate = 'N/A';
            
            if (relocateDate && !isNaN(relocateDate.getTime())) {
                const nextRevision = new Date(relocateDate);
                nextRevision.setFullYear(nextRevision.getFullYear() + 1);
                nextRevisionDate = nextRevision.toLocaleDateString('en-IN', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }

            const relocateDateFormatted = relocateDate && !isNaN(relocateDate.getTime()) 
                ? relocateDate.toLocaleDateString('en-IN', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })
                : 'N/A';

            const content = `
                <div class="space-y-5">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h4 class="font-bold text-blue-900 mb-2">Basic Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Tenant Name</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.tenant || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Room Number</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.name || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Room ID</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.roomId || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Contact</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.contact || 'N/A')}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <h4 class="font-bold text-green-900 mb-2">Financial Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Monthly Rent</p>
                                <p class="text-2xl font-bold text-green-700">₹${tenant.rent || 0}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Security Deposit</p>
                                <p class="text-lg font-bold text-green-700">₹${tenant.deposit || 0}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                        <h4 class="font-bold text-purple-900 mb-2">Utility Details</h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">EB Service No.</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.ebServNo || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">EB Account No.</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.ebAcNo || 'N/A')}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                        <h4 class="font-bold text-orange-900 mb-2">Tenancy Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Date of Relocation</p>
                                <p class="text-lg font-bold text-gray-800">${relocateDateFormatted}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Next Rent Revision</p>
                                <p class="text-lg font-bold text-orange-700">${nextRevisionDate}</p>
                                <p class="text-xs text-gray-600 mt-1">(After 1 year from relocation)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('tenant-modal-title').innerText = `${escapeHtml(tenant.tenant || 'Tenant')} - ${escapeHtml(tenant.name || 'Room')}`;
            document.getElementById('tenantDetailsModalContent').innerHTML = content;
            document.getElementById('tenantDetailsModal').classList.remove('hidden');
        };

        window.closeTenantDetailsModal = () => {
            document.getElementById('tenantDetailsModal').classList.add('hidden');
        };

        // RENT HISTORY LOGIC
        window.openHistory = (propId) => {
            currentLedgerPropId = propId;
            const prop = allPropertiesData.find(p => p.id === propId);
            document.getElementById('history-title').innerText = prop.name;
            document.getElementById('history-subtitle').innerText = `Rent: ₹${prop.rent}/month | Tenant: ${prop.tenant}`;
            document.getElementById('historyModal').classList.remove('hidden');
            window.renderLedger();
        };

        window.closeHistoryModal = () => {
            document.getElementById('historyModal').classList.add('hidden');
        };

        window.changeLedgerYear = (delta) => {
            currentLedgerYear += delta;
            window.renderLedger();
        };

        window.changeRentDetailsYear = (delta) => {
            currentRentDetailsYear += delta;
            window.renderRentDetailsTable();
            try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
        };

        window.renderLedger = () => {
            document.getElementById('ledger-year').innerText = currentLedgerYear;
            const grid = document.getElementById('ledger-grid');
            grid.innerHTML = '';
            
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const prop = allPropertiesData.find(p => p.id === currentLedgerPropId);
            const history = prop.paymentHistory || {}; 

            months.forEach(month => {
                const key = `${currentLedgerYear}-${month}`;
                const status = history[key] || 'None';
                
                let btnClass = "bg-gray-100 text-gray-500 hover:bg-gray-200";
                let icon = "";
                
                if (status === 'Pending') {
                    btnClass = "bg-red-100 text-red-600 border border-red-200 shadow-sm";
                    icon = '<i class="fa-solid fa-circle-exclamation mr-1"></i>';
                } else if (status === 'Paid') {
                    btnClass = "bg-green-100 text-green-700 border border-green-200 shadow-sm";
                    icon = '<i class="fa-solid fa-check mr-1"></i>';
                }

                const div = document.createElement('div');
                div.className = `month-box p-3 rounded-lg cursor-pointer text-center font-semibold text-sm select-none ${btnClass}`;
                div.innerHTML = `<div>${month}</div><div class="text-xs font-normal mt-1">${icon}${status === 'None' ? '-' : status}</div>`;
                div.onclick = () => window.togglePaymentStatus(key, status);
                grid.appendChild(div);
            });
        };

        window.togglePaymentStatus = async (key, currentStatus) => {
            let newStatus = 'Pending';
            if (currentStatus === 'Pending') newStatus = 'Paid';
            else if (currentStatus === 'Paid') newStatus = 'None';

            const propRef = doc(db, "properties", currentLedgerPropId);
            const updatePayload = {};
            
            if (newStatus === 'None') {
                updatePayload[`paymentHistory.${key}`] = null; 
            } else {
                updatePayload[`paymentHistory.${key}`] = newStatus;
            }

            try {
                await updateDoc(propRef, updatePayload);
            } catch (e) {
                console.error("Update failed", e);
                void window.uiAlert({
                    title: 'Update failed',
                    message: 'Could not update payment status. ' + (e?.message || ''),
                    danger: true,
                    okText: 'OK'
                });
            }
        };

        // CSV EXPORT
        window.exportToCSV = () => {
            if (allPropertiesData.length === 0) { showNotification("No data to export", "info"); return; }
            let csv = "Room,Tenant,Rent,Status,Payment Status\n";
            allPropertiesData.forEach(p => csv += `"${p.name}","${p.tenant}",${p.rent},${p.status},${p.payStatus}\n`);
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "rent_data.csv";
            link.click();
        };

        // UI HELPERS
        window.toggleModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal.classList.contains('hidden')) {
                modal.dataset.previousFocus = document.activeElement?.id || '';
                modal.classList.remove('hidden');
                modal.setAttribute('aria-hidden', 'false');
                const focusables = modal.querySelectorAll('input, select, textarea, button:not([disabled])');
                if (focusables.length) focusables[0].focus();
            } else {
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden', 'true');
                if (modal.dataset.previousFocus) {
                    const el = document.getElementById(modal.dataset.previousFocus);
                    if (el) el.focus();
                }
            }
        };
        
        window.toggleTenantInput = () => {
            const show = document.getElementById('propStatus').value === 'Occupied';
            document.getElementById('tenantInputGroup').classList.toggle('hidden', !show);
        };

        // ADD TENANT MODAL FUNCTIONS
        window.openAddTenantModal = (roomId = null) => {
            document.getElementById('addTenantModal').classList.remove('hidden');
            document.getElementById('addTenantForm').reset();

            const waterRateEl = document.getElementById('tenantWaterRate');
            const titleEl = document.getElementById('add-tenant-modal-title');
            const saveBtnEl = document.getElementById('saveTenantBtn');

            if (titleEl) titleEl.textContent = roomId ? 'Edit Tenant' : 'Add New Tenant';
            if (saveBtnEl) {
                saveBtnEl.innerHTML = `<i class="fa-solid fa-save mr-2"></i>${roomId ? 'Update Tenant' : 'Save Tenant'}`;
            }

            if (waterRateEl) waterRateEl.value = String(DEFAULT_WATER_RATE);
            
            // If roomId is provided, pre-select the room
            if (roomId) {
                const roomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(key => IMMUTABLE_ROOMS_DATA[key].roomId === roomId);
                if (roomNo) {
                    document.getElementById('roomSelector').value = roomNo;
                    window.prefillRoomDetails();

                    const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                    const existing = roomData ? findTenantForRoom(roomData) : null;

                    // Prefill all tenant fields so Edit Tenant doesn't require retyping everything
                    if (existing) {
                        const nameEl = document.getElementById('tenantNameInput');
                        const contactEl = document.getElementById('tenantContact');
                        const rentEl = document.getElementById('tenantRent');
                        const depositEl = document.getElementById('tenantDeposit');
                        const relocateEl = document.getElementById('tenantRelocateDate');
                        const lastRevEl = document.getElementById('tenantLastRevisionDate');

                        if (nameEl) nameEl.value = String(existing?.tenant || '').trim();
                        if (contactEl) contactEl.value = String(existing?.contact || '').trim();
                        if (rentEl) rentEl.value = existing?.rent !== null && existing?.rent !== undefined ? String(existing.rent) : '';
                        if (depositEl) depositEl.value = existing?.deposit !== null && existing?.deposit !== undefined ? String(existing.deposit) : '';

                        const relocateDate = parseDateValue(existing?.relocate);
                        if (relocateEl) relocateEl.value = relocateDate ? formatDateForInput(relocateDate) : '';

                        const lastRevDate = parseDateValue(existing?.lastRentRevisionAt);
                        if (lastRevEl) lastRevEl.value = lastRevDate ? formatDateForInput(lastRevDate) : '';

                        const existingRate = Number(existing?.waterRate);
                        if (waterRateEl) {
                            if (Number.isFinite(existingRate)) waterRateEl.value = String(existingRate);
                            else waterRateEl.value = String(getDefaultWaterRateForRoom(roomData?.roomNo));
                        }
                    } else if (waterRateEl) {
                        waterRateEl.value = String(getDefaultWaterRateForRoom(roomData?.roomNo));
                    }

                    // Enable save button if form is already valid
                    try { window.validateAddTenantForm(); } catch (e) { console.warn('⚠️ validateAddTenantForm failed:', e); }
                }
            }
        };

        window.closeAddTenantModal = () => {
            const modal = document.getElementById('addTenantModal');
            const form = document.getElementById('addTenantForm');
            const btn = document.getElementById('saveTenantBtn');
            
            if (modal) modal.classList.add('hidden');
            if (form) form.reset();
            if (btn) {
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        };

        // FORM VALIDATION FOR MANDATORY FIELDS
        window.validateAddTenantForm = () => {
            const roomSelectorEl = document.getElementById('roomSelector');
            const tenantNameEl = document.getElementById('tenantNameInput');
            const contactEl = document.getElementById('tenantContact');
            const rentEl = document.getElementById('tenantRent');
            const depositEl = document.getElementById('tenantDeposit');
            const relocateDateEl = document.getElementById('tenantRelocateDate');
            const saveBtnEl = document.getElementById('saveTenantBtn');
            
            if (!saveBtnEl) {
                console.warn("saveTenantBtn not found");
                return;
            }
            
            const roomSelector = roomSelectorEl?.value || '';
            const tenantName = tenantNameEl?.value.trim() || '';
            const contact = contactEl?.value.trim() || '';
            const rent = rentEl?.value || '';
            const deposit = depositEl?.value || '';
            const relocateDate = relocateDateEl?.value || '';

            const isValid = roomSelector && tenantName && contact && rent && deposit && relocateDate;
            
            if (isValid) {
                saveBtnEl.disabled = false;
                saveBtnEl.classList.remove('bg-gray-400', 'cursor-not-allowed');
                saveBtnEl.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                saveBtnEl.disabled = true;
                saveBtnEl.classList.add('bg-gray-400', 'cursor-not-allowed');
                saveBtnEl.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        };

        // ADD TENANT FORM HANDLER
        const addTenantForm = document.getElementById('addTenantForm');
        if (addTenantForm) {
            addTenantForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return showNotification("Please login first", "warning");

                const roomNo = document.getElementById('tenantRoomNo').value.trim();
                const roomId = document.getElementById('tenantRoomId').value.trim();
                const tenantName = document.getElementById('tenantNameInput').value.trim();
                const contact = document.getElementById('tenantContact').value.trim();
                const rent = parseFloat(document.getElementById('tenantRent').value);
                const waterRateInput = document.getElementById('tenantWaterRate')?.value;
                const parsedWaterRate = parseFloat(String(waterRateInput ?? '').trim());
                const waterRate = Number.isFinite(parsedWaterRate) ? parsedWaterRate : DEFAULT_WATER_RATE;
                const deposit = parseFloat(document.getElementById('tenantDeposit').value) || 0;
                const ebServNo = document.getElementById('tenantEbServNo').value.trim();
                const ebAcNo = document.getElementById('tenantEbAcNo').value.trim();
                const keyNo = document.getElementById('tenantKeyNo').value.trim();
                const relocate = document.getElementById('tenantRelocateDate').value;
                const lastRentRevisionAtInput = document.getElementById('tenantLastRevisionDate')?.value || '';
                let lastRentRevisionAt = String(lastRentRevisionAtInput).trim() ? String(lastRentRevisionAtInput).trim() : null;

                const existingForRoom = findTenantForRoom({ roomNo, roomId });

                // Check tenant count (unique rooms only). Allow edits even when full.
                let occupiedRoomsCount = 0;
                Object.keys(IMMUTABLE_ROOMS_DATA).forEach(no => {
                    const t = findTenantForRoom(IMMUTABLE_ROOMS_DATA[no]);
                    if (isOccupiedRecord(t)) occupiedRoomsCount++;
                });
                if (occupiedRoomsCount >= 12 && !isOccupiedRecord(existingForRoom)) {
                    showNotification("Maximum 12 tenants allowed. Please delete an existing tenant first.", "warning");
                    return;
                }

                if (!roomNo || !roomId || !tenantName || isNaN(rent)) {
                    showNotification("Please fill all required fields: Room No, Room ID, Tenant Name, Rent", "warning");
                    return;
                }

                if (!Number.isFinite(waterRate) || waterRate < 0) {
                    showNotification("Invalid water rate. Please enter a non-negative number.", "warning");
                    return;
                }

                try {
                    // Save to Firestore
                    // IMPORTANT: Prefer updating an existing room record to avoid duplicates
                    // (duplicates cause cards to sometimes match an older/vacant doc after re-login).
                    if (existingForRoom?.id) {
                        // If rent changed and user didn't explicitly set a revision date,
                        // auto-set last revision to today.
                        const prevRent = parseFloat(existingForRoom?.rent);
                        const newRent = parseFloat(rent);
                        const rentChanged = Number.isFinite(prevRent) && Number.isFinite(newRent) && Math.abs(prevRent - newRent) > 0.0001;
                        if (rentChanged && !lastRentRevisionAt) {
                            lastRentRevisionAt = formatDateForInput(new Date());
                        }

                        const updatePayload = {
                            name: roomNo,
                            roomId: roomId,
                            roomNo: roomNo,
                            tenant: tenantName,
                            rent: rent,
                            waterRate: waterRate,
                            contact: contact,
                            deposit: deposit,
                            ebServNo: ebServNo,
                            ebAcNo: ebAcNo,
                            keyNo: keyNo,
                            relocate: relocate,
                            lastRentRevisionAt: lastRentRevisionAt,
                            status: 'Occupied',
                            payStatus: existingForRoom?.payStatus || 'Pending',
                            updatedAt: serverTimestamp(),
                            updatedBy: currentUser.uid,
                            paymentHistory: existingForRoom?.paymentHistory || {}
                        };

                        // Audit trail: capture previous (unrevised) rent whenever rent changes
                        if (rentChanged && Number.isFinite(prevRent)) {
                            updatePayload.unRevisedRent = prevRent;
                            updatePayload.unRevisedRentCapturedAt = serverTimestamp();
                        }
                        if (!existingForRoom?.createdAt) updatePayload.createdAt = serverTimestamp();
                        if (!existingForRoom?.createdBy) updatePayload.createdBy = currentUser.uid;

                        await updateDoc(doc(db, "properties", existingForRoom.id), updatePayload);
                        console.log("✓ Tenant updated successfully in Firestore");
                    } else {
                        await addDoc(collection(db, "properties"), {
                            name: roomNo,
                            roomId: roomId,
                            roomNo: roomNo,
                            tenant: tenantName,
                            rent: rent,
                            waterRate: waterRate,
                            contact: contact,
                            deposit: deposit,
                            ebServNo: ebServNo,
                            ebAcNo: ebAcNo,
                            keyNo: keyNo,
                            relocate: relocate,
                            lastRentRevisionAt: lastRentRevisionAt,
                            unRevisedRent: null,
                            unRevisedRentCapturedAt: null,
                            status: 'Occupied',
                            payStatus: 'Pending',
                            createdAt: serverTimestamp(),
                            createdBy: currentUser.uid,
                            paymentHistory: {}
                        });
                        console.log("✓ Tenant added successfully to Firestore");
                    }
                    
                    // Reset form
                    const formToReset = document.getElementById('addTenantForm');
                    if (formToReset) {
                        formToReset.reset();
                    }
                    
                    showNotification("✓ Tenant details saved successfully!", "success");
                    
                    // Close modal
                    window.closeAddTenantModal();
                    // Refresh views with delay to ensure Firestore data fully propagates
                    setTimeout(() => {
                        window.generateRoomCards();
                        window.renderRentDetailsTable();
                        window.updateOccupancyMetrics();
                        try { window.renderRentRevisionDueCard(); } catch (e) { console.warn("⚠️ renderRentRevisionDueCard failed:", e); }
                    }, 1500);
                } catch (err) {
                    console.error("❌ Add tenant failed", err);
                    showNotification("Error: " + err.message, "error");
                }
            });

            // Add event listeners to mandatory fields for form validation
            const roomSelector = document.getElementById('roomSelector');
            const tenantName = document.getElementById('tenantNameInput');
            const tenantContact = document.getElementById('tenantContact');
            const tenantRent = document.getElementById('tenantRent');
            const tenantDeposit = document.getElementById('tenantDeposit');
            const relocateDate = document.getElementById('tenantRelocateDate');
            
            if (roomSelector) roomSelector.addEventListener('change', window.validateAddTenantForm);
            if (tenantName) tenantName.addEventListener('input', window.validateAddTenantForm);
            if (tenantContact) tenantContact.addEventListener('input', window.validateAddTenantForm);
            if (tenantRent) tenantRent.addEventListener('input', window.validateAddTenantForm);
            if (tenantDeposit) tenantDeposit.addEventListener('input', window.validateAddTenantForm);
            if (relocateDate) relocateDate.addEventListener('change', window.validateAddTenantForm);
        }

        // ADD PROPERTY
        const formElement = document.getElementById('addPropertyForm');
        if (formElement) {
            formElement.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    void window.uiAlert({ title: 'Sign in required', message: 'Please sign in to save a room.', okText: 'OK' });
                    return;
                }
                
                const btnText = document.getElementById('btn-text');
                const btnLoader = document.getElementById('btn-loader');
                
                const name = document.getElementById('propName').value.trim();
                const rent = parseFloat(document.getElementById('propRent').value);
                const status = document.getElementById('propStatus').value;
                const payStatus = document.getElementById('payStatus').value;
                const tName = document.getElementById('tenantName').value.trim();
                const tenant = (status === 'Occupied' && tName) ? tName : (status === 'Occupied' ? 'Assigned' : 'None');

                if (!name) {
                    void window.uiAlert({ title: 'Missing room name', message: 'Please enter the room number / name.', okText: 'OK' });
                    return;
                }
                if (isNaN(rent) || rent <= 0) {
                    void window.uiAlert({ title: 'Invalid rent amount', message: 'Please enter a rent amount greater than 0.', okText: 'OK' });
                    return;
                }

                btnText.innerText = "Saving...";
                btnLoader.classList.remove('hidden');

                try {
                    await addDoc(collection(db, "properties"), {
                        name, rent, status, payStatus, tenant,
                        createdAt: serverTimestamp(),
                        createdBy: currentUser.uid,
                        paymentHistory: {} 
                    });
                    e.target.reset();
                    window.toggleModal('propertyModal');
                    window.toggleTenantInput();
                } catch (err) {
                    console.error("Add failed", err);
                    void window.uiAlert({
                        title: 'Could not save',
                        message: 'Error saving: ' + (err?.message || 'Unknown error'),
                        danger: true,
                        okText: 'OK'
                    });
                } finally {
                    btnText.innerText = "Save Room";
                    btnLoader.classList.add('hidden');
                }
            });
        } else {
            console.warn('addPropertyForm element not found');
        }

        window.deleteProperty = async (id) => {
            if (!currentUser) {
                void window.uiAlert({ title: 'Sign in required', message: 'Please sign in to delete a record.', okText: 'OK' });
                return;
            }
            const ok = await window.uiConfirm({
                title: 'Delete this property?',
                message: 'This will permanently delete the record from the database.',
                confirmText: 'Delete',
                cancelText: 'Cancel',
                danger: true
            });
            if (ok) {
                try {
                    await deleteDoc(doc(db, "properties", id));
                } catch (error) {
                    console.error("Error deleting: ", error);
                    void window.uiAlert({
                        title: 'Delete failed',
                        message: 'Failed to delete: ' + (error?.message || 'Unknown error'),
                        danger: true,
                        okText: 'OK'
                    });
                }
            }
        };

        // SAVE DASHBOARD ROW (Persist room metadata to Firestore) and sync to properties
        window.saveDashboardRow = async (rowIndex) => {
            if (!currentUser) {
                void window.uiAlert({ title: 'Sign in required', message: 'Please sign in first.', okText: 'OK' });
                return;
            }

            // Read values from the input fields
            const roomNo = document.getElementById(`row-${rowIndex}-roomNo`).value.trim();
            const roomId = document.getElementById(`row-${rowIndex}-roomId`).value.trim();
            const keyNo = document.getElementById(`row-${rowIndex}-keyNo`).value.trim();
            const ebServNo = document.getElementById(`row-${rowIndex}-ebServNo`).value.trim();
            const ebAcNo = document.getElementById(`row-${rowIndex}-ebAcNo`).value.trim();
            const tenantName = document.getElementById(`row-${rowIndex}-tenantName`).value.trim();
            const rent = document.getElementById(`row-${rowIndex}-rent`).value ? parseFloat(document.getElementById(`row-${rowIndex}-rent`).value) : 0;
            const contact = document.getElementById(`row-${rowIndex}-contact`).value.trim();
            const deposit = document.getElementById(`row-${rowIndex}-deposit`).value ? parseFloat(document.getElementById(`row-${rowIndex}-deposit`).value) : 0;
            const relocate = document.getElementById(`row-${rowIndex}-relocate`).value;

            // Validate: Room ID and Room No must be present
            if (!roomId) {
                void window.uiAlert({ title: 'Missing Room ID', message: 'Please enter a Room ID before saving.', okText: 'OK' });
                return;
            }
            if (!roomNo) {
                void window.uiAlert({ title: 'Missing Room No', message: 'Please enter a Room No before saving.', okText: 'OK' });
                return;
            }

            // Prepare room metadata document
            const roomMetadata = {
                roomNo,
                roomId,
                keyNo,
                ebServNo,
                ebAcNo,
                tenantName,
                rent,
                contact,
                deposit,
                relocate,
                updatedAt: serverTimestamp(),
                updatedBy: currentUser.uid
            };

            try {
                // Store/update in the "rooms" collection keyed by roomId
                const { setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const roomRef = doc(db, "rooms", roomId);
                await setDoc(roomRef, roomMetadata, { merge: true });

                // Attempt to sync into the main "properties" collection when a matching property exists
                const matched = allPropertiesData.find(p => (p.roomId === roomId) || (p.id === roomId) || (p.name === roomNo));
                if (matched) {
                    try {
                        const propRef = doc(db, "properties", matched.id);
                        await updateDoc(propRef, {
                            tenant: tenantName || matched.tenant || 'None',
                            rent: rent || matched.rent || 0,
                            contact: contact || matched.contact || '',
                            deposit: deposit || matched.deposit || 0,
                            roomNo,
                            roomId,
                            updatedAt: serverTimestamp(),
                            updatedBy: currentUser.uid
                        });
                        console.log(`✓ Synced room metadata to property ${matched.id}`);
                    } catch (syncErr) {
                        console.warn("⚠️ Failed to sync to properties collection:", syncErr);
                    }
                }

                void window.uiAlert({ title: 'Saved', message: `Room ${roomId} saved successfully.`, okText: 'OK' });
                console.log(`✓ Saved dashboard row ${rowIndex} with roomId: ${roomId}`);

                // Refresh views
                window.applyFilters();
            } catch (error) {
                console.error("Save failed:", error);
                void window.uiAlert({
                    title: 'Save failed',
                    message: `Failed to save room: ${error?.message || 'Unknown error'}`,
                    danger: true,
                    okText: 'OK'
                });
            }
        };

        // RENDER HELPERS
        function escapeHtml(text) { 
            return (text || "").toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderProperties(list) {
            const grid = document.getElementById('property-grid');
            if (!grid) return;
            if (!list.length) {
                grid.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">No properties found.</p>';
                return;
            }

            grid.innerHTML = list.map(p => {
                const history = p.paymentHistory || {};
                const currentMonthKey = `${new Date().getFullYear()}-${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][new Date().getMonth()]}`;
                
                let displayStatus = p.payStatus;
                if (history[currentMonthKey]) {
                    displayStatus = history[currentMonthKey];
                }

                let statusBadge = displayStatus === 'Paid' ? '<span class="text-green-600 font-bold text-xs"><i class="fa-solid fa-check-circle"></i> Paid</span>' 
                                : displayStatus === 'Pending' ? '<span class="text-red-600 font-bold text-xs"><i class="fa-solid fa-circle-exclamation"></i> Pending</span>'
                                : '<span class="text-gray-400 text-xs">No status</span>';

                const rentNum = Number(p?.rent ?? 0);
                const rentText = Number.isFinite(rentNum) ? rentNum.toLocaleString() : '0';

                return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition p-5 border-t-4 ${p.status === 'Occupied' ? 'border-blue-500' : 'border-gray-300'}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">${escapeHtml(p.name)}</h3>
                        <span class="px-2 py-1 rounded text-xs font-semibold ${p.status === 'Occupied' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-600'}">${escapeHtml(p.status)}</span>
                    </div>
                    <p class="text-gray-500 text-sm mb-4"><i class="fa-solid fa-user mr-1"></i> ${escapeHtml(p.tenant)}</p>
                    
                    <div class="bg-gray-50 p-3 rounded mb-4 flex justify-between items-center">
                        <span class="font-bold text-gray-700">₹${rentText}</span>
                        ${statusBadge}
                    </div>

                    <div class="flex gap-2">
                        <button onclick="window.openHistory('${p.id}')" class="flex-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 py-2 rounded text-sm font-medium transition">
                            <i class="fa-solid fa-calendar-days mr-1"></i> Manage Rent
                        </button>
                        <button onclick="window.deleteProperty('${p.id}')" class="px-3 text-gray-400 hover:text-red-500 transition">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTenants(list) {
            const tbody = document.getElementById('tenant-list');
            if (!tbody) return; // Element doesn't exist (removed from DOM)
            const occupied = list.filter(p => p.status === 'Occupied');
            if(!occupied.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No tenants.</td></tr>'; return; }
            
            tbody.innerHTML = occupied.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-6">${escapeHtml(p.name)}</td>
                    <td class="py-3 px-6 font-medium">${escapeHtml(p.tenant)}</td>
                    <td class="py-3 px-6 text-center">₹${p.rent.toLocaleString()}</td>
                    <td class="py-3 px-6 text-center text-xs text-gray-500">${escapeHtml(p.payStatus)}</td>
                </tr>
            `).join('');
        }

        function updateStats(list) {
            const totalPropsEl = document.getElementById('total-properties');
            if (totalPropsEl) totalPropsEl.innerText = list.length;

            const totalTenantsEl = document.getElementById('total-tenants');
            if (totalTenantsEl) totalTenantsEl.innerText = list.filter(p => p.status === 'Occupied').length;
            
            const now = new Date();
            const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const prev = getPrevYearMonth(now.getFullYear(), now.getMonth());
            const targetMonthKey = `${prev.year}-${monthNames[prev.monthIndex]}`;

            let totalPending = 0;
            list.forEach(p => {
                const history = p?.paymentHistory || {};
                const status = history[targetMonthKey] || p?.payStatus || 'None';
                if (status === 'Pending') {
                    totalPending += (Number(p?.rent) || 0);
                }
            });
            const pendingRentEl = document.getElementById('pending-rent');
            if (pendingRentEl) pendingRentEl.innerText = '₹' + totalPending.toLocaleString();
        }

        // RENT DETAILS TABLE - Populate with 12 immutable rooms and tenant data
        window.renderRentDetailsTable = function() {
            const tbody = document.getElementById('rentDetailsBody');
            if (!tbody) return;
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const selectedYear = (typeof currentRentDetailsYear === 'number' && Number.isFinite(currentRentDetailsYear))
                ? currentRentDetailsYear
                : new Date().getFullYear();

            const yearLabel = document.getElementById('rent-details-year');
            if (yearLabel) yearLabel.innerText = String(selectedYear);

            // Use immutable rooms data as base
            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            
            if (roomNos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center py-10 text-gray-400">No room data found.</td></tr>';
                return;
            }

            // Build table rows using immutable rooms + tenant data
            tbody.innerHTML = roomNos.map(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);
                const occupied = isOccupiedRecord(tenantData);

                const tenantName = occupied ? (tenantData?.tenant || 'No Tenant') : 'No Tenant';
                const history = tenantData?.paymentHistory || {};
                const rowClass = occupied ? 'hover:bg-gray-50 border-b' : 'bg-gray-50 border-b';
                
                let row = `
                    <tr class="${rowClass}" data-room-id="${escapeHtml(roomData.roomId)}" data-room-no-key="${escapeHtml(roomNo)}">
                        <td class="border px-4 py-3 font-semibold text-blue-600 bg-white min-w-[6rem]">${escapeHtml(roomData.roomId)}</td>
                        <td class="border px-4 py-3 font-semibold bg-white min-w-[6rem]">${escapeHtml(roomData.roomNo)}</td>
                        <td class="border px-4 py-3 font-semibold text-gray-800 text-sm bg-white min-w-[10rem]">${escapeHtml(tenantName)}</td>
                `;

                const now = new Date();
                months.forEach((month, monthIndex) => {
                    const key = `${selectedYear}-${month}`;
                    const status = history[key] || 'None';

                    const isFuture = isFutureYearMonth(selectedYear, monthIndex, now);
                    
                    // Base styling:
                    // - Occupied + editable month: white + clickable (even if status is None)
                    // - Vacant OR locked month: greyed out
                    let cellClass = occupied
                        ? "bg-white text-gray-700 border-gray-300 cursor-pointer hover:bg-gray-50"
                        : "bg-gray-100 text-gray-600 border-gray-300 cursor-not-allowed";
                    let displayText = "-";
                    let icon = "";
                    
                    // Only show payment statuses if tenant status is 'Occupied'
                    if (occupied) {
                        if (status === 'Pending') {
                            cellClass = "bg-red-100 text-red-700 border-red-300 cursor-pointer hover:bg-red-200";
                            displayText = "✗";
                            icon = '<i class="fa-solid fa-xmark text-red-600"></i>';
                        } else if (status === 'Rent Only') {
                            cellClass = "bg-purple-100 text-purple-700 border-purple-300 cursor-pointer hover:bg-purple-200";
                            displayText = "✓";
                            icon = '<i class="fa-solid fa-check text-purple-600"></i>';
                        } else if (status === 'Paid') {
                            cellClass = "bg-green-100 text-green-700 border-green-300 cursor-pointer hover:bg-green-200";
                            displayText = "✓";
                            icon = '<i class="fa-solid fa-check text-green-600"></i>';
                        } else {
                            // None status (editable past months): keep white/clickable base styling
                            cellClass = "bg-white text-gray-700 border-gray-300 cursor-pointer hover:bg-gray-50";
                            displayText = "-";
                            icon = "";
                        }
                    }

                    // Only allow clicking if tenant is occupied and month is not in the future
                    const clickHandler = (occupied && !isFuture)
                        ? `onclick="window.toggleMonthStatus('${roomData.roomId}', '${key}', '${status}')"`
                        : '';

                    if (occupied && isFuture) {
                        cellClass = "bg-gray-100 text-gray-500 border-gray-300 cursor-not-allowed";
                        displayText = "-";
                        icon = "";
                    }
                    
                    row += `
                        <td class="border px-4 py-3 text-center font-bold ${cellClass}" 
                            ${clickHandler}
                            title="${occupied ? (isFuture ? 'Locked month (current/future) — disabled until next month' : 'Click to toggle: ' + status) : 'Vacant - No tenant'}">
                            ${icon || displayText}
                        </td>
                    `;
                });

                row += `</tr>`;
                return row;
            }).filter(row => row !== '').join('');
        };

        // RENT & WATER TABLE - Paid/None view with total saved as Rent + Water + 60
        window.renderRentWaterTable = function() {
            const tbody = document.getElementById('rentWaterBody');
            if (!tbody) return;

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const selectedYear = (typeof currentRentDetailsYear === 'number' && Number.isFinite(currentRentDetailsYear))
                ? currentRentDetailsYear
                : new Date().getFullYear();

            const now = new Date();

            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            if (roomNos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center py-10 text-gray-400">No room data found.</td></tr>';
                return;
            }

            tbody.innerHTML = roomNos.map(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);
                const occupied = isOccupiedRecord(tenantData);

                const tenantName = occupied ? (tenantData?.tenant || 'No Tenant') : 'No Tenant';
                const history = tenantData?.paymentHistory || {};
                const rowClass = occupied ? 'hover:bg-gray-50 border-b' : 'bg-gray-50 border-b';

                let row = `
                    <tr class="${rowClass}">
                        <td class="border px-4 py-3 font-semibold text-blue-600 bg-white min-w-[6rem]">${escapeHtml(roomData.roomId)}</td>
                        <td class="border px-4 py-3 font-semibold bg-white min-w-[6rem]">${escapeHtml(roomData.roomNo)}</td>
                        <td class="border px-4 py-3 font-semibold text-gray-800 text-sm bg-white min-w-[10rem]">${escapeHtml(tenantName)}</td>
                `;

                months.forEach((month, monthIndex) => {
                    const key = `${selectedYear}-${month}`;
                    const status = history[key] || 'None';

                    const locked = isFutureYearMonth(selectedYear, monthIndex, now);

                    const totals = tenantData?.paymentTotals || {};
                    const storedTotal = Number(totals?.[key]);

                    const rentOnlyAmount = Number(tenantData?.rent);

                    let cellClass = occupied
                        ? "bg-gray-100 text-gray-700 border-gray-300"
                        : "bg-gray-100 text-gray-600 border-gray-300";
                    let displayText = "-";
                    let title = occupied ? 'Calculated from Rent Details' : 'Vacant - No tenant';

                    // Post-paid model: current & future months are locked.
                    // Hide any previously saved values (to avoid confusion) and grey them out.
                    if (locked) {
                        cellClass = "bg-gray-200 text-gray-400 border-gray-300";
                        displayText = "-";
                        title = 'Locked (available after month ends).';
                    }

                    if (!locked && occupied && status === 'Pending') {
                        cellClass = "bg-red-100 text-red-800 border-red-300";
                        displayText = "0";
                        title = 'Pending = 0';
                    }

                    if (!locked && occupied && status === 'Rent Only') {
                        cellClass = "bg-purple-100 text-purple-800 border-purple-300";
                        if (Number.isFinite(rentOnlyAmount) && rentOnlyAmount > 0) {
                            const asInt = Math.round(rentOnlyAmount);
                            const isWhole = Math.abs(rentOnlyAmount - asInt) < 0.0001;
                            displayText = isWhole ? String(asInt) : rentOnlyAmount.toFixed(2);
                            title = `Rent Only = ₹${rentOnlyAmount.toLocaleString('en-IN')}`;
                        } else {
                            displayText = "-";
                            title = 'Rent Only, but rent not available';
                        }
                    }

                    if (!locked && occupied && status === 'Paid') {
                        cellClass = "bg-green-100 text-green-800 border-green-300";
                        if (Number.isFinite(storedTotal)) {
                            // Display as plain number in cell (example: 5910)
                            const asInt = Math.round(storedTotal);
                            const isWhole = Math.abs(storedTotal - asInt) < 0.0001;
                            displayText = isWhole ? String(asInt) : storedTotal.toFixed(2);
                            title = `Paid (Rent + Water + ${RENT_WATER_SERVICE_CHARGE}) = ₹${storedTotal.toLocaleString('en-IN')}`;
                        } else {
                            displayText = "-";
                            title = 'Paid, but total not stored yet';
                        }
                    }

                    row += `
                        <td class="border px-4 py-3 text-center font-bold ${cellClass}" 
                            title="${escapeHtml(title)}">
                            ${displayText}
                        </td>
                    `;
                });

                row += `</tr>`;
                return row;
            }).join('');
        };

        window.toggleRentWaterPaid = async (roomId, key, currentStatus) => {
            // Toggle only Paid <-> None
            const makePaid = currentStatus !== 'Paid';

            const prop = allPropertiesData.find(p => (p.roomId === roomId) || (p.id === roomId));
            if (!prop) {
                showNotification('Property not found', 'error');
                return;
            }

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const parts = String(key || '').split('-');
            const year = Number(parts?.[0]);
            const monthLabel = parts?.[1];
            const monthIndex = months.indexOf(monthLabel);
            if (!Number.isFinite(year) || monthIndex < 0) {
                showNotification('Invalid month key', 'error');
                return;
            }

            if (isFutureYearMonth(year, monthIndex, new Date())) {
                showNotification('Current & future months are disabled (available after month ends).', 'warning');
                return;
            }

            const tenantData = pickBestRoomRecord(allPropertiesData.filter(p => p.id === prop.id)) || prop;
            const rent = Number(tenantData?.rent) || 0;
            const waterRate = (tenantData?.waterRate !== null && tenantData?.waterRate !== undefined && tenantData?.waterRate !== '')
                ? Number(tenantData?.waterRate)
                : getDefaultWaterRateForRoom(tenantData?.roomNo);
            const water = computeWaterForMonth(tenantData, year, monthIndex, waterRate);

            if (makePaid) {
                if (!Number.isFinite(water?.amount)) {
                    showNotification('Please enter water readings for this month AND previous month (Water Bill screen) before marking Paid.', 'warning');
                    return;
                }
                if (Number(water?.units) < 0) {
                    showNotification('Water units cannot be negative. Please check readings.', 'error');
                    return;
                }
            }

            const propRef = doc(db, "properties", prop.id);
            const updatePayload = {};

            if (!makePaid) {
                updatePayload[`paymentHistory.${key}`] = null;
                updatePayload[`paymentTotals.${key}`] = null;
            } else {
                const total = Math.round((rent + Number(water.amount) + RENT_WATER_SERVICE_CHARGE) * 100) / 100;
                updatePayload[`paymentHistory.${key}`] = 'Paid';
                updatePayload[`paymentTotals.${key}`] = total;
            }

            try {
                await updateDoc(propRef, updatePayload);
                console.log(`✓ Updated rent & water ${key} for room ${roomId} to ${makePaid ? 'Paid' : 'None'}`);
                showNotification(`✓ Rent & Water updated to ${makePaid ? 'Paid' : 'None'}`, 'success');
                window.renderRentDetailsTable();
                window.renderRentWaterTable();
                window.updateOccupancyMetrics();
            } catch (e) {
                console.error('Update failed', e);
                showNotification('Error: ' + e.message, 'error');
            }
        };

        window.toggleMonthStatus = async (roomId, key, currentStatus) => {
            let newStatus = 'Pending';
            if (currentStatus === 'Pending') newStatus = 'Rent Only';
            else if (currentStatus === 'Rent Only') newStatus = 'Paid';
            else if (currentStatus === 'Paid') newStatus = 'None';

            // Find property matching roomId and update
            const prop = allPropertiesData.find(p => (p.roomId === roomId) || (p.id === roomId));
            if (!prop) {
                showNotification('Property not found', 'error');
                return;
            }

            const propRef = doc(db, "properties", prop.id);
            const updatePayload = {};

            // Keep the totals in sync:
            // - Only meaningful for 'Paid' (complete)
            // - Clear totals for other statuses
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const parts = String(key || '').split('-');
            const year = Number(parts?.[0]);
            const monthLabel = parts?.[1];
            const monthIndex = months.indexOf(monthLabel);

            if (Number.isFinite(year) && monthIndex >= 0) {
                if (isFutureYearMonth(year, monthIndex, new Date())) {
                    showNotification('Current & future months are disabled (available after month ends).', 'warning');
                    return;
                }
            }

            const rent = Number(prop?.rent) || 0;
            const waterRate = (prop?.waterRate !== null && prop?.waterRate !== undefined && String(prop?.waterRate).trim() !== '')
                ? Number(prop?.waterRate)
                : getDefaultWaterRateForRoom(prop?.roomNo);

            if (newStatus === 'Paid') {
                // Require water readings to compute total.
                if (!Number.isFinite(year) || monthIndex < 0) {
                    showNotification('Invalid month key', 'error');
                    return;
                }
                const water = computeWaterForMonth(prop, year, monthIndex, waterRate);
                if (!Number.isFinite(water?.amount)) {
                    showNotification('Please enter water readings for this month AND previous month (Water Bill screen) before marking Paid.', 'warning');
                    return;
                }
                if (Number(water?.units) < 0) {
                    showNotification('Water units cannot be negative. Please check readings.', 'error');
                    return;
                }
                const total = Math.round((rent + Number(water.amount) + RENT_WATER_SERVICE_CHARGE) * 100) / 100;
                updatePayload[`paymentHistory.${key}`] = 'Paid';
                updatePayload[`paymentTotals.${key}`] = total;
            } else if (newStatus === 'None') {
                updatePayload[`paymentHistory.${key}`] = null;
                updatePayload[`paymentTotals.${key}`] = null;
            } else {
                updatePayload[`paymentHistory.${key}`] = newStatus;
                updatePayload[`paymentTotals.${key}`] = null;
            }

            try {
                await updateDoc(propRef, updatePayload);
                console.log(`✓ Updated ${key} for room ${roomId} to ${newStatus}`);
                showNotification(`✓ Status updated to ${newStatus}`, "success");
                renderRentDetailsTable(); // Refresh the table
                try { window.renderRentWaterTable(); } catch (e) { console.warn("⚠️ renderRentWaterTable failed:", e); }
                try { window.updateOccupancyMetrics(); } catch (e) { console.warn("⚠️ updateOccupancyMetrics failed:", e); }
            } catch (e) {
                console.error("Update failed", e);
                showNotification("Error: " + e.message, "error");
            }
        };

        // WATER BILL (Meter reading → Units → Amount)
        window.changeWaterBillYear = (delta) => {
            const next = (Number(currentWaterBillYear) || new Date().getFullYear()) + (Number(delta) || 0);
            currentWaterBillYear = next;
            window.renderWaterBillTable();
        };

        function getWaterMonthKey(year, monthIndex) {
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            return `${year}-${months[monthIndex]}`;
        }

        function getPrevYearMonth(year, monthIndex) {
            if (monthIndex > 0) return { year, monthIndex: monthIndex - 1 };
            return { year: year - 1, monthIndex: 11 };
        }

        function computeWaterForMonth(tenantData, year, monthIndex, waterRate) {
            const readings = tenantData?.waterReadings || {};
            const resetMap = tenantData?.waterMeterReset || {};
            const currentKey = getWaterMonthKey(year, monthIndex);
            const prev = getPrevYearMonth(year, monthIndex);
            const prevKey = getWaterMonthKey(prev.year, prev.monthIndex);

            const currentReading = readings?.[currentKey];
            const prevReading = readings?.[prevKey];

            const hasCurrent = currentReading !== null && currentReading !== undefined && currentReading !== '';
            const hasPrev = prevReading !== null && prevReading !== undefined && prevReading !== '';

            const currentNum = hasCurrent ? Number(currentReading) : NaN;
            const prevNum = hasPrev ? Number(prevReading) : NaN;

            const isMeterReset = Boolean(resetMap?.[currentKey]);

            // If meter was replaced/reset this month, units are computed from 0 → current.
            if (isMeterReset) {
                if (!Number.isFinite(currentNum)) {
                    return { currentReading: null, units: null, amount: null, meterReset: true };
                }
                const units = currentNum * WATER_UNITS_MULTIPLIER;
                const rate = Number.isFinite(waterRate) ? waterRate : DEFAULT_WATER_RATE;
                const amount = Math.round(units * rate);
                return { currentReading: currentNum, units, amount, meterReset: true };
            }

            if (!Number.isFinite(currentNum) || !Number.isFinite(prevNum)) {
                return { currentReading: Number.isFinite(currentNum) ? currentNum : null, units: null, amount: null, meterReset: false };
            }

            const units = (currentNum - prevNum) * WATER_UNITS_MULTIPLIER;
            const rate = Number.isFinite(waterRate) ? waterRate : DEFAULT_WATER_RATE;
            const amount = Math.round(units * rate);
            return { currentReading: currentNum, units, amount, meterReset: false };
        }

        window.renderWaterBillTable = () => {
            const tbody = document.getElementById('waterBillBody');
            if (!tbody) return;

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const selectedYear = (typeof currentWaterBillYear === 'number' && Number.isFinite(currentWaterBillYear))
                ? currentWaterBillYear
                : new Date().getFullYear();

            const yearLabel = document.getElementById('water-bill-year');
            if (yearLabel) yearLabel.innerText = String(selectedYear);

            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            if (roomNos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center py-10 text-gray-400">No room data found.</td></tr>';
                return;
            }

            const now = new Date();
            tbody.innerHTML = roomNos.map(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);
                const occupied = isOccupiedRecord(tenantData);
                const tenantName = occupied ? (tenantData?.tenant || 'No Tenant') : 'No Tenant';
                const rowClass = occupied ? 'hover:bg-gray-50 border-b' : 'bg-gray-50 border-b';

                let row = `
                    <tr class="${rowClass}">
                        <td class="border px-4 py-3 font-semibold text-blue-600 bg-white min-w-[6rem]">${escapeHtml(roomData.roomId)}</td>
                        <td class="border px-4 py-3 font-semibold bg-white min-w-[6rem]">${escapeHtml(roomData.roomNo)}</td>
                        <td class="border px-4 py-3 font-semibold text-gray-800 text-sm bg-white min-w-[10rem]">${escapeHtml(tenantName)}</td>
                `;

                months.forEach((month, monthIndex) => {
                    const isFuture = isFutureYearMonth(selectedYear, monthIndex, now);
                    let cellClass = occupied
                        ? 'bg-white text-gray-700 border-gray-200 cursor-pointer hover:bg-gray-50'
                        : 'bg-gray-100 text-gray-500 border-gray-300 cursor-not-allowed';
                    let display = '-';
                    let title = occupied ? 'Click to add a meter reading' : 'Vacant — no tenant';

                    if (occupied) {
                        const key = getWaterMonthKey(selectedYear, monthIndex);
                        const rate = Number(tenantData?.waterRate);
                        const effectiveRate = Number.isFinite(rate) ? rate : DEFAULT_WATER_RATE;
                        const result = computeWaterForMonth(tenantData, selectedYear, monthIndex, effectiveRate);
                        const resetMap = tenantData?.waterMeterReset || {};
                        const isReset = Boolean(resetMap?.[key]);

                        if (result.units !== null && result.amount !== null) {
                            const unitsText = `${result.units}`;
                            const amountText = `₹${Math.round(Number(result.amount)).toLocaleString('en-IN')}`;
                            display = `
                                <div class="leading-tight">
                                    <div class="text-[13px] font-extrabold text-blue-700">${amountText}</div>
                                    <div class="text-[12px] font-semibold text-gray-700">Units: ${unitsText}</div>
                                    ${isReset ? '<div class="text-[11px] font-semibold text-gray-500">Reset</div>' : ''}
                                </div>
                            `;
                            title = `Units: ${unitsText} (×${WATER_UNITS_MULTIPLIER}) | Amount: ${amountText} | Rate: ${effectiveRate}/unit | Key: ${key}${isReset ? ' | Meter reset: yes' : ''}`;
                            if (result.units < 0) {
                                cellClass = 'bg-red-50 text-red-700 border-red-200 cursor-pointer hover:bg-red-100';
                                title = `⚠️ Reading decreased. Units: ${unitsText} (×${WATER_UNITS_MULTIPLIER}) | Rate: ${effectiveRate}/unit | Check readings | Key: ${key}`;
                            }
                        } else {
                            const savedReading = tenantData?.waterReadings?.[key];
                            const savedNum = Number(savedReading);
                            if (savedReading !== null && savedReading !== undefined && savedReading !== '' && Number.isFinite(savedNum)) {
                                display = `${savedNum}<div class="text-[11px] text-gray-500">reading</div>`;
                                title = `Saved reading: ${savedNum}. Rate: ${effectiveRate}/unit.${isReset ? ' Meter reset: yes (units = reading × 10).' : ' Add the previous month reading to calculate units.'}`;
                            } else {
                                display = '<span class="text-gray-400">—</span>';
                                title = `No reading for ${month} ${selectedYear}. Rate: ${effectiveRate}/unit. Click to add.`;
                            }
                        }
                    }

                    if (occupied && isFuture) {
                        cellClass = 'bg-gray-100 text-gray-500 border-gray-300 cursor-not-allowed';
                        display = '<span class="text-gray-400">—</span>';
                        title = `Locked month (current/future) — disabled until next month`;
                    }

                    const clickHandler = (occupied && !isFuture)
                        ? `onclick="window.setWaterReading('${roomData.roomId}', ${selectedYear}, ${monthIndex})"`
                        : '';
                    row += `
                        <td class="border px-3 py-2 text-center align-top ${cellClass}" ${clickHandler} title="${escapeHtml(title)}">
                            ${display}
                        </td>
                    `;
                });

                row += '</tr>';
                return row;
            }).join('');
        };

        window.setWaterReading = async (roomId, year, monthIndex) => {
            try {
                if (isFutureYearMonth(year, monthIndex, new Date())) {
                    showNotification('Current & future months are disabled (available after month ends).', 'warning');
                    return;
                }

                const immutableRoomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(
                    no => IMMUTABLE_ROOMS_DATA[no].roomId === roomId
                );
                const tenantRecord = immutableRoomNo
                    ? findTenantForRoom(IMMUTABLE_ROOMS_DATA[immutableRoomNo])
                    : pickBestRoomRecord(allPropertiesData.filter(p => String(p?.roomId || '').trim() === String(roomId || '').trim()));

                if (!tenantRecord || !isOccupiedRecord(tenantRecord)) {
                    showNotification('Cannot set reading: Tenant not found / room vacant', 'error');
                    return;
                }

                const key = getWaterMonthKey(year, monthIndex);
                const existing = tenantRecord?.waterReadings?.[key];
                const existingReset = Boolean((tenantRecord?.waterMeterReset || {})?.[key]);
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const monthLabel = months?.[monthIndex] ? `${months[monthIndex]} ${year}` : String(key);

                const prev = getPrevYearMonth(year, monthIndex);
                const prevKey = getWaterMonthKey(prev.year, prev.monthIndex);
                const prevReadingRaw = tenantRecord?.waterReadings?.[prevKey];
                const prevReadingNum = (prevReadingRaw !== null && prevReadingRaw !== undefined && prevReadingRaw !== '')
                    ? Number(prevReadingRaw)
                    : NaN;
                const prevLabel = months?.[prev.monthIndex] ? `${months[prev.monthIndex]} ${prev.year}` : String(prevKey);
                const prevDisplay = Number.isFinite(prevReadingNum) ? String(prevReadingNum) : 'Not set';

                while (true) {
                    const input = await window.uiPrompt({
                        title: 'Water meter reading',
                        subtitle: `Room ${roomId} • ${monthLabel}`,
                        infoRows: [
                            { label: `Previous month reading (${prevLabel})`, value: prevDisplay },
                            { label: 'Units multiplier', value: `×${WATER_UNITS_MULTIPLIER}` },
                            { label: 'Meter reset this month', value: existingReset ? 'Yes' : 'No' }
                        ],
                        label: 'Enter the current meter reading',
                        placeholder: 'e.g. 1234',
                        value: (existing ?? '').toString(),
                        inputType: 'number',
                        inputMode: 'numeric',
                        extraButtonText: 'WhatsApp',
                        extraButtonClass: 'bg-green-600 hover:bg-green-700 text-white font-semibold',
                        onExtra: async (currentValue) => {
                            const contactRaw = tenantRecord?.contact;
                            if (!contactRaw || String(contactRaw).trim() === '') {
                                showNotification('No tenant contact number saved for this room.', 'warning');
                                return;
                            }

                            const readingNum = Number(String(currentValue || '').trim());
                            if (!Number.isFinite(readingNum) || readingNum < 0) {
                                showNotification('Enter a valid non-negative reading first.', 'warning');
                                return;
                            }

                            const rate = (tenantRecord?.waterRate !== null && tenantRecord?.waterRate !== undefined && String(tenantRecord?.waterRate).trim() !== '')
                                ? Number(tenantRecord?.waterRate)
                                : getDefaultWaterRateForRoom(tenantRecord?.roomNo);
                            const effectiveRate = Number.isFinite(rate) ? rate : DEFAULT_WATER_RATE;

                            let units = null;
                            if (existingReset) {
                                units = readingNum * WATER_UNITS_MULTIPLIER;
                            } else if (Number.isFinite(prevReadingNum)) {
                                units = (readingNum - prevReadingNum) * WATER_UNITS_MULTIPLIER;
                            }

                            if (!Number.isFinite(units)) {
                                showNotification('Previous month reading is missing; cannot calculate units.', 'warning');
                                return;
                            }
                            if (units < 0) {
                                showNotification('Units are negative; please check readings.', 'warning');
                                return;
                            }

                            const amount = Math.round(units * effectiveRate);
                            const roomNoText = tenantRecord?.roomNo ? String(tenantRecord.roomNo) : String(roomId);
                            const msg = `Room ${roomNoText}, Water Bill ${monthLabel}: Units ${units}, Amount ₹${amount}`;

                            openWhatsAppWebChat(contactRaw, msg);
                        },
                        okText: 'Save',
                        cancelText: 'Cancel'
                    });
                    if (input === null) return;

                    const value = Number(String(input).trim());
                    if (!Number.isFinite(value) || value < 0) {
                        showNotification('Invalid reading. Please enter a non-negative number.', 'warning');
                        continue;
                    }

                    let resetFlagToSave = existingReset;
                    if (existingReset) {
                        const keep = await window.uiConfirm({
                            title: 'Meter reset flag',
                            message: 'This month is currently marked as “meter replaced/reset”. Keep this setting?',
                            confirmText: 'Keep Reset',
                            cancelText: 'Remove Reset',
                            danger: false
                        });
                        resetFlagToSave = Boolean(keep);
                    }

                    if (Number.isFinite(prevReadingNum) && value < prevReadingNum) {
                        const isReplacement = await window.uiConfirm({
                            title: 'Reading is lower than last month',
                            message: `Previous (${prevLabel}) = ${prevReadingNum}. You entered ${value}.\n\nIf the water meter was replaced and restarted from 0, choose “Meter Replaced” (units will be calculated from 0 → current for this month).`,
                            confirmText: 'Meter Replaced',
                            cancelText: 'Not replaced',
                            danger: false
                        });
                        if (isReplacement) {
                            resetFlagToSave = true;
                        } else {
                            const ok = await window.uiConfirm({
                                title: 'Save decreased reading?',
                                message: 'This will result in negative units for this month. Save anyway?',
                                confirmText: 'Save Anyway',
                                cancelText: 'Re-enter',
                                danger: true
                            });
                            if (!ok) continue;
                        }
                    }

                    const ref = doc(db, 'properties', tenantRecord.id);
                    await updateDoc(ref, {
                        [`waterReadings.${key}`]: value,
                        [`waterMeterReset.${key}`]: resetFlagToSave
                    });
                    showNotification('✓ Water reading saved', 'success');
                    window.renderWaterBillTable();
                    return;
                }
            } catch (e) {
                console.error('setWaterReading failed', e);
                showNotification('Error: ' + e.message, 'error');
            }
        };

        // Reset water rates to defaults (0.25 or 0.20 for rooms 11–13)
        window.resetWaterRatesToDefault = async () => {
            const ok = await window.uiConfirm({
                title: 'Reset water rate defaults',
                message: 'This will set water rate to 0.25 for all rooms, and 0.20 for rooms 11–13. Continue?',
                confirmText: 'Reset',
                cancelText: 'Cancel',
                danger: false
            });
            if (!ok) return;

            let updated = 0;
            let skipped = 0;
            let failed = 0;

            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            for (const roomNo of roomNos) {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = findTenantForRoom(roomData);
                if (!tenantData || !tenantData?.id) { skipped++; continue; }

                const defaultRate = getDefaultWaterRateForRoom(roomData.roomNo);
                try {
                    await updateDoc(doc(db, 'properties', tenantData.id), { waterRate: defaultRate });
                    updated++;
                } catch (e) {
                    console.warn('resetWaterRatesToDefault failed for', roomData?.roomId, e);
                    failed++;
                }
            }

            showNotification(`✓ Water rates reset. Updated: ${updated}, Skipped: ${skipped}, Failed: ${failed}`, failed ? 'warning' : 'success');
            try { window.renderWaterBillTable(); } catch {}
        };

        function normalizeWhatsAppToDigits(contactRaw) {
            const raw = String(contactRaw || '').trim();
            if (!raw) return null;

            let digits = raw.replace(/\D+/g, '');
            if (!digits) return null;

            // Heuristic defaults for India numbers if stored without country code.
            if (digits.length === 10) digits = `91${digits}`;
            else if (digits.length === 11 && digits.startsWith('0')) digits = `91${digits.slice(1)}`;

            if (digits.length < 10) return null;
            return digits;
        }

        function openWhatsAppWebChat(toDigits, message) {
            const to = normalizeWhatsAppToDigits(toDigits);
            const body = String(message || '').trim();
            if (!to) {
                showNotification('Invalid WhatsApp number', 'warning');
                return false;
            }
            if (!body) {
                showNotification('Message is empty', 'warning');
                return false;
            }

            const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(to)}&text=${encodeURIComponent(body)}&type=phone_number&app_absent=0`;
            const win = window.open(url, '_blank', 'noopener,noreferrer');
            if (!win) {
                showNotification('Pop-up blocked. Allow pop-ups to open WhatsApp Web.', 'warning');
                return false;
            }
            return true;
        }

        // Import readings from pasted Excel/CSV
        window.openWaterImportModal = () => {
            const el = document.getElementById('waterImportModal');
            if (!el) return;
            el.classList.remove('hidden');
            el.classList.add('flex');
            el.setAttribute('aria-hidden', 'false');
            setTimeout(() => {
                try { document.getElementById('waterImportText')?.focus(); } catch {}
            }, 50);
        };

        window.closeWaterImportModal = () => {
            const el = document.getElementById('waterImportModal');
            if (!el) return;
            el.classList.add('hidden');
            el.classList.remove('flex');
            el.setAttribute('aria-hidden', 'true');
        };

        function parseMonthIndex(monthRaw) {
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const m = String(monthRaw || '').trim();
            if (!m) return null;
            const asNum = Number(m);
            if (Number.isFinite(asNum) && asNum >= 1 && asNum <= 12) return asNum - 1;
            const abbr = m.slice(0, 3).toLowerCase();
            const idx = months.findIndex(x => x.toLowerCase() === abbr);
            return idx >= 0 ? idx : null;
        }

        function resolveRoomData(roomToken) {
            const token = String(roomToken || '').trim();
            if (!token) return null;
            // Match by roomNo
            const normalizedRoomNo = token.padStart(2, '0');
            if (IMMUTABLE_ROOMS_DATA[normalizedRoomNo]) return IMMUTABLE_ROOMS_DATA[normalizedRoomNo];
            // Match by roomId
            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA);
            const matchNo = roomNos.find(no => String(IMMUTABLE_ROOMS_DATA[no]?.roomId || '').trim().toLowerCase() === token.toLowerCase());
            return matchNo ? IMMUTABLE_ROOMS_DATA[matchNo] : null;
        }

        window.runWaterImport = async () => {
            const text = String(document.getElementById('waterImportText')?.value || '').trim();
            if (!text) {
                await window.uiAlert('Paste some rows first.');
                return;
            }

            const ok = await window.uiConfirm({
                title: 'Import water readings',
                message: 'This will write readings into Firestore for matching rooms/months. Continue?',
                confirmText: 'Import',
                cancelText: 'Cancel'
            });
            if (!ok) return;

            const rawLines = text.split(/\r?\n/);
            const lines = rawLines.map(l => String(l || '').trim()).filter(Boolean);
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

            const fallbackYear = (typeof currentWaterBillYear === 'number' && Number.isFinite(currentWaterBillYear))
                ? currentWaterBillYear
                : new Date().getFullYear();

            function normalizeHeader(s) {
                return String(s || '').trim().toLowerCase().replace(/\s+/g, ' ');
            }

            function tryParseMonthHeader(cell) {
                const raw0 = String(cell || '').trim();
                if (!raw0) return null;

                // Excel sometimes adds non-breaking spaces / superscripts / stray symbols in copied headers
                const raw = raw0
                    .replace(/\u00A0/g, ' ')
                    .replace(/[^A-Za-z0-9\s\/-]/g, '')
                    .trim();
                if (!raw) return null;

                // Support: 2025-Apr, 2025 Apr, Apr-2025, April 2025
                const m1 = raw.match(/^(\d{4})\s*[-/ ]\s*([A-Za-z]{3,})$/);
                if (m1) {
                    const year = Number(m1[1]);
                    const monthIndex = parseMonthIndex(m1[2]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }
                const m2 = raw.match(/^([A-Za-z]{3,})\s*[-/ ]\s*(\d{4})$/);
                if (m2) {
                    const year = Number(m2[2]);
                    const monthIndex = parseMonthIndex(m2[1]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }
                const m3 = raw.match(/^([A-Za-z]{3,})\s+(\d{4})$/);
                if (m3) {
                    const year = Number(m3[2]);
                    const monthIndex = parseMonthIndex(m3[1]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }

                // Support 2-digit year forms: Apr-24, Apr 24, 04/24, 24-Apr
                const m4 = raw.match(/^([A-Za-z]{3,}|\d{1,2})\s*[-/ ]\s*(\d{2})$/);
                if (m4) {
                    const yy = Number(m4[2]);
                    const year = Number.isFinite(yy) ? (yy >= 0 && yy <= 69 ? 2000 + yy : 1900 + yy) : NaN;
                    const monthIndex = parseMonthIndex(m4[1]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }
                // Tolerate a stray trailing digit after 2-digit year (e.g., May-241)
                const m4b = raw.match(/^([A-Za-z]{3,}|\d{1,2})\s*[-/ ]\s*(\d{2})\d$/);
                if (m4b) {
                    const yy = Number(m4b[2]);
                    const year = Number.isFinite(yy) ? (yy >= 0 && yy <= 69 ? 2000 + yy : 1900 + yy) : NaN;
                    const monthIndex = parseMonthIndex(m4b[1]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }
                const m5 = raw.match(/^(\d{2})\s*[-/ ]\s*([A-Za-z]{3,}|\d{1,2})$/);
                if (m5) {
                    const yy = Number(m5[1]);
                    const year = Number.isFinite(yy) ? (yy >= 0 && yy <= 69 ? 2000 + yy : 1900 + yy) : NaN;
                    const monthIndex = parseMonthIndex(m5[2]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }

                // Support numeric month with 4-digit year: 04/2024, 4-2024, 2024/04
                const m6 = raw.match(/^(\d{1,2})\s*[-/ ]\s*(\d{4})$/);
                if (m6) {
                    const monthIndex = parseMonthIndex(m6[1]);
                    const year = Number(m6[2]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }
                const m7 = raw.match(/^(\d{4})\s*[-/ ]\s*(\d{1,2})$/);
                if (m7) {
                    const year = Number(m7[1]);
                    const monthIndex = parseMonthIndex(m7[2]);
                    if (Number.isFinite(year) && monthIndex !== null) return { year, monthIndex };
                }

                // Support: Apr / April (no year) -> use fallbackYear
                const monthIndex = parseMonthIndex(raw);
                if (monthIndex !== null) return { year: fallbackYear, monthIndex };
                return null;
            }

            function looksLikeExcelTable(linesArr) {
                if (!linesArr?.length) return false;
                const first = linesArr[0];
                if (!first.includes('\t')) return false;
                const headerCells = first.split('\t').map(s => String(s || '').trim());
                const hasRoom = headerCells.some(c => normalizeHeader(c) === 'room no' || normalizeHeader(c) === 'room id');
                const monthCols = headerCells.filter(c => !!tryParseMonthHeader(c));
                return hasRoom && monthCols.length >= 1;
            }

            let imported = 0;
            let skipped = 0;
            let failed = 0;

            if (looksLikeExcelTable(lines)) {
                // Excel table format (tab-separated): Room No | Room ID | Tenant Name | Apr | May | ...
                const grid = lines.map(l => l.split('\t').map(c => String(c ?? '').trim()));
                const header = grid[0] || [];
                const headerNorm = header.map(normalizeHeader);

                const roomNoCol = headerNorm.findIndex(h => h === 'room no' || h === 'roomno' || h === 'room');
                const roomIdCol = headerNorm.findIndex(h => h === 'room id' || h === 'roomid' || h === 'roomid ');
                const roomTokenCol = roomNoCol >= 0 ? roomNoCol : (roomIdCol >= 0 ? roomIdCol : 0);

                const monthColumns = [];
                for (let colIdx = 0; colIdx < header.length; colIdx++) {
                    const parsed = tryParseMonthHeader(header[colIdx]);
                    if (parsed) monthColumns.push({ colIdx, year: parsed.year, monthIndex: parsed.monthIndex });
                }
                if (!monthColumns.length) {
                    await window.uiAlert('No month columns found in the header row.');
                    return;
                }

                for (let r = 1; r < grid.length; r++) {
                    const row = grid[r] || [];
                    const roomToken = String(row[roomTokenCol] || '').trim();
                    if (!roomToken) { skipped++; continue; }

                    const roomData = resolveRoomData(roomToken);
                    if (!roomData) { skipped++; continue; }
                    const tenantData = findTenantForRoom(roomData);
                    if (!tenantData || !tenantData?.id) { skipped++; continue; }

                    for (const mc of monthColumns) {
                        const cell = String(row[mc.colIdx] ?? '').trim();
                        if (!cell) continue; // allow blanks

                        const reading = Number(cell);
                        if (!Number.isFinite(reading) || reading < 0) { skipped++; continue; }
                        if (isFutureYearMonth(mc.year, mc.monthIndex, new Date())) { skipped++; continue; }

                        const key = `${mc.year}-${months[mc.monthIndex]}`;
                        try {
                            await updateDoc(doc(db, 'properties', tenantData.id), { [`waterReadings.${key}`]: reading });
                            imported++;
                        } catch (e) {
                            console.warn('Water import failed for', roomData?.roomId, key, e);
                            failed++;
                        }
                    }
                }
            } else {
                // Row-per-line formats
                for (const line of lines) {
                    const parts = line.includes('\t') ? line.split('\t') : line.split(',');
                    const cols = parts.map(p => String(p).trim()).filter(p => p !== '');
                    if (cols.length < 3) { skipped++; continue; }

                    const roomToken = cols[0];
                    const roomData = resolveRoomData(roomToken);
                    if (!roomData) { skipped++; continue; }

                    let year = null;
                    let monthIndex = null;
                    let readingRaw = null;

                    // Format A: room, 2025-Jan, 1234
                    if (cols.length >= 3 && /^\d{4}-[A-Za-z]{3}$/.test(cols[1])) {
                        year = Number(cols[1].slice(0, 4));
                        monthIndex = parseMonthIndex(cols[1].slice(5));
                        readingRaw = cols[2];
                    } else if (cols.length >= 4 && /^\d{4}$/.test(cols[1])) {
                        // Format B: room, 2025, Jan, 1234
                        year = Number(cols[1]);
                        monthIndex = parseMonthIndex(cols[2]);
                        readingRaw = cols[3];
                    } else {
                        skipped++;
                        continue;
                    }

                    if (!Number.isFinite(year) || monthIndex === null) { skipped++; continue; }
                    const reading = Number(String(readingRaw || '').trim());
                    if (!Number.isFinite(reading) || reading < 0) { skipped++; continue; }

                    // Respect the existing future-month guard
                    if (isFutureYearMonth(year, monthIndex, new Date())) { skipped++; continue; }

                    const key = `${year}-${months[monthIndex]}`;
                    const tenantData = findTenantForRoom(roomData);
                    if (!tenantData || !tenantData?.id) { skipped++; continue; }

                    try {
                        await updateDoc(doc(db, 'properties', tenantData.id), { [`waterReadings.${key}`]: reading });
                        imported++;
                    } catch (e) {
                        console.warn('Water import failed for', roomData?.roomId, key, e);
                        failed++;
                    }
                }
            }

            await window.uiAlert(`Import finished. Imported: ${imported}. Skipped: ${skipped}. Failed: ${failed}.`);
            window.closeWaterImportModal();
            try { window.renderWaterBillTable(); } catch {}
        };

    </script>
</body>
</html>