<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent Management System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom smooth scrolling */
        html { scroll-behavior: smooth; }
        .hidden-section { display: none !important; }
        /* Section Tab Visibility */
        .section-tab { display: none !important; }
        .section-tab.active { display: block !important; }
        /* Ledger Grid Transition */
        .month-box { transition: all 0.2s ease; }
        .month-box:active { transform: scale(0.95); }
        /* Dashboard Table Optimization */
        #dashboard-table input { width: 100% !important; }
        #dashboard-table input { padding: 0.25rem 0.4rem !important; font-size: 0.75rem !important; }
        #dashboard-table button { font-size: 0.7rem !important; padding: 0.25rem 0.4rem !important; }
        #dashboard-table td { padding: 0.4rem !important; }
        #dashboard-table th { padding: 0.4rem !important; font-size: 0.65rem !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
        <div class="text-center bg-white p-10 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-building-user text-4xl text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-gray-800">Munirathnam Illam</h1>
            <p class="text-gray-500 mb-8">Secure Rent Management System</p>
            
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 transition flex items-center justify-center shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google">
                Sign in with Google
            </button>
            <p id="login-error" role="alert" aria-live="assertive" class="text-red-500 text-sm mt-4 hidden text-left bg-red-50 p-3 rounded border border-red-200"></p>
        </div>
    </div>

    <!-- APP CONTENT (Hidden by default) -->
    <div id="app-content" class="hidden-section">
        
        <!-- Navigation -->
        <nav class="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-building-user text-2xl"></i>
                    <span class="text-xl font-bold hidden md:inline">Munirathnam Illam</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex space-x-6 text-sm font-medium">
                        <a href="#" onclick="showSection('dashboard')" class="hover:text-blue-200 transition cursor-pointer">Dashboard</a>
                        <a href="#" onclick="showSection('rent-details')" class="hover:text-blue-200 transition cursor-pointer">Rent Details</a>
                    </div>
                    
                    <div class="flex items-center border-l border-blue-400 pl-4 ml-2">
                        <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full border-2 border-white mr-2">
                        <span id="user-name" class="text-sm font-semibold mr-4 hidden sm:block">User</span>
                        <button onclick="logout()" class="text-blue-100 hover:text-white" title="Sign Out">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            
            <!-- Dashboard Summary -->
            <section id="dashboard" class="section-tab active mb-16">
                <h2 class="text-3xl font-bold mb-8 text-gray-700">Dashboard Overview</h2>

                <!-- Occupancy Metrics - Maximized -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-16">
                    <!-- Card 1: Occupied Rooms -->
                    <div class="bg-white p-12 rounded-xl shadow-lg border-l-8 border-blue-500 hover:shadow-2xl transition transform hover:scale-102">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Occupied Rooms</p>
                                <p class="text-7xl font-bold text-blue-600" id="occupied-count">0</p>
                                <p class="text-base text-gray-400 mt-4">Out of 12</p>
                            </div>
                            <i class="fa-solid fa-door-open text-blue-500 text-6xl opacity-20"></i>
                        </div>
                    </div>
                    
                    <!-- Card 2: Vacant Rooms -->
                    <div class="bg-white p-12 rounded-xl shadow-lg border-l-8 border-gray-400 hover:shadow-2xl transition transform hover:scale-102">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Vacant Rooms</p>
                                <p class="text-7xl font-bold text-gray-600" id="vacant-count">12</p>
                                <p class="text-base text-gray-400 mt-4">Available</p>
                            </div>
                            <i class="fa-solid fa-house text-gray-400 text-6xl opacity-20"></i>
                        </div>
                    </div>
                    
                    <!-- Card 3: Occupancy Rate -->
                    <div class="bg-white p-12 rounded-xl shadow-lg border-l-8 border-purple-500 hover:shadow-2xl transition transform hover:scale-102">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Occupancy Rate</p>
                                <p class="text-7xl font-bold text-purple-600" id="occupancy-rate">0%</p>
                                <p class="text-base text-gray-400 mt-4">Capacity</p>
                            </div>
                            <i class="fa-solid fa-chart-pie text-purple-500 text-6xl opacity-20"></i>
                        </div>
                    </div>
                    
                    <!-- Card 4: Total Pending Rent -->
                    <div class="bg-white p-12 rounded-xl shadow-lg border-l-8 border-orange-500 hover:shadow-2xl transition transform hover:scale-102">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <p class="text-gray-500 text-base font-semibold mb-3">Pending Rent</p>
                                <p class="text-6xl font-bold text-orange-600" id="pending-rent">‚Çπ0</p>
                                <p class="text-base text-gray-400 mt-4">All months</p>
                            </div>
                            <i class="fa-solid fa-exclamation-triangle text-orange-500 text-6xl opacity-20"></i>
                        </div>
                    </div>
                </div>

                <!-- 12 Immutable Rooms Section -->
                <h3 class="text-3xl font-bold text-gray-800 mb-8">Room Details</h3>
                <div id="roomCardsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 12 Room Cards will be generated by JavaScript -->
                </div>

            </section>

            <!-- Rent Details Section -->
            <section id="rent-details" class="section-tab mb-10">
                <h2 class="text-2xl font-bold mb-6 text-gray-700">Rent Details</h2>
                <p class="text-gray-500 mb-4">Monthly rent payment status for all rooms - Click any month to toggle status (Pending/Paid/None)</p>
                
                <!-- Rent Details Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div style="width: 100%; overflow-x: auto;">
                        <table id="rentDetailsTable" class="text-sm w-full border-collapse">
                            <thead class="bg-blue-100 text-gray-700 sticky top-0">
                                <tr>
                                    <th class="border px-4 py-3 text-left font-semibold">Room ID</th>
                                    <th class="border px-4 py-3 text-left font-semibold">Room No</th>
                                    <th class="border px-4 py-3 text-left font-semibold">Tenant Name</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Jan</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Feb</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Mar</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Apr</th>
                                    <th class="border px-4 py-3 text-center font-semibold">May</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Jun</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Jul</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Aug</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Sep</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Oct</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Nov</th>
                                    <th class="border px-4 py-3 text-center font-semibold">Dec</th>
                                </tr>
                            </thead>
                            <tbody id="rentDetailsBody" class="divide-y">
                                <tr>
                                    <td colspan="15" class="text-center py-10 text-gray-400">
                                        Loading room data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Legend -->
                <div class="mt-6 flex justify-center gap-8 text-sm">
                    <span class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-gray-200 border border-gray-400 rounded flex items-center justify-center text-xs">-</div>
                        <span>No Record</span>
                    </span>
                    <span class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-red-100 border-2 border-red-400 rounded flex items-center justify-center text-red-600 font-bold text-xs">‚úó</div>
                        <span>Pending (Rent Not Paid)</span>
                    </span>
                    <span class="flex items-center gap-2">
                        <div class="w-5 h-5 bg-green-100 border-2 border-green-400 rounded flex items-center justify-center text-green-600 font-bold text-xs">‚úì</div>
                        <span>Paid (Rent Received)</span>
                    </span>
                </div>
            </section>

            <!-- Rooms Section -->
            <section id="rooms" class="section-tab mb-10">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-700">Rooms</h2>
                    
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <!-- Search & Filter Controls -->
                        <div class="relative w-full sm:w-64">
                            <input type="text" id="searchInput" oninput="applyFilters()" placeholder="Search..." class="pl-9 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full shadow-sm">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        
                        <select id="filterStatus" onchange="applyFilters()" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="All">All Status</option>
                            <option value="Occupied">Occupied</option>
                            <option value="Vacant">Vacant</option>
                        </select>
                        
                        <select id="filterPayment" onchange="applyFilters()" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="All">All Payments</option>
                            <option value="Pending">Pending</option>
                            <option value="Paid">Paid</option>
                        </select>

                        <div class="flex gap-2">
                            <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center justify-center">
                                <i class="fa-solid fa-file-csv mr-2"></i> Export
                            </button>

                            <button onclick="toggleModal('propertyModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center justify-center">
                                <i class="fa-solid fa-plus mr-2"></i> Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property Grid -->
                <div id="property-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Loading State -->
                    <div class="col-span-full text-center py-12">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p class="text-gray-500">Loading your rooms from cloud...</p>
                    </div>
                </div>
            </section>

            <!-- Rent Details Section -->
            <section id="rent-details" class="section-tab mb-10">
                <h2 class="text-2xl font-bold mb-2 text-gray-700">Rent Details</h2>
                <p class="text-gray-500 mb-6">View and manage rent payment details</p>
                
                <!-- Placeholder for future rent payment tracking -->
                <div class="bg-white rounded-lg shadow-md p-8 text-center">
                    <p class="text-gray-400">Rent payment tracking features coming soon...</p>
                </div>
            </section>

        </main>

        <!-- Floating Left-Side Button for Rent Details (25% from top) -->
        <button onclick="showSection('rent-details')" 
            class="fixed left-6 text-white bg-purple-600 hover:bg-purple-700 rounded-full w-16 h-16 flex items-center justify-center shadow-lg transition z-30" 
            style="top: 25%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"
            title="View Rent Details">
            <i class="fa-solid fa-receipt text-xl"></i>
        </button>
    </div>

    <!-- TENANT DETAILS MODAL -->
    <div id="tenantDetailsModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="tenant-modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 transform transition-all scale-100 m-4 overflow-y-auto max-h-screen">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="tenant-modal-title" class="text-2xl font-bold text-gray-800">Tenant Details</h3>
                <button onclick="closeTenantDetailsModal()" class="text-gray-500 hover:text-red-500 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            
            <div id="tenantDetailsModalContent" class="space-y-6">
                <!-- Details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ADD TENANT MODAL -->
    <div id="addTenantModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="add-tenant-modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 transform transition-all scale-100 m-4 overflow-y-auto max-h-screen">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="add-tenant-modal-title" class="text-2xl font-bold text-gray-800">Add New Tenant</h3>
                <button onclick="closeAddTenantModal()" class="text-gray-500 hover:text-red-500 text-2xl" aria-label="Close modal">&times;</button>
            </div>
            
            <form id="addTenantForm" class="space-y-4">
                <!-- Room Selector -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Select Room <span class="text-red-500">*</span></label>
                    <select id="roomSelector" onchange="window.prefillRoomDetails()" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Choose a room --</option>
                        <option value="01">Room 01 (G01)</option>
                        <option value="02">Room 02 (G02)</option>
                        <option value="04">Room 04 (102)</option>
                        <option value="05">Room 05 (201)</option>
                        <option value="06">Room 06 (202)</option>
                        <option value="07">Room 07 (203)</option>
                        <option value="08">Room 08 (301)</option>
                        <option value="09">Room 09 (302)</option>
                        <option value="10">Room 10 (303)</option>
                        <option value="11">Room 11 (401)</option>
                        <option value="12">Room 12 (402)</option>
                        <option value="13">Room 13 (403)</option>
                    </select>
                </div>

                <!-- Auto-filled Immutable Room Details (Read-only) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Room No</label>
                        <input type="text" id="tenantRoomNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Room ID</label>
                        <input type="text" id="tenantRoomId" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Key No</label>
                        <input type="text" id="tenantKeyNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">EB Service No</label>
                        <input type="text" id="tenantEbServNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">EB Account No</label>
                        <input type="text" id="tenantEbAcNo" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-200 text-gray-600 cursor-not-allowed">
                    </div>
                </div>

                <!-- Tenant Details (User Input) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Tenant Name <span class="text-red-500">*</span></label>
                        <input type="text" id="tenantNameInput" required placeholder="e.g. Ramesh" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Contact Number <span class="text-red-500">*</span></label>
                        <input type="tel" id="tenantContact" required placeholder="e.g. 9876543210" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Monthly Rent (‚Çπ) <span class="text-red-500">*</span></label>
                        <input type="number" id="tenantRent" required min="1" placeholder="e.g. 5600" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Security Deposit (‚Çπ) <span class="text-red-500">*</span></label>
                        <input type="number" id="tenantDeposit" required min="0" placeholder="e.g. 25000" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Date of Relocation <span class="text-red-500">*</span></label>
                        <input type="date" id="tenantRelocateDate" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6 border-t pt-4">
                    <button type="button" onclick="closeAddTenantModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" id="saveTenantBtn" disabled class="px-6 py-2 bg-gray-400 text-white rounded-lg font-semibold cursor-not-allowed">
                        <i class="fa-solid fa-save mr-2"></i>Save Tenant
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Room Modal -->
    <div id="propertyModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Add New Room</h3>
                <button onclick="toggleModal('propertyModal')" class="text-gray-500 hover:text-red-500 text-xl" aria-label="Close modal">&times;</button>
            </div>
            
            <form id="addPropertyForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Room No/Address</label>
                    <input type="text" id="propName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 123 Main St, Apt 4B">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Monthly Rent (‚Çπ)</label>
                    <input type="number" id="propRent" required min="1" step="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 12000">
                </div>
                
                <div class="mb-4">
                     <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                     <select id="propStatus" onchange="toggleTenantInput()" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <option value="Vacant">Vacant</option>
                        <option value="Occupied">Occupied</option>
                    </select>
                    
                    <div id="tenantInputGroup" class="hidden">
                        <input type="text" id="tenantName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="Enter Tenant Name">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Payment Status</label>
                    <select id="payStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Pending">Pending</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="toggleModal('propertyModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <span id="btn-text">Save Room</span>
                        <i id="btn-loader" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- RENT HISTORY MODAL (New Feature) -->
    <div id="historyModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 relative">
            <button onclick="closeHistoryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            
            <h3 class="text-xl font-bold text-gray-800 mb-1" id="history-title">Rent Ledger</h3>
            <p class="text-sm text-gray-500 mb-6" id="history-subtitle">Track monthly payments</p>

            <!-- Year Selector -->
            <div class="flex justify-between items-center mb-4 bg-gray-50 p-3 rounded-lg">
                <button onclick="changeLedgerYear(-1)" class="text-gray-600 hover:text-blue-600"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="ledger-year" class="text-lg font-bold text-blue-800">2025</span>
                <button onclick="changeLedgerYear(1)" class="text-gray-600 hover:text-blue-600"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <!-- Month Grid -->
            <div class="grid grid-cols-3 gap-3" id="ledger-grid">
                <!-- Months generated by JS -->
            </div>

            <div class="mt-6 text-xs text-gray-400 flex justify-center gap-4">
                <span class="flex items-center"><i class="fa-solid fa-circle text-gray-200 mr-1"></i> No Record</span>
                <span class="flex items-center"><i class="fa-solid fa-circle text-red-500 mr-1"></i> Pending</span>
                <span class="flex items-center"><i class="fa-solid fa-circle text-green-500 mr-1"></i> Paid</span>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULE LOGIC -->
    <script type="module">
        // Imports MUST be at top level
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCH2Q18CquL9IGi9t6KovkSqQj3DYnXf9g",
            authDomain: "munirathnam-illam.firebaseapp.com",
            projectId: "munirathnam-illam",
            storageBucket: "munirathnam-illam.firebasestorage.app",
            messagingSenderId: "852272424128",
            appId: "1:852272424128:web:e5400d3d2f512d7e477925",
            measurementId: "G-7NF6X62CKV"
        };

        // Initialize Firebase (variables at module scope so functions can access them)
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        console.log("‚úì Firebase initialized successfully");

        // GLOBAL STATE
        let currentUser = null;
        let unsubscribe = null;
        let allPropertiesData = [];
        let currentLedgerPropId = null;
        let currentLedgerYear = new Date().getFullYear();

        // IMMUTABLE ROOMS DATA - 12 Fixed Rooms (From Image)
        const IMMUTABLE_ROOMS_DATA = {
            '01': { roomNo: '01', roomId: 'G01', keyNo: '124', ebServNo: '19781', ebAcNo: '5097784' },
            '02': { roomNo: '02', roomId: 'G02', keyNo: '153', ebServNo: '19778', ebAcNo: '5097781' },
            '04': { roomNo: '04', roomId: '102', keyNo: '76', ebServNo: '19780', ebAcNo: '5097783' },
            '05': { roomNo: '05', roomId: '201', keyNo: '151', ebServNo: '19779', ebAcNo: '5097782' },
            '06': { roomNo: '06', roomId: '202', keyNo: '185', ebServNo: '19782', ebAcNo: '5097785' },
            '07': { roomNo: '07', roomId: '203', keyNo: '101', ebServNo: '19783', ebAcNo: '5097786' },
            '08': { roomNo: '08', roomId: '301', keyNo: '403', ebServNo: '19784', ebAcNo: '5097787' },
            '09': { roomNo: '09', roomId: '302', keyNo: '249', ebServNo: '19785', ebAcNo: '5097788' },
            '10': { roomNo: '10', roomId: '303', keyNo: '123', ebServNo: '19789', ebAcNo: '5097792' },
            '11': { roomNo: '11', roomId: '401', keyNo: '35', ebServNo: '19788', ebAcNo: '5097791' },
            '12': { roomNo: '12', roomId: '402', keyNo: '144', ebServNo: '19787', ebAcNo: '5097790' },
            '13': { roomNo: '13', roomId: '403', keyNo: '120', ebServNo: '19786', ebAcNo: '5097789' }
        };

        // PREFILL ROOM DETAILS FROM SELECTOR
        window.prefillRoomDetails = () => {
            const roomNo = document.getElementById('roomSelector').value;
            const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
            
            if (roomData) {
                document.getElementById('tenantRoomNo').value = roomData.roomNo;
                document.getElementById('tenantRoomId').value = roomData.roomId;
                document.getElementById('tenantKeyNo').value = roomData.keyNo;
                document.getElementById('tenantEbServNo').value = roomData.ebServNo;
                document.getElementById('tenantEbAcNo').value = roomData.ebAcNo;
            } else {
                // Clear fields if no room selected
                document.getElementById('tenantRoomNo').value = '';
                document.getElementById('tenantRoomId').value = '';
                document.getElementById('tenantKeyNo').value = '';
                document.getElementById('tenantEbServNo').value = '';
                document.getElementById('tenantEbAcNo').value = '';
            }
        };

        // GENERATE 12 IMMUTABLE ROOM CARDS - MINIMAL VIEW (Tenant Name + Status Only)
        window.generateRoomCards = () => {
            const grid = document.getElementById('roomCardsGrid');
            if (!grid) {
                console.warn("‚ùå roomCardsGrid element not found");
                return;
            }
            
            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            console.log(`‚úì Generating ${roomNos.length} room cards with data:`, IMMUTABLE_ROOMS_DATA);
            
            const htmlCards = roomNos.map(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = allPropertiesData.find(p => p.roomId === roomData.roomId);
                
                const isOccupied = tenantData && tenantData.status === 'Occupied';
                const tenantName = tenantData?.tenant || 'No Tenant';
                const borderColor = isOccupied ? 'border-blue-600' : 'border-gray-300';
                const bgColor = isOccupied ? 'bg-gradient-to-br from-blue-50 to-white' : 'bg-gray-50';
                const statusColor = isOccupied ? 'bg-blue-100 text-blue-800 border-blue-200' : 'bg-gray-200 text-gray-700 border-gray-300';
                
                return `
                    <div class="${bgColor} rounded-xl shadow-lg border-l-8 ${borderColor} p-6 cursor-pointer hover:shadow-2xl transition-all transform hover:scale-105" onclick="window.openRoomDetailModal('${roomNo}')">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-2xl font-bold text-gray-800">Room ${roomData.roomNo}</h4>
                            <span class="px-3 py-1 rounded-lg text-xs font-bold ${statusColor} border">
                                ${isOccupied ? '‚úì Occupied' : '‚óØ Vacant'}
                            </span>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-4">
                            <p class="text-lg text-gray-700 font-semibold">
                                <i class="fa-solid fa-user mr-2 text-blue-600"></i>${tenantName}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = htmlCards;
            console.log(`‚úì Generated HTML for ${roomNos.length} minimal room cards. Grid populated.`);
        };

        // OPEN ROOM DETAIL MODAL (Large Hovering Card)
        window.openRoomDetailModal = (roomNo) => {
            const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
            if (!roomData) return;
            
            const tenantData = allPropertiesData.find(p => p.roomId === roomData.roomId);
            const isOccupied = tenantData && tenantData.status === 'Occupied';
            const tenantName = tenantData?.tenant || 'No Tenant';
            const contact = tenantData?.contact || 'N/A';
            const rent = tenantData?.rent || 'N/A';
            const deposit = tenantData?.deposit || 'N/A';
            const relocate = tenantData?.relocate || 'N/A';
            
            const borderColor = isOccupied ? 'border-blue-600' : 'border-gray-300';
            const bgColor = isOccupied ? 'bg-gradient-to-br from-blue-50 to-white' : 'bg-gray-50';
            const statusColor = isOccupied ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';
            
            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" id="roomDetailBackdrop" onclick="if(event.target.id === 'roomDetailBackdrop') window.closeRoomDetailModal()">
                    <div class="bg-white rounded-2xl shadow-2xl border-l-8 ${borderColor} max-w-2xl w-full max-h-screen overflow-y-auto transform transition-all">
                        <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                            <div>
                                <h2 class="text-4xl font-bold text-gray-800">Room ${roomData.roomNo}</h2>
                                <p class="text-gray-600 mt-2">ID: <span class="font-mono font-bold text-blue-600 text-lg">${roomData.roomId}</span></p>
                            </div>
                            <button onclick="window.closeRoomDetailModal()" class="text-gray-500 hover:text-red-500 text-3xl font-bold" aria-label="Close">&times;</button>
                        </div>
                        
                        <div class="p-8 space-y-6">
                            <!-- Status Dropdown -->
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-6">
                                <label class="text-sm font-bold text-gray-700 mb-2 block">Room Status</label>
                                <select id="roomStatusDropdown_${roomData.roomId}" class="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg font-semibold text-lg cursor-pointer" onchange="window.updateRoomStatus('${roomData.roomId}', this.value)">
                                    <option value="Occupied" ${isOccupied ? 'selected' : ''}>‚úì Occupied - Tenant Present</option>
                                    <option value="Vacant" ${!isOccupied ? 'selected' : ''}>‚óØ Vacant - No Tenant</option>
                                </select>
                            </div>
                            
                            <!-- Tenant Information Section -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-blue-900 mb-4">üë§ Tenant Information</h3>
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Tenant Name</p>
                                        <p class="text-2xl font-bold text-gray-800">${tenantName}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Contact Number</p>
                                        <p class="text-xl font-mono text-gray-800">${contact}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Financial Information Section -->
                            <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-green-900 mb-4">üí∞ Financial Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Monthly Rent</p>
                                        <p class="text-2xl font-bold text-green-700">‚Çπ${typeof rent === 'number' ? rent.toLocaleString() : rent}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Security Deposit</p>
                                        <p class="text-xl font-bold text-green-700">‚Çπ${typeof deposit === 'number' ? deposit.toLocaleString() : deposit}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Room Details Section -->
                            <div class="bg-purple-50 border-l-4 border-purple-500 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-purple-900 mb-4">üè† Room Details</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Key No</p>
                                        <p class="text-lg font-bold text-gray-800">${roomData.keyNo}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">EB Service No</p>
                                        <p class="text-lg font-bold text-gray-800">${roomData.ebServNo}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">EB Account No</p>
                                        <p class="text-lg font-bold text-gray-800">${roomData.ebAcNo}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Relocation Date</p>
                                        <p class="text-lg font-bold text-gray-800">${relocate !== 'N/A' ? new Date(relocate).toLocaleDateString('en-IN') : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex gap-3 pt-4 border-t">
                                <button onclick="window.openAddTenantModal('${roomData.roomId}'); window.closeRoomDetailModal();" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition text-base">
                                    ${isOccupied ? '‚úé Edit Tenant' : '+ Add Tenant'}
                                </button>
                                <button onclick="window.closeRoomDetailModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition text-base">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Inject modal into page
            let modal = document.getElementById('roomDetailModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'roomDetailModal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            console.log(`‚úì Opened room detail modal for Room ${roomNo}`);
        };

        // CLOSE ROOM DETAIL MODAL
        window.closeRoomDetailModal = () => {
            const modal = document.getElementById('roomDetailModal');
            if (modal) {
                modal.innerHTML = '';
            }
            console.log("‚úì Closed room detail modal");
        };

        // UPDATE ROOM STATUS (Occupied/Vacant)
        window.updateRoomStatus = async (roomId, newStatus) => {
            try {
                // Find the tenant record with this roomId
                const tenantRecord = allPropertiesData.find(p => p.roomId === roomId);
                if (!tenantRecord) {
                    alert("Cannot update status: Tenant record not found");
                    return;
                }

                // Update the Firestore document
                const tenantDocRef = doc(db, "properties", tenantRecord.id);
                await updateDoc(tenantDocRef, {
                    status: newStatus
                });

                console.log(`‚úì Updated Room ${roomId} status to ${newStatus}`);
                alert(`‚úì Status updated to ${newStatus}`);

                // Refresh all views - onSnapshot listener will automatically update allPropertiesData
                setTimeout(() => {
                    window.generateRoomCards();
                    window.renderRentDetailsTable();
                }, 300);
            } catch (error) {
                console.error("Error updating room status:", error);
                alert("Error updating status: " + error.message);
            }
        };

        // UPDATE OCCUPANCY METRICS
        window.updateOccupancyMetrics = () => {
            const occupiedCount = allPropertiesData.filter(p => p.status === 'Occupied').length;
            const vacantCount = 12 - occupiedCount;
            const occupancyRate = Math.round((occupiedCount / 12) * 100);
            
            let totalPending = 0;
            allPropertiesData.forEach(p => {
                const history = p.paymentHistory || {};
                const ledgerPendingCount = Object.values(history).filter(v => v === 'Pending').length;
                
                if (ledgerPendingCount > 0) {
                    totalPending += (ledgerPendingCount * (p.rent || 0));
                } else if (p.payStatus === 'Pending') {
                    totalPending += (p.rent || 0);
                }
            });
            
            const occupiedEl = document.getElementById('occupied-count');
            const vacantEl = document.getElementById('vacant-count');
            const rateEl = document.getElementById('occupancy-rate');
            const pendingEl = document.getElementById('pending-rent');
            
            if (occupiedEl) occupiedEl.innerText = occupiedCount;
            if (vacantEl) vacantEl.innerText = vacantCount;
            if (rateEl) rateEl.innerText = occupancyRate + '%';
            if (pendingEl) pendingEl.innerText = '‚Çπ' + totalPending.toLocaleString();
        };

        // AUTH FUNCTIONS - Expose to window
        window.loginWithGoogle = async () => {
            console.log("‚úì loginWithGoogle clicked");
            const errorMsg = document.getElementById('login-error');
            errorMsg.classList.add('hidden');
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("‚úì Sign-in successful:", result.user.email);
                // Generate room cards immediately after login
                setTimeout(() => {
                    window.generateRoomCards();
                    window.updateOccupancyMetrics();
                }, 100);
            } catch (error) {
                console.error("‚ùå Login failed:", error);
                let message = "Login failed: " + error.message;
                if (error.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    message = `‚ö†Ô∏è Domain Unauthorized: "${domain}"\n\nAdd to Firebase:\n1. Console ‚Üí Authentication\n2. Settings ‚Üí Authorized Domains\n3. Add: ${domain}`;
                }
                errorMsg.innerText = message;
                errorMsg.classList.remove('hidden');
            }
        };
        
        // Initialize room cards on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log("‚úì Page loaded, initializing room cards");
            window.generateRoomCards();
        });
        window.logout = async () => {
            console.log("‚úì logout clicked");
            if (unsubscribe) unsubscribe();
            await signOut(auth);
            window.location.reload();
        };

        // SECTION NAVIGATION
        window.showSection = (sectionName) => {
            // Hide all sections
            document.querySelectorAll('.section-tab').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show the selected section
            const activeSection = document.getElementById(sectionName);
            if (activeSection) {
                activeSection.classList.add('active');
            }
            
            console.log("‚úì Showing section:", sectionName);
        };

        // Auth State Listener - Check Authorization
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("‚úì User signed in:", user.email);
                
                // Check authorization against Firestore authorizedUsers collection
                try {
                    const { getDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const authRef = doc(db, "authorizedUsers", user.email);
                    const authSnapshot = await getDoc(authRef);
                    
                    if (!authSnapshot.exists()) {
                        // User not authorized - sign them out
                        console.error("‚ùå Unauthorized user:", user.email);
                        await signOut(auth);
                        document.getElementById('login-error').innerText = `‚ùå ACCESS DENIED\n\nYour email (${user.email}) is not authorized.\n\nPlease contact the administrator for access.`;
                        document.getElementById('login-error').classList.remove('hidden');
                        return;
                    }
                    
                    // User is authorized - proceed with login
                    currentUser = user;
                    console.log("‚úì User authorized:", user.email);
                    document.getElementById('user-name').innerText = user.displayName || 'User';
                    let photoURL = user.photoURL && (user.photoURL.startsWith('http://') || user.photoURL.startsWith('https://')) ? user.photoURL : 'https://via.placeholder.com/150';
                    document.getElementById('user-photo').src = photoURL;
                    document.getElementById('login-screen').classList.add('hidden-section');
                    document.getElementById('app-content').classList.remove('hidden-section');
                    document.getElementById('login-error').classList.add('hidden');
                    initDataListener();
                } catch (err) {
                    console.error("Authorization check error:", err);
                    await signOut(auth);
                    document.getElementById('login-error').innerText = `‚ö†Ô∏è System Error\n\n${err.message}\n\nPlease try again.`;
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } else {
                console.log("‚úì User signed out");
                document.getElementById('login-screen').classList.remove('hidden-section');
                document.getElementById('app-content').classList.add('hidden-section');
            }
        });

        // DATA LISTENER
        function initDataListener() {
            console.log("‚úì Initializing data listener");
            const q = query(collection(db, "properties"), orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, (snapshot) => {
                allPropertiesData = [];
                snapshot.forEach((doc) => {
                    allPropertiesData.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`‚úì Loaded ${allPropertiesData.length} properties from Firestore`);
                
                // Also load rooms collection to populate dashboard inputs
                loadDashboardDataFromFirestore().then(() => {
                    // After loading dashboard data, refresh all views including Rent Details
                    console.log("‚úì Dashboard data loaded, refreshing views...");
                    window.applyFilters();
                    // Extra force to generate room cards
                    setTimeout(() => {
                        window.generateRoomCards();
                    }, 200);
                });
            }, (error) => {
                console.error("Data fetch error:", error);
                if (error.code === 'permission-denied') {
                    alert("Permission denied. Database rules might not be set to public/test mode.");
                }
            });
        }

        // Load dashboard row data from Firestore rooms collection
        async function loadDashboardDataFromFirestore() {
            try {
                const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const roomsSnapshot = await getDocs(collection(db, "rooms"));
                
                // Create a map of roomId -> room data
                const roomsMap = {};
                roomsSnapshot.forEach((doc) => {
                    roomsMap[doc.id] = doc.data();
                });

                console.log(`üì¶ Found ${Object.keys(roomsMap).length} rooms in Firestore`);

                // Populate dashboard inputs with rooms data (limit to first 12 rows)
                let rowIndex = 0;
                Object.entries(roomsMap).forEach(([roomId, roomData]) => {
                    if (rowIndex < 12) {
                        const row = document.getElementById(`row-${rowIndex}-roomNo`);
                        if (row) {
                            document.getElementById(`row-${rowIndex}-roomNo`).value = roomData.roomNo || '';
                            document.getElementById(`row-${rowIndex}-roomId`).value = roomData.roomId || roomId;
                            document.getElementById(`row-${rowIndex}-keyNo`).value = roomData.keyNo || '';
                            document.getElementById(`row-${rowIndex}-ebServNo`).value = roomData.ebServNo || '';
                            document.getElementById(`row-${rowIndex}-ebAcNo`).value = roomData.ebAcNo || '';
                            document.getElementById(`row-${rowIndex}-tenantName`).value = roomData.tenantName || '';
                            document.getElementById(`row-${rowIndex}-rent`).value = roomData.rent || '';
                            document.getElementById(`row-${rowIndex}-contact`).value = roomData.contact || '';
                            document.getElementById(`row-${rowIndex}-deposit`).value = roomData.deposit || '';
                            document.getElementById(`row-${rowIndex}-relocate`).value = roomData.relocate || '';
                            console.log(`‚úì Loaded room ${rowIndex}: ${roomData.roomNo} (${roomData.roomId})`);
                            rowIndex++;
                        }
                    }
                });

                console.log(`‚úì Populated ${rowIndex} dashboard rows`);
                // After populating dashboard, render Rent Details table
                renderRentDetailsTable();
                return true;
            } catch (error) {
                console.error("‚ùå Error loading dashboard data:", error);
                return false;
            }
        }

        // RENDER & LOGIC
        window.applyFilters = () => {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPayment = document.getElementById('filterPayment').value;

            const filteredData = allPropertiesData.filter(prop => {
                const matchesSearch = (prop.name.toLowerCase().includes(searchText) || prop.tenant.toLowerCase().includes(searchText));
                const matchesStatus = (filterStatus === 'All') || (prop.status === filterStatus);
                const matchesPayment = (filterPayment === 'All') || (prop.payStatus === filterPayment);
                
                return matchesSearch && matchesStatus && matchesPayment;
            });
            renderProperties(filteredData);
            renderTenants(filteredData);
            updateStats(allPropertiesData);
            
            // Generate room cards and update metrics
            window.generateRoomCards();
            window.updateOccupancyMetrics();
            renderTenantDetailsCards(allPropertiesData);
            // renderRentDetailsTable(); // Now called after dashboard data loads
        };

        // TENANT DETAILS RENDERING
        window.renderTenantDetailsCards = (tenantList) => {
            const grid = document.getElementById('tenantDetailsGrid');
            if (!tenantList || tenantList.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">No tenants found.</p>';
                return;
            }

            // Only show occupied properties
            const occupiedTenants = tenantList.filter(p => p.status === 'Occupied' && p.tenant && p.tenant !== 'None');

            if (occupiedTenants.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">No occupied units at the moment.</p>';
                return;
            }

            grid.innerHTML = occupiedTenants.map(tenant => `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition cursor-pointer border-l-4 border-blue-500 p-6" onclick="openTenantDetailsModal('${tenant.id}')">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${escapeHtml(tenant.tenant)}</h3>
                            <p class="text-sm text-gray-600"><i class="fa-solid fa-door-open mr-1"></i>Room: ${escapeHtml(tenant.name || 'N/A')}</p>
                        </div>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Occupied</span>
                    </div>
                    <div class="border-t pt-3 space-y-2">
                        <p class="text-sm"><span class="font-semibold text-gray-700">Rent:</span> <span class="text-blue-600 font-bold">‚Çπ${tenant.rent || 0}</span></p>
                        <p class="text-sm"><span class="font-semibold text-gray-700">Contact:</span> ${escapeHtml(tenant.contact || 'N/A')}</p>
                    </div>
                    <button class="w-full mt-4 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition text-sm font-semibold">
                        View Details
                    </button>
                </div>
            `).join('');
        };

        window.openTenantDetailsModal = (tenantId) => {
            const tenant = allPropertiesData.find(p => p.id === tenantId);
            if (!tenant) return;

            const relocateDate = tenant.relocate ? new Date(tenant.relocate) : null;
            let nextRevisionDate = 'N/A';
            
            if (relocateDate && !isNaN(relocateDate.getTime())) {
                const nextRevision = new Date(relocateDate);
                nextRevision.setFullYear(nextRevision.getFullYear() + 1);
                nextRevisionDate = nextRevision.toLocaleDateString('en-IN', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            }

            const relocateDateFormatted = relocateDate && !isNaN(relocateDate.getTime()) 
                ? relocateDate.toLocaleDateString('en-IN', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })
                : 'N/A';

            const content = `
                <div class="space-y-5">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h4 class="font-bold text-blue-900 mb-2">Basic Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Tenant Name</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.tenant || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Room Number</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.name || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Room ID</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.roomId || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Contact</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.contact || 'N/A')}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                        <h4 class="font-bold text-green-900 mb-2">Financial Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Monthly Rent</p>
                                <p class="text-2xl font-bold text-green-700">‚Çπ${tenant.rent || 0}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Security Deposit</p>
                                <p class="text-lg font-bold text-green-700">‚Çπ${tenant.deposit || 0}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                        <h4 class="font-bold text-purple-900 mb-2">Utility Details</h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">EB Service No.</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.ebServNo || 'N/A')}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">EB Account No.</p>
                                <p class="text-lg font-bold text-gray-800">${escapeHtml(tenant.ebAcNo || 'N/A')}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                        <h4 class="font-bold text-orange-900 mb-2">Tenancy Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Date of Relocation</p>
                                <p class="text-lg font-bold text-gray-800">${relocateDateFormatted}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 uppercase tracking-wide">Next Rent Revision</p>
                                <p class="text-lg font-bold text-orange-700">${nextRevisionDate}</p>
                                <p class="text-xs text-gray-600 mt-1">(After 1 year from relocation)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('tenant-modal-title').innerText = `${escapeHtml(tenant.tenant || 'Tenant')} - ${escapeHtml(tenant.name || 'Room')}`;
            document.getElementById('tenantDetailsModalContent').innerHTML = content;
            document.getElementById('tenantDetailsModal').classList.remove('hidden');
        };

        window.closeTenantDetailsModal = () => {
            document.getElementById('tenantDetailsModal').classList.add('hidden');
        };

        // RENT HISTORY LOGIC
        window.openHistory = (propId) => {
            currentLedgerPropId = propId;
            const prop = allPropertiesData.find(p => p.id === propId);
            document.getElementById('history-title').innerText = prop.name;
            document.getElementById('history-subtitle').innerText = `Rent: ‚Çπ${prop.rent}/month | Tenant: ${prop.tenant}`;
            document.getElementById('historyModal').classList.remove('hidden');
            window.renderLedger();
        };

        window.closeHistoryModal = () => {
            document.getElementById('historyModal').classList.add('hidden');
        };

        window.changeLedgerYear = (delta) => {
            currentLedgerYear += delta;
            window.renderLedger();
        };

        window.renderLedger = () => {
            document.getElementById('ledger-year').innerText = currentLedgerYear;
            const grid = document.getElementById('ledger-grid');
            grid.innerHTML = '';
            
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const prop = allPropertiesData.find(p => p.id === currentLedgerPropId);
            const history = prop.paymentHistory || {}; 

            months.forEach(month => {
                const key = `${currentLedgerYear}-${month}`;
                const status = history[key] || 'None';
                
                let btnClass = "bg-gray-100 text-gray-500 hover:bg-gray-200";
                let icon = "";
                
                if (status === 'Pending') {
                    btnClass = "bg-red-100 text-red-600 border border-red-200 shadow-sm";
                    icon = '<i class="fa-solid fa-circle-exclamation mr-1"></i>';
                } else if (status === 'Paid') {
                    btnClass = "bg-green-100 text-green-700 border border-green-200 shadow-sm";
                    icon = '<i class="fa-solid fa-check mr-1"></i>';
                }

                const div = document.createElement('div');
                div.className = `month-box p-3 rounded-lg cursor-pointer text-center font-semibold text-sm select-none ${btnClass}`;
                div.innerHTML = `<div>${month}</div><div class="text-xs font-normal mt-1">${icon}${status === 'None' ? '-' : status}</div>`;
                div.onclick = () => window.togglePaymentStatus(key, status);
                grid.appendChild(div);
            });
        };

        window.togglePaymentStatus = async (key, currentStatus) => {
            let newStatus = 'Pending';
            if (currentStatus === 'Pending') newStatus = 'Paid';
            else if (currentStatus === 'Paid') newStatus = 'None';

            const propRef = doc(db, "properties", currentLedgerPropId);
            const updatePayload = {};
            
            if (newStatus === 'None') {
                updatePayload[`paymentHistory.${key}`] = null; 
            } else {
                updatePayload[`paymentHistory.${key}`] = newStatus;
            }

            try {
                await updateDoc(propRef, updatePayload);
            } catch (e) {
                console.error("Update failed", e);
                alert("Failed to update status: " + e.message);
            }
        };

        // CSV EXPORT
        window.exportToCSV = () => {
            if (allPropertiesData.length === 0) { alert("No data"); return; }
            let csv = "Room,Tenant,Rent,Status,Payment Status\n";
            allPropertiesData.forEach(p => csv += `"${p.name}","${p.tenant}",${p.rent},${p.status},${p.payStatus}\n`);
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "rent_data.csv";
            link.click();
        };

        // UI HELPERS
        window.toggleModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal.classList.contains('hidden')) {
                modal.dataset.previousFocus = document.activeElement?.id || '';
                modal.classList.remove('hidden');
                modal.setAttribute('aria-hidden', 'false');
                const focusables = modal.querySelectorAll('input, select, textarea, button:not([disabled])');
                if (focusables.length) focusables[0].focus();
            } else {
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden', 'true');
                if (modal.dataset.previousFocus) {
                    const el = document.getElementById(modal.dataset.previousFocus);
                    if (el) el.focus();
                }
            }
        };
        
        window.toggleTenantInput = () => {
            const show = document.getElementById('propStatus').value === 'Occupied';
            document.getElementById('tenantInputGroup').classList.toggle('hidden', !show);
        };

        // ADD TENANT MODAL FUNCTIONS
        window.openAddTenantModal = (roomId = null) => {
            document.getElementById('addTenantModal').classList.remove('hidden');
            document.getElementById('addTenantForm').reset();
            
            // If roomId is provided, pre-select the room
            if (roomId) {
                const roomNo = Object.keys(IMMUTABLE_ROOMS_DATA).find(key => IMMUTABLE_ROOMS_DATA[key].roomId === roomId);
                if (roomNo) {
                    document.getElementById('roomSelector').value = roomNo;
                    window.prefillRoomDetails();
                }
            }
        };

        window.closeAddTenantModal = () => {
            const modal = document.getElementById('addTenantModal');
            const form = document.getElementById('addTenantForm');
            const btn = document.getElementById('saveTenantBtn');
            
            if (modal) modal.classList.add('hidden');
            if (form) form.reset();
            if (btn) {
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        };

        // FORM VALIDATION FOR MANDATORY FIELDS
        window.validateAddTenantForm = () => {
            const roomSelectorEl = document.getElementById('roomSelector');
            const tenantNameEl = document.getElementById('tenantNameInput');
            const contactEl = document.getElementById('tenantContact');
            const rentEl = document.getElementById('tenantRent');
            const depositEl = document.getElementById('tenantDeposit');
            const relocateDateEl = document.getElementById('tenantRelocateDate');
            const saveBtnEl = document.getElementById('saveTenantBtn');
            
            if (!saveBtnEl) {
                console.warn("saveTenantBtn not found");
                return;
            }
            
            const roomSelector = roomSelectorEl?.value || '';
            const tenantName = tenantNameEl?.value.trim() || '';
            const contact = contactEl?.value.trim() || '';
            const rent = rentEl?.value || '';
            const deposit = depositEl?.value || '';
            const relocateDate = relocateDateEl?.value || '';

            const isValid = roomSelector && tenantName && contact && rent && deposit && relocateDate;
            
            if (isValid) {
                saveBtnEl.disabled = false;
                saveBtnEl.classList.remove('bg-gray-400', 'cursor-not-allowed');
                saveBtnEl.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                saveBtnEl.disabled = true;
                saveBtnEl.classList.add('bg-gray-400', 'cursor-not-allowed');
                saveBtnEl.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        };

        // ADD TENANT FORM HANDLER
        const addTenantForm = document.getElementById('addTenantForm');
        if (addTenantForm) {
            addTenantForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return alert("Please login");

                // Check tenant count
                const occupiedTenants = allPropertiesData.filter(p => p.status === 'Occupied' && p.tenant && p.tenant !== 'None').length;
                if (occupiedTenants >= 12) {
                    alert("Maximum 12 tenants allowed. Please delete an existing tenant first.");
                    return;
                }

                const roomNo = document.getElementById('tenantRoomNo').value.trim();
                const roomId = document.getElementById('tenantRoomId').value.trim();
                const tenantName = document.getElementById('tenantNameInput').value.trim();
                const contact = document.getElementById('tenantContact').value.trim();
                const rent = parseFloat(document.getElementById('tenantRent').value);
                const deposit = parseFloat(document.getElementById('tenantDeposit').value) || 0;
                const ebServNo = document.getElementById('tenantEbServNo').value.trim();
                const ebAcNo = document.getElementById('tenantEbAcNo').value.trim();
                const keyNo = document.getElementById('tenantKeyNo').value.trim();
                const relocate = document.getElementById('tenantRelocateDate').value;

                if (!roomNo || !roomId || !tenantName || isNaN(rent)) {
                    alert("Please fill all required fields (Room No, Room ID, Tenant Name, Rent)");
                    return;
                }

                try {
                    // Save to Firestore
                    await addDoc(collection(db, "properties"), {
                        name: roomNo,
                        roomId: roomId,
                        roomNo: roomNo,
                        tenant: tenantName,
                        rent: rent,
                        contact: contact,
                        deposit: deposit,
                        ebServNo: ebServNo,
                        ebAcNo: ebAcNo,
                        keyNo: keyNo,
                        relocate: relocate,
                        status: 'Occupied',
                        payStatus: 'Pending',
                        createdAt: serverTimestamp(),
                        createdBy: currentUser.uid,
                        paymentHistory: {}
                    });

                    console.log("‚úì Tenant added successfully to Firestore");
                    
                    // Reset form
                    const formToReset = document.getElementById('addTenantForm');
                    if (formToReset) {
                        formToReset.reset();
                    }
                    
                    alert("‚úì Tenant added successfully!");
                    
                    // Close modal
                    window.closeAddTenantModal();

                    // Refresh views with slight delay to ensure data propagates
                    setTimeout(() => {
                        window.applyFilters();
                    }, 500);
                } catch (err) {
                    console.error("‚ùå Add tenant failed", err);
                    alert("Error adding tenant: " + err.message);
                }
            });

            // Add event listeners to mandatory fields for form validation
            const roomSelector = document.getElementById('roomSelector');
            const tenantName = document.getElementById('tenantNameInput');
            const tenantContact = document.getElementById('tenantContact');
            const tenantRent = document.getElementById('tenantRent');
            const tenantDeposit = document.getElementById('tenantDeposit');
            const relocateDate = document.getElementById('tenantRelocateDate');
            
            if (roomSelector) roomSelector.addEventListener('change', window.validateAddTenantForm);
            if (tenantName) tenantName.addEventListener('input', window.validateAddTenantForm);
            if (tenantContact) tenantContact.addEventListener('input', window.validateAddTenantForm);
            if (tenantRent) tenantRent.addEventListener('input', window.validateAddTenantForm);
            if (tenantDeposit) tenantDeposit.addEventListener('input', window.validateAddTenantForm);
            if (relocateDate) relocateDate.addEventListener('change', window.validateAddTenantForm);
        }

        // ADD PROPERTY
        const formElement = document.getElementById('addPropertyForm');
        if (formElement) {
            formElement.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return alert("Please login");
                
                const btnText = document.getElementById('btn-text');
                const btnLoader = document.getElementById('btn-loader');
                
                const name = document.getElementById('propName').value.trim();
                const rent = parseFloat(document.getElementById('propRent').value);
                const status = document.getElementById('propStatus').value;
                const payStatus = document.getElementById('payStatus').value;
                const tName = document.getElementById('tenantName').value.trim();
                const tenant = (status === 'Occupied' && tName) ? tName : (status === 'Occupied' ? 'Assigned' : 'None');

                if (!name) { alert("Room No/Address is required"); return; }
                if (isNaN(rent) || rent <= 0) { alert("Invalid Rent Amount"); return; }

                btnText.innerText = "Saving...";
                btnLoader.classList.remove('hidden');

                try {
                    await addDoc(collection(db, "properties"), {
                        name, rent, status, payStatus, tenant,
                        createdAt: serverTimestamp(),
                        createdBy: currentUser.uid,
                        paymentHistory: {} 
                    });
                    e.target.reset();
                    window.toggleModal('propertyModal');
                    window.toggleTenantInput();
                } catch (err) {
                    console.error("Add failed", err);
                    alert("Error saving: " + err.message);
                } finally {
                    btnText.innerText = "Save Room";
                    btnLoader.classList.add('hidden');
                }
            });
        } else {
            console.warn('addPropertyForm element not found');
        }

        window.deleteProperty = async (id) => {
            if (!currentUser) {
                alert("You must be logged in to delete.");
                return;
            }
            if (confirm('Are you sure you want to delete this property?')) {
                try {
                    await deleteDoc(doc(db, "properties", id));
                } catch (error) {
                    console.error("Error deleting: ", error);
                    alert("Failed to delete: " + error.message);
                }
            }
        };

        // SAVE DASHBOARD ROW (Persist room metadata to Firestore) and sync to properties
        window.saveDashboardRow = async (rowIndex) => {
            if (!currentUser) {
                alert("Please login first");
                return;
            }

            // Read values from the input fields
            const roomNo = document.getElementById(`row-${rowIndex}-roomNo`).value.trim();
            const roomId = document.getElementById(`row-${rowIndex}-roomId`).value.trim();
            const keyNo = document.getElementById(`row-${rowIndex}-keyNo`).value.trim();
            const ebServNo = document.getElementById(`row-${rowIndex}-ebServNo`).value.trim();
            const ebAcNo = document.getElementById(`row-${rowIndex}-ebAcNo`).value.trim();
            const tenantName = document.getElementById(`row-${rowIndex}-tenantName`).value.trim();
            const rent = document.getElementById(`row-${rowIndex}-rent`).value ? parseFloat(document.getElementById(`row-${rowIndex}-rent`).value) : 0;
            const contact = document.getElementById(`row-${rowIndex}-contact`).value.trim();
            const deposit = document.getElementById(`row-${rowIndex}-deposit`).value ? parseFloat(document.getElementById(`row-${rowIndex}-deposit`).value) : 0;
            const relocate = document.getElementById(`row-${rowIndex}-relocate`).value;

            // Validate: Room ID and Room No must be present
            if (!roomId) {
                alert("Room ID is required");
                return;
            }
            if (!roomNo) {
                alert("Room No is required");
                return;
            }

            // Prepare room metadata document
            const roomMetadata = {
                roomNo,
                roomId,
                keyNo,
                ebServNo,
                ebAcNo,
                tenantName,
                rent,
                contact,
                deposit,
                relocate,
                updatedAt: serverTimestamp(),
                updatedBy: currentUser.uid
            };

            try {
                // Store/update in the "rooms" collection keyed by roomId
                const { setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const roomRef = doc(db, "rooms", roomId);
                await setDoc(roomRef, roomMetadata, { merge: true });

                // Attempt to sync into the main "properties" collection when a matching property exists
                const matched = allPropertiesData.find(p => (p.roomId === roomId) || (p.id === roomId) || (p.name === roomNo));
                if (matched) {
                    try {
                        const propRef = doc(db, "properties", matched.id);
                        await updateDoc(propRef, {
                            tenant: tenantName || matched.tenant || 'None',
                            rent: rent || matched.rent || 0,
                            contact: contact || matched.contact || '',
                            deposit: deposit || matched.deposit || 0,
                            roomNo,
                            roomId,
                            updatedAt: serverTimestamp(),
                            updatedBy: currentUser.uid
                        });
                        console.log(`‚úì Synced room metadata to property ${matched.id}`);
                    } catch (syncErr) {
                        console.warn("‚ö†Ô∏è Failed to sync to properties collection:", syncErr);
                    }
                }

                alert(`‚úì Room ${roomId} saved successfully!`);
                console.log(`‚úì Saved dashboard row ${rowIndex} with roomId: ${roomId}`);

                // Refresh views
                window.applyFilters();
            } catch (error) {
                console.error("Save failed:", error);
                alert(`Failed to save room: ${error.message}`);
            }
        };

        // RENDER HELPERS
        function escapeHtml(text) { 
            return (text || "").toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderProperties(list) {
            const grid = document.getElementById('property-grid');
            if (!list.length) { grid.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">No properties found.</p>'; return; }

            grid.innerHTML = list.map(p => {
                const history = p.paymentHistory || {};
                const currentMonthKey = `${new Date().getFullYear()}-${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][new Date().getMonth()]}`;
                
                let displayStatus = p.payStatus;
                if (history[currentMonthKey]) {
                    displayStatus = history[currentMonthKey];
                }

                let statusBadge = displayStatus === 'Paid' ? '<span class="text-green-600 font-bold text-xs"><i class="fa-solid fa-check-circle"></i> Paid</span>' 
                                : displayStatus === 'Pending' ? '<span class="text-red-600 font-bold text-xs"><i class="fa-solid fa-circle-exclamation"></i> Pending</span>'
                                : '<span class="text-gray-400 text-xs">No status</span>';

                return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition p-5 border-t-4 ${p.status === 'Occupied' ? 'border-blue-500' : 'border-gray-300'}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">${escapeHtml(p.name)}</h3>
                        <span class="px-2 py-1 rounded text-xs font-semibold ${p.status === 'Occupied' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-600'}">${escapeHtml(p.status)}</span>
                    </div>
                    <p class="text-gray-500 text-sm mb-4"><i class="fa-solid fa-user mr-1"></i> ${escapeHtml(p.tenant)}</p>
                    
                    <div class="bg-gray-50 p-3 rounded mb-4 flex justify-between items-center">
                        <span class="font-bold text-gray-700">‚Çπ${p.rent.toLocaleString()}</span>
                        ${statusBadge}
                    </div>

                    <div class="flex gap-2">
                        <button onclick="window.openHistory('${p.id}')" class="flex-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 py-2 rounded text-sm font-medium transition">
                            <i class="fa-solid fa-calendar-days mr-1"></i> Manage Rent
                        </button>
                        <button onclick="window.deleteProperty('${p.id}')" class="px-3 text-gray-400 hover:text-red-500 transition">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTenants(list) {
            const tbody = document.getElementById('tenant-list');
            if (!tbody) return; // Element doesn't exist (removed from DOM)
            const occupied = list.filter(p => p.status === 'Occupied');
            if(!occupied.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No tenants.</td></tr>'; return; }
            
            tbody.innerHTML = occupied.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-6">${escapeHtml(p.name)}</td>
                    <td class="py-3 px-6 font-medium">${escapeHtml(p.tenant)}</td>
                    <td class="py-3 px-6 text-center">‚Çπ${p.rent.toLocaleString()}</td>
                    <td class="py-3 px-6 text-center text-xs text-gray-500">${escapeHtml(p.payStatus)}</td>
                </tr>
            `).join('');
        }

        function updateStats(list) {
            document.getElementById('total-properties').innerText = list.length;
            document.getElementById('total-tenants').innerText = list.filter(p => p.status === 'Occupied').length;
            
            let totalPending = 0;
            list.forEach(p => {
                const history = p.paymentHistory || {};
                const ledgerPendingCount = Object.values(history).filter(v => v === 'Pending').length;
                
                if (ledgerPendingCount > 0) {
                    totalPending += (ledgerPendingCount * (p.rent || 0));
                } else if (p.payStatus === 'Pending') {
                    totalPending += (p.rent || 0);
                }
            });
            document.getElementById('pending-rent').innerText = '‚Çπ' + totalPending.toLocaleString();
        }

        // RENT DETAILS TABLE - Populate with 12 immutable rooms and tenant data
        function renderRentDetailsTable() {
            const tbody = document.getElementById('rentDetailsBody');
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const currentYear = new Date().getFullYear();

            // Use immutable rooms data as base
            const roomNos = Object.keys(IMMUTABLE_ROOMS_DATA).sort((a, b) => parseInt(a) - parseInt(b));
            
            if (roomNos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center py-10 text-gray-400">No room data found.</td></tr>';
                return;
            }

            // Build table rows using immutable rooms + tenant data
            tbody.innerHTML = roomNos.map(roomNo => {
                const roomData = IMMUTABLE_ROOMS_DATA[roomNo];
                const tenantData = allPropertiesData.find(p => p.roomId === roomData.roomId);
                
                // Only show tenant if status is 'Occupied'
                if (!tenantData || tenantData.status !== 'Occupied') {
                    return ''; // Skip this row if tenant is not occupied
                }
                
                const tenantName = tenantData?.tenant || 'No Tenant';
                const history = tenantData?.paymentHistory || {};
                
                let row = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="border px-4 py-3 font-semibold text-blue-600">${escapeHtml(roomData.roomId)}</td>
                        <td class="border px-4 py-3 font-semibold">${escapeHtml(roomData.roomNo)}</td>
                        <td class="border px-4 py-3 font-semibold text-gray-800 text-sm">${escapeHtml(tenantName)}</td>
                `;

                months.forEach(month => {
                    const key = `${currentYear}-${month}`;
                    const status = history[key] || 'None';
                    
                    let cellClass = "bg-gray-100 text-gray-600 border-gray-300 cursor-pointer hover:bg-gray-200";
                    let displayText = "-";
                    let icon = "";
                    
                    if (status === 'Pending') {
                        cellClass = "bg-red-100 text-red-700 border-red-300 cursor-pointer hover:bg-red-200";
                        displayText = "‚úó";
                        icon = '<i class="fa-solid fa-xmark text-red-600"></i>';
                    } else if (status === 'Paid') {
                        cellClass = "bg-green-100 text-green-700 border-green-300 cursor-pointer hover:bg-green-200";
                        displayText = "‚úì";
                        icon = '<i class="fa-solid fa-check text-green-600"></i>';
                    }

                    row += `
                        <td class="border px-4 py-3 text-center font-bold ${cellClass}" 
                            onclick="window.toggleMonthStatus('${roomData.roomId}', '${key}', '${status}')" 
                            title="Click to toggle: ${status}">
                            ${displayText}
                        </td>
                    `;
                });

                row += `</tr>`;
                return row;
            }).filter(row => row !== '').join('');
        }

        window.toggleMonthStatus = async (roomId, key, currentStatus) => {
            let newStatus = 'Pending';
            if (currentStatus === 'Pending') newStatus = 'Paid';
            else if (currentStatus === 'Paid') newStatus = 'None';

            // Find property matching roomId and update
            const prop = allPropertiesData.find(p => (p.roomId === roomId) || (p.id === roomId));
            if (!prop) {
                alert('Property not found');
                return;
            }

            const propRef = doc(db, "properties", prop.id);
            const updatePayload = {};
            
            if (newStatus === 'None') {
                updatePayload[`paymentHistory.${key}`] = null; 
            } else {
                updatePayload[`paymentHistory.${key}`] = newStatus;
            }

            try {
                await updateDoc(propRef, updatePayload);
                console.log(`‚úì Updated ${key} for room ${roomId} to ${newStatus}`);
                renderRentDetailsTable(); // Refresh the table
            } catch (e) {
                console.error("Update failed", e);
                alert("Failed to update status: " + e.message);
            }
        };

    </script>
</body>
</html>