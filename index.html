<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent Management System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom smooth scrolling */
        html { scroll-behavior: smooth; }
        .hidden-section { display: none !important; }
        /* Ledger Grid Transition */
        .month-box { transition: all 0.2s ease; }
        .month-box:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
        <div class="text-center bg-white p-10 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-building-user text-4xl text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-gray-800">Munirathnam Illam</h1>
            <p class="text-gray-500 mb-8">Secure Rent Management System</p>
            
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 transition flex items-center justify-center shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google">
                Sign in with Google
            </button>
            <p id="login-error" role="alert" aria-live="assertive" class="text-red-500 text-sm mt-4 hidden text-left bg-red-50 p-3 rounded border border-red-200"></p>
        </div>
    </div>

    <!-- APP CONTENT (Hidden by default) -->
    <div id="app-content" class="hidden-section">
        
        <!-- Navigation -->
        <nav class="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-building-user text-2xl"></i>
                    <span class="text-xl font-bold hidden md:inline">RentManager v1.2</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex space-x-4 text-sm font-medium">
                        <a href="#dashboard" class="hover:text-blue-200 transition">Dashboard</a>
                        <a href="#properties" class="hover:text-blue-200 transition">Properties</a>
                        <a href="#tenants" class="hover:text-blue-200 transition">Tenants</a>
                    </div>
                    
                    <div class="flex items-center border-l border-blue-400 pl-4 ml-2">
                        <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full border-2 border-white mr-2">
                        <span id="user-name" class="text-sm font-semibold mr-4 hidden sm:block">User</span>
                        <button onclick="logout()" class="text-blue-100 hover:text-white" title="Sign Out">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            
            <!-- Dashboard Summary -->
            <section id="dashboard" class="mb-10">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Card 1 -->
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500 relative overflow-hidden">
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-gray-500 text-sm">Total Properties</p>
                                <p class="text-3xl font-bold" id="total-properties">0</p>
                            </div>
                            <i class="fa-solid fa-house text-blue-500 text-3xl opacity-50"></i>
                        </div>
                    </div>
                    <!-- Card 2 -->
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500 relative overflow-hidden">
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-gray-500 text-sm">Total Tenants</p>
                                <p class="text-3xl font-bold" id="total-tenants">0</p>
                            </div>
                            <i class="fa-solid fa-users text-green-500 text-3xl opacity-50"></i>
                        </div>
                    </div>
                    <!-- Card 3 -->
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-orange-500 relative overflow-hidden">
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-gray-500 text-sm">Total Pending Rent</p>
                                <p class="text-3xl font-bold" id="pending-rent">₹0</p>
                                <p class="text-xs text-orange-400 mt-1">* Sum of all pending months</p>
                            </div>
                            <i class="fa-solid fa-file-invoice-dollar text-orange-500 text-3xl opacity-50"></i>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Properties Section -->
            <section id="properties" class="mb-10">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-700">Properties</h2>
                    
                    <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                        <!-- Search & Filter Controls -->
                        <div class="relative w-full sm:w-64">
                            <input type="text" id="searchInput" oninput="applyFilters()" placeholder="Search..." class="pl-9 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full shadow-sm">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        
                        <select id="filterStatus" onchange="applyFilters()" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="All">All Status</option>
                            <option value="Occupied">Occupied</option>
                            <option value="Vacant">Vacant</option>
                        </select>
                        
                        <select id="filterPayment" onchange="applyFilters()" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="All">All Payments</option>
                            <option value="Pending">Pending</option>
                            <option value="Paid">Paid</option>
                        </select>

                        <div class="flex gap-2">
                            <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center justify-center">
                                <i class="fa-solid fa-file-csv mr-2"></i> Export
                            </button>

                            <button onclick="toggleModal('propertyModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center justify-center">
                                <i class="fa-solid fa-plus mr-2"></i> Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property Grid -->
                <div id="property-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Loading State -->
                    <div class="col-span-full text-center py-12">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p class="text-gray-500">Loading your properties from cloud...</p>
                    </div>
                </div>
            </section>

            <!-- Tenants Section -->
            <section id="tenants" class="mb-10">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Tenants Directory</h2>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <tr>
                                    <th class="py-3 px-6 text-left">Property</th>
                                    <th class="py-3 px-6 text-left">Tenant Name</th>
                                    <th class="py-3 px-6 text-center">Monthly Rent</th>
                                    <th class="py-3 px-6 text-center">Current Status</th>
                                </tr>
                            </thead>
                            <tbody id="tenant-list" class="text-gray-600 text-sm font-light">
                                <!-- Tenants injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Property Modal -->
    <div id="propertyModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Add New Property</h3>
                <button onclick="toggleModal('propertyModal')" class="text-gray-500 hover:text-red-500 text-xl" aria-label="Close modal">&times;</button>
            </div>
            
            <form id="addPropertyForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Property Name/Address</label>
                    <input type="text" id="propName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 123 Main St, Apt 4B">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Monthly Rent (₹)</label>
                    <input type="number" id="propRent" required min="1" step="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 12000">
                </div>
                
                <div class="mb-4">
                     <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                     <select id="propStatus" onchange="toggleTenantInput()" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <option value="Vacant">Vacant</option>
                        <option value="Occupied">Occupied</option>
                    </select>
                    
                    <div id="tenantInputGroup" class="hidden">
                        <input type="text" id="tenantName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="Enter Tenant Name">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Payment Status</label>
                    <select id="payStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Pending">Pending</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="toggleModal('propertyModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <span id="btn-text">Save Property</span>
                        <i id="btn-loader" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- RENT HISTORY MODAL (New Feature) -->
    <div id="historyModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 relative">
            <button onclick="closeHistoryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            
            <h3 class="text-xl font-bold text-gray-800 mb-1" id="history-title">Rent Ledger</h3>
            <p class="text-sm text-gray-500 mb-6" id="history-subtitle">Track monthly payments</p>

            <!-- Year Selector -->
            <div class="flex justify-between items-center mb-4 bg-gray-50 p-3 rounded-lg">
                <button onclick="changeLedgerYear(-1)" class="text-gray-600 hover:text-blue-600"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="ledger-year" class="text-lg font-bold text-blue-800">2025</span>
                <button onclick="changeLedgerYear(1)" class="text-gray-600 hover:text-blue-600"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <!-- Month Grid -->
            <div class="grid grid-cols-3 gap-3" id="ledger-grid">
                <!-- Months generated by JS -->
            </div>

            <div class="mt-6 text-xs text-gray-400 flex justify-center gap-4">
                <span class="flex items-center"><i class="fa-solid fa-circle text-gray-200 mr-1"></i> No Record</span>
                <span class="flex items-center"><i class="fa-solid fa-circle text-red-500 mr-1"></i> Pending</span>
                <span class="flex items-center"><i class="fa-solid fa-circle text-green-500 mr-1"></i> Paid</span>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULE LOGIC -->
    <script type="module">
        // Imports MUST be at top level
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCH2Q18CquL9IGi9t6KovkSqQj3DYnXf9g",
            authDomain: "munirathnam-illam.firebaseapp.com",
            projectId: "munirathnam-illam",
            storageBucket: "munirathnam-illam.firebasestorage.app",
            messagingSenderId: "852272424128",
            appId: "1:852272424128:web:e5400d3d2f512d7e477925",
            measurementId: "G-7NF6X62CKV"
        };

        // Initialize Firebase (variables at module scope so functions can access them)
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        console.log("✓ Firebase initialized successfully");

        // GLOBAL STATE
        let currentUser = null;
        let unsubscribe = null;
        let allPropertiesData = [];
        let currentLedgerPropId = null;
        let currentLedgerYear = new Date().getFullYear();

        // AUTH FUNCTIONS - Expose to window
        window.loginWithGoogle = async () => {
            console.log("✓ loginWithGoogle clicked");
            const errorMsg = document.getElementById('login-error');
            errorMsg.classList.add('hidden');
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("✓ Sign-in successful:", result.user.email);
            } catch (error) {
                console.error("❌ Login failed:", error);
                let message = "Login failed: " + error.message;
                if (error.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    message = `⚠️ Domain Unauthorized: "${domain}"\n\nAdd to Firebase:\n1. Console → Authentication\n2. Settings → Authorized Domains\n3. Add: ${domain}`;
                }
                errorMsg.innerText = message;
                errorMsg.classList.remove('hidden');
            }
        };

        window.logout = async () => {
            console.log("✓ logout clicked");
            if (unsubscribe) unsubscribe();
            await signOut(auth);
            window.location.reload();
        };

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log("✓ User signed in:", user.email);
                document.getElementById('user-name').innerText = user.displayName || 'User';
                let photoURL = user.photoURL && (user.photoURL.startsWith('http://') || user.photoURL.startsWith('https://')) ? user.photoURL : 'https://via.placeholder.com/150';
                document.getElementById('user-photo').src = photoURL;
                document.getElementById('login-screen').classList.add('hidden-section');
                document.getElementById('app-content').classList.remove('hidden-section');
                initDataListener();
            } else {
                console.log("✓ User signed out");
                document.getElementById('login-screen').classList.remove('hidden-section');
                document.getElementById('app-content').classList.add('hidden-section');
            }
        });

        // DATA LISTENER
        function initDataListener() {
            const q = query(collection(db, "properties"), orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, (snapshot) => {
                allPropertiesData = [];
                snapshot.forEach((doc) => {
                    allPropertiesData.push({ id: doc.id, ...doc.data() });
                });
                window.applyFilters();
            }, (error) => {
                console.error("Data fetch error:", error);
                if (error.code === 'permission-denied') {
                    alert("Permission denied. Database rules might not be set to public/test mode.");
                }
            });
        }

        // RENDER & LOGIC
        window.applyFilters = () => {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterPayment = document.getElementById('filterPayment').value;

            const filteredData = allPropertiesData.filter(prop => {
                const matchesSearch = (prop.name.toLowerCase().includes(searchText) || prop.tenant.toLowerCase().includes(searchText));
                const matchesStatus = (filterStatus === 'All') || (prop.status === filterStatus);
                const matchesPayment = (filterPayment === 'All') || (prop.payStatus === filterPayment);
                
                return matchesSearch && matchesStatus && matchesPayment;
            });
            renderProperties(filteredData);
            renderTenants(filteredData);
            updateStats(allPropertiesData);
        };

        // RENT HISTORY LOGIC
        window.openHistory = (propId) => {
            currentLedgerPropId = propId;
            const prop = allPropertiesData.find(p => p.id === propId);
            document.getElementById('history-title').innerText = prop.name;
            document.getElementById('history-subtitle').innerText = `Rent: ₹${prop.rent}/month | Tenant: ${prop.tenant}`;
            document.getElementById('historyModal').classList.remove('hidden');
            window.renderLedger();
        };

        window.closeHistoryModal = () => {
            document.getElementById('historyModal').classList.add('hidden');
        };

        window.changeLedgerYear = (delta) => {
            currentLedgerYear += delta;
            window.renderLedger();
        };

        window.renderLedger = () => {
            document.getElementById('ledger-year').innerText = currentLedgerYear;
            const grid = document.getElementById('ledger-grid');
            grid.innerHTML = '';
            
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const prop = allPropertiesData.find(p => p.id === currentLedgerPropId);
            const history = prop.paymentHistory || {}; 

            months.forEach(month => {
                const key = `${currentLedgerYear}-${month}`;
                const status = history[key] || 'None';
                
                let btnClass = "bg-gray-100 text-gray-500 hover:bg-gray-200";
                let icon = "";
                
                if (status === 'Pending') {
                    btnClass = "bg-red-100 text-red-600 border border-red-200 shadow-sm";
                    icon = '<i class="fa-solid fa-circle-exclamation mr-1"></i>';
                } else if (status === 'Paid') {
                    btnClass = "bg-green-100 text-green-700 border border-green-200 shadow-sm";
                    icon = '<i class="fa-solid fa-check mr-1"></i>';
                }

                const div = document.createElement('div');
                div.className = `month-box p-3 rounded-lg cursor-pointer text-center font-semibold text-sm select-none ${btnClass}`;
                div.innerHTML = `<div>${month}</div><div class="text-xs font-normal mt-1">${icon}${status === 'None' ? '-' : status}</div>`;
                div.onclick = () => window.togglePaymentStatus(key, status);
                grid.appendChild(div);
            });
        };

        window.togglePaymentStatus = async (key, currentStatus) => {
            let newStatus = 'Pending';
            if (currentStatus === 'Pending') newStatus = 'Paid';
            else if (currentStatus === 'Paid') newStatus = 'None';

            const propRef = doc(db, "properties", currentLedgerPropId);
            const updatePayload = {};
            
            if (newStatus === 'None') {
                updatePayload[`paymentHistory.${key}`] = null; 
            } else {
                updatePayload[`paymentHistory.${key}`] = newStatus;
            }

            try {
                await updateDoc(propRef, updatePayload);
            } catch (e) {
                console.error("Update failed", e);
                alert("Failed to update status: " + e.message);
            }
        };

        // CSV EXPORT
        window.exportToCSV = () => {
            if (allPropertiesData.length === 0) { alert("No data"); return; }
            let csv = "Property,Tenant,Rent,Status,Payment Status\n";
            allPropertiesData.forEach(p => csv += `"${p.name}","${p.tenant}",${p.rent},${p.status},${p.payStatus}\n`);
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "rent_data.csv";
            link.click();
        };

        // UI HELPERS
        window.toggleModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal.classList.contains('hidden')) {
                modal.dataset.previousFocus = document.activeElement?.id || '';
                modal.classList.remove('hidden');
                modal.setAttribute('aria-hidden', 'false');
                const focusables = modal.querySelectorAll('input, select, textarea, button:not([disabled])');
                if (focusables.length) focusables[0].focus();
            } else {
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden', 'true');
                if (modal.dataset.previousFocus) {
                    const el = document.getElementById(modal.dataset.previousFocus);
                    if (el) el.focus();
                }
            }
        };
        
        window.toggleTenantInput = () => {
            const show = document.getElementById('propStatus').value === 'Occupied';
            document.getElementById('tenantInputGroup').classList.toggle('hidden', !show);
        };

        // ADD PROPERTY
        const formElement = document.getElementById('addPropertyForm');
        if (formElement) {
            formElement.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return alert("Please login");
                
                const btnText = document.getElementById('btn-text');
                const btnLoader = document.getElementById('btn-loader');
                
                const name = document.getElementById('propName').value.trim();
                const rent = parseFloat(document.getElementById('propRent').value);
                const status = document.getElementById('propStatus').value;
                const payStatus = document.getElementById('payStatus').value;
                const tName = document.getElementById('tenantName').value.trim();
                const tenant = (status === 'Occupied' && tName) ? tName : (status === 'Occupied' ? 'Assigned' : 'None');

                if (!name) { alert("Property Name is required"); return; }
                if (isNaN(rent) || rent <= 0) { alert("Invalid Rent Amount"); return; }

                btnText.innerText = "Saving...";
                btnLoader.classList.remove('hidden');

                try {
                    await addDoc(collection(db, "properties"), {
                        name, rent, status, payStatus, tenant,
                        createdAt: serverTimestamp(),
                        createdBy: currentUser.uid,
                        paymentHistory: {} 
                    });
                    e.target.reset();
                    window.toggleModal('propertyModal');
                    window.toggleTenantInput();
                } catch (err) {
                    console.error("Add failed", err);
                    alert("Error saving: " + err.message);
                } finally {
                    btnText.innerText = "Save Property";
                    btnLoader.classList.add('hidden');
                }
            });
        } else {
            console.warn('addPropertyForm element not found');
        }

        window.deleteProperty = async (id) => {
            if (!currentUser) {
                alert("You must be logged in to delete.");
                return;
            }
            if (confirm('Are you sure you want to delete this property?')) {
                try {
                    await deleteDoc(doc(db, "properties", id));
                } catch (error) {
                    console.error("Error deleting: ", error);
                    alert("Failed to delete: " + error.message);
                }
            }
        };

        // RENDER HELPERS
        function escapeHtml(text) { 
            return (text || "").toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderProperties(list) {
            const grid = document.getElementById('property-grid');
            if (!list.length) { grid.innerHTML = '<p class="col-span-full text-center py-10 text-gray-400">No properties found.</p>'; return; }

            grid.innerHTML = list.map(p => {
                const history = p.paymentHistory || {};
                const currentMonthKey = `${new Date().getFullYear()}-${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][new Date().getMonth()]}`;
                
                let displayStatus = p.payStatus;
                if (history[currentMonthKey]) {
                    displayStatus = history[currentMonthKey];
                }

                let statusBadge = displayStatus === 'Paid' ? '<span class="text-green-600 font-bold text-xs"><i class="fa-solid fa-check-circle"></i> Paid</span>' 
                                : displayStatus === 'Pending' ? '<span class="text-red-600 font-bold text-xs"><i class="fa-solid fa-circle-exclamation"></i> Pending</span>'
                                : '<span class="text-gray-400 text-xs">No status</span>';

                return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition p-5 border-t-4 ${p.status === 'Occupied' ? 'border-blue-500' : 'border-gray-300'}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">${escapeHtml(p.name)}</h3>
                        <span class="px-2 py-1 rounded text-xs font-semibold ${p.status === 'Occupied' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-600'}">${escapeHtml(p.status)}</span>
                    </div>
                    <p class="text-gray-500 text-sm mb-4"><i class="fa-solid fa-user mr-1"></i> ${escapeHtml(p.tenant)}</p>
                    
                    <div class="bg-gray-50 p-3 rounded mb-4 flex justify-between items-center">
                        <span class="font-bold text-gray-700">₹${p.rent.toLocaleString()}</span>
                        ${statusBadge}
                    </div>

                    <div class="flex gap-2">
                        <button onclick="window.openHistory('${p.id}')" class="flex-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 py-2 rounded text-sm font-medium transition">
                            <i class="fa-solid fa-calendar-days mr-1"></i> Manage Rent
                        </button>
                        <button onclick="window.deleteProperty('${p.id}')" class="px-3 text-gray-400 hover:text-red-500 transition">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTenants(list) {
            const tbody = document.getElementById('tenant-list');
            const occupied = list.filter(p => p.status === 'Occupied');
            if(!occupied.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No tenants.</td></tr>'; return; }
            
            tbody.innerHTML = occupied.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-6">${escapeHtml(p.name)}</td>
                    <td class="py-3 px-6 font-medium">${escapeHtml(p.tenant)}</td>
                    <td class="py-3 px-6 text-center">₹${p.rent.toLocaleString()}</td>
                    <td class="py-3 px-6 text-center text-xs text-gray-500">${escapeHtml(p.payStatus)}</td>
                </tr>
            `).join('');
        }

        function updateStats(list) {
            document.getElementById('total-properties').innerText = list.length;
            document.getElementById('total-tenants').innerText = list.filter(p => p.status === 'Occupied').length;
            
            let totalPending = 0;
            list.forEach(p => {
                const history = p.paymentHistory || {};
                const ledgerPendingCount = Object.values(history).filter(v => v === 'Pending').length;
                
                if (ledgerPendingCount > 0) {
                    totalPending += (ledgerPendingCount * (p.rent || 0));
                } else if (p.payStatus === 'Pending') {
                    totalPending += (p.rent || 0);
                }
            });
            document.getElementById('pending-rent').innerText = '₹' + totalPending.toLocaleString();
        }

    </script>
</body>
</html>