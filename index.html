<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent Management System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom smooth scrolling */
        html { scroll-behavior: smooth; }
        .hidden-section { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50">
        <div class="text-center bg-white p-10 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-building-user text-4xl text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-gray-800">Munirathnam Illam</h1>
            <p class="text-gray-500 mb-8">Secure Rent Management System</p>
            
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-50 transition flex items-center justify-center shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3" alt="Google">
                Sign in with Google
            </button>
            <p id="login-error" role="alert" aria-live="assertive" class="text-red-500 text-sm mt-4 hidden text-left bg-red-50 p-3 rounded border border-red-200"></p>
        </div>
    </div>

    <!-- APP CONTENT (Hidden by default) -->
    <div id="app-content" class="hidden-section">
        
        <!-- Navigation -->
        <nav class="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa-solid fa-building-user text-2xl"></i>
                    <span class="text-xl font-bold hidden md:inline">RentManager</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex space-x-4 text-sm font-medium">
                        <a href="#dashboard" class="hover:text-blue-200 transition">Dashboard</a>
                        <a href="#properties" class="hover:text-blue-200 transition">Properties</a>
                        <a href="#tenants" class="hover:text-blue-200 transition">Tenants</a>
                    </div>
                    
                    <div class="flex items-center border-l border-blue-400 pl-4 ml-2">
                        <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full border-2 border-white mr-2">
                        <span id="user-name" class="text-sm font-semibold mr-4 hidden sm:block">User</span>
                        <button onclick="logout()" class="text-blue-100 hover:text-white" title="Sign Out">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            
            <!-- Dashboard Summary -->
            <section id="dashboard" class="mb-10">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Card 1 -->
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500 relative overflow-hidden">
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-gray-500 text-sm">Total Properties</p>
                                <p class="text-3xl font-bold" id="total-properties">0</p>
                            </div>
                            <i class="fa-solid fa-house text-blue-500 text-3xl opacity-50"></i>
                        </div>
                    </div>
                    <!-- Card 2 -->
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500 relative overflow-hidden">
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-gray-500 text-sm">Total Tenants</p>
                                <p class="text-3xl font-bold" id="total-tenants">0</p>
                            </div>
                            <i class="fa-solid fa-users text-green-500 text-3xl opacity-50"></i>
                        </div>
                    </div>
                    <!-- Card 3 -->
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-orange-500 relative overflow-hidden">
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <p class="text-gray-500 text-sm">Pending Rent</p>
                                <p class="text-3xl font-bold" id="pending-rent">₹0</p>
                            </div>
                            <i class="fa-solid fa-file-invoice-dollar text-orange-500 text-3xl opacity-50"></i>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Properties Section -->
            <section id="properties" class="mb-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Properties</h2>
                    <button onclick="toggleModal('propertyModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition flex items-center">
                        <i class="fa-solid fa-plus mr-2"></i> Add Property
                    </button>
                </div>

                <!-- Property Grid -->
                <div id="property-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Loading State -->
                    <div class="col-span-full text-center py-12">
                        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                        <p class="text-gray-500">Loading your properties from cloud...</p>
                    </div>
                </div>
            </section>

            <!-- Tenants Section -->
            <section id="tenants" class="mb-10">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Tenants Directory</h2>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <tr>
                                    <th class="py-3 px-6 text-left">Property</th>
                                    <th class="py-3 px-6 text-left">Tenant Name</th>
                                    <th class="py-3 px-6 text-center">Rent Amount</th>
                                    <th class="py-3 px-6 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tenant-list" class="text-gray-600 text-sm font-light">
                                <!-- Tenants injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Property Modal -->
    <div id="propertyModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modal-title" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50" tabindex="-1">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all scale-100 m-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Add New Property</h3>
                <button onclick="toggleModal('propertyModal')" class="text-gray-500 hover:text-red-500 text-xl" aria-label="Close modal">&times;</button>
            </div>
            
            <form id="addPropertyForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Property Name/Address</label>
                    <input type="text" id="propName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 123 Main St, Apt 4B">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Monthly Rent (₹)</label>
                    <input type="number" id="propRent" required min="1" step="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 12000">
                </div>
                
                <!-- Tenant Name Input (Shows only if Occupied) -->
                <div class="mb-4">
                     <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                     <select id="propStatus" onchange="toggleTenantInput()" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <option value="Vacant">Vacant</option>
                        <option value="Occupied">Occupied</option>
                    </select>
                    
                    <div id="tenantInputGroup" class="hidden">
                        <input type="text" id="tenantName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" placeholder="Enter Tenant Name">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Payment Status</label>
                    <select id="payStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Pending">Pending</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="toggleModal('propertyModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <span id="btn-text">Save Property</span>
                        <i id="btn-loader" class="fa-solid fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE MODULE LOGIC -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your Web App Config
        const firebaseConfig = {
            apiKey: "AIzaSyCH2Q18CquL9IGi9t6KovkSqQj3DYnXf9g",
            authDomain: "munirathnam-illam.firebaseapp.com",
            projectId: "munirathnam-illam",
            storageBucket: "munirathnam-illam.firebasestorage.app",
            messagingSenderId: "852272424128",
            appId: "1:852272424128:web:e5400d3d2f512d7e477925",
            measurementId: "G-7NF6X62CKV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- GLOBAL VARIABLES (Available to window) ---
        let currentUser = null;
        let unsubscribe = null; // Listener cleaner

        // --- AUTHENTICATION LOGIC ---
        
        // Expose login/logout to window scope
        window.loginWithGoogle = async () => {
            const errorMsg = document.getElementById('login-error');
            errorMsg.classList.add('hidden');
            try {
                await signInWithPopup(auth, provider);
                // Auth state listener handles the redirect
            } catch (error) {
                console.error("Login failed", error);
                
                let message = "Login failed: " + error.message;
                
                // Specific error handling for Unauthorized Domain
                if (error.code === 'auth/unauthorized-domain') {
                    const currentDomain = window.location.hostname;
                    message = `⚠️ Domain Unauthorized\n\nPlease add this domain to Firebase:\n1. Go to Firebase Console -> Authentication -> Settings -> Authorized Domains\n2. Click "Add Domain"\n3. Enter: ${currentDomain}`;
                }
                
                errorMsg.innerText = message;
                errorMsg.classList.remove('hidden');
            }
        };

        window.logout = async () => {
            try {
                if (unsubscribe) unsubscribe(); // Stop listening to DB
                await signOut(auth);
                window.location.reload(); // Refresh to clear state
            } catch (error) {
                console.error("Logout error", error);
            }
        };

        // Monitor Auth State
        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');
            
            if (user) {
                // User is signed in
                currentUser = user;
                
                // Update UI
                document.getElementById('user-name').innerText = user.displayName;
                
                // Validate Photo URL protocol to avoid XSS
                let photoURL = 'https://via.placeholder.com/150';
                if (user.photoURL && (user.photoURL.startsWith('http://') || user.photoURL.startsWith('https://'))) {
                    photoURL = user.photoURL;
                }
                document.getElementById('user-photo').src = photoURL;
                
                loginScreen.classList.add('hidden-section');
                appContent.classList.remove('hidden-section');
                
                // Start listening to data
                initDataListener();
            } else {
                // User is signed out
                loginScreen.classList.remove('hidden-section');
                appContent.classList.add('hidden-section');
            }
        });

        // --- DATABASE LOGIC (Real-time) ---

        function initDataListener() {
            // Query properties ordered by creation time
            const q = query(collection(db, "properties"), orderBy("createdAt", "desc"));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const properties = [];
                snapshot.forEach((doc) => {
                    properties.push({ id: doc.id, ...doc.data() });
                });
                
                renderProperties(properties);
                renderTenants(properties);
                updateStats(properties);
            }, (error) => {
                console.error("Data fetch error:", error);
                if (error.code === 'permission-denied') {
                    alert("Permission denied. Database rules might not be set to public/test mode.");
                }
            });
        }

        // --- UI FUNCTIONS (Exposed to Window) ---

        window.toggleModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal.classList.contains('hidden')) {
                        // Open modal: save previously focused element, reveal and focus first control
                        modal.dataset.previousFocus = document.activeElement && document.activeElement.id ? document.activeElement.id : '';
                        modal.classList.remove('hidden');
                        modal.setAttribute('aria-hidden', 'false');
                        const focusable = modal.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])');
                        if (focusable.length) focusable[0].focus();

                        // Key handler: Escape closes, Tab traps focus
                        modal._keydown = function(e) {
                            if (e.key === 'Escape') {
                                window.toggleModal(modalId);
                                return;
                            }
                            if (e.key === 'Tab') {
                                const nodes = Array.from(modal.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])'));
                                if (nodes.length === 0) { e.preventDefault(); return; }
                                const idx = nodes.indexOf(document.activeElement);
                                if (e.shiftKey && idx === 0) {
                                    e.preventDefault();
                                    nodes[nodes.length - 1].focus();
                                } else if (!e.shiftKey && idx === nodes.length - 1) {
                                    e.preventDefault();
                                    nodes[0].focus();
                                }
                            }
                        };
                        document.addEventListener('keydown', modal._keydown);
                    } else {
                        // Close modal: restore focus and cleanup
                        modal.classList.add('hidden');
                        modal.setAttribute('aria-hidden', 'true');
                        const prev = modal.dataset.previousFocus;
                        if (prev) {
                            const el = document.getElementById(prev);
                            if (el) el.focus();
                        }
                        if (modal._keydown) { document.removeEventListener('keydown', modal._keydown); delete modal._keydown; }
                    }
                }

        window.toggleTenantInput = () => {
            const status = document.getElementById('propStatus').value;
            const inputGroup = document.getElementById('tenantInputGroup');
            if (status === 'Occupied') {
                inputGroup.classList.remove('hidden');
            } else {
                inputGroup.classList.add('hidden');
            }
        }

        // Add Property
        const form = document.getElementById('addPropertyForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate Auth
            if (!currentUser) {
                alert("You must be logged in to perform this action.");
                return;
            }

            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            
            const name = document.getElementById('propName').value.trim();
            const rent = parseFloat(document.getElementById('propRent').value);
            const status = document.getElementById('propStatus').value;
            const payStatus = document.getElementById('payStatus').value;
            const tenantNameInput = document.getElementById('tenantName').value.trim();
            
            // Validate Input
            if (!name) {
                alert("Property name cannot be empty.");
                return;
            }
            if (isNaN(rent) || rent <= 0) {
                alert("Rent must be a valid positive number.");
                return;
            }

            // Show loading
            btnText.innerText = "Saving...";
            btnLoader.classList.remove('hidden');

            const tenant = (status === 'Occupied' && tenantNameInput) ? tenantNameInput : (status === 'Occupied' ? 'Assigned' : 'None');

            try {
                await addDoc(collection(db, "properties"), {
                    name: name,
                    rent: rent,
                    status: status,
                    payStatus: payStatus,
                    tenant: tenant,
                    createdAt: serverTimestamp(),
                    createdBy: currentUser.uid
                });
                
                // Reset form
                form.reset();
                window.toggleModal('propertyModal');
                window.toggleTenantInput(); // hide tenant input
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Error saving property: " + error.message);
            } finally {
                btnText.innerText = "Save Property";
                btnLoader.classList.add('hidden');
            }
        });

        // Delete Property (Exposed to window)
        window.deleteProperty = async (id) => {
            if (!currentUser) {
                alert("You must be logged in to delete items.");
                return;
            }
            if(confirm('Are you sure you want to delete this property?')) {
                try {
                    await deleteDoc(doc(db, "properties", id));
                } catch (error) {
                    console.error("Error deleting: ", error);
                    alert("Failed to delete.");
                }
            }
        }

        // --- RENDER FUNCTIONS ---

        function escapeHtml(text) {
            if (!text) return text;
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderProperties(properties) {
            const grid = document.getElementById('property-grid');
            
            if (properties.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-10 text-gray-500 bg-white rounded-lg border border-dashed border-gray-300">
                        <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
                        <p>No properties found in cloud.</p>
                    </div>`;
                return;
            }

            grid.innerHTML = properties.map(prop => {
                const safeName = escapeHtml(prop.name);
                const safeTenant = escapeHtml(prop.tenant);
                const statusColor = prop.status === 'Occupied' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const payColor = prop.payStatus === 'Paid' ? 'text-green-600' : 'text-orange-600';

                return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition overflow-hidden">
                    <div class="h-32 bg-gray-200 flex items-center justify-center">
                        <i class="fa-solid fa-city text-4xl text-gray-400"></i>
                    </div>
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg text-gray-800 mb-1">${safeName}</h3>
                            <span class="${statusColor} text-xs px-2 py-1 rounded-full font-semibold">
                                ${escapeHtml(prop.status)}
                            </span>
                        </div>
                        <p class="text-gray-600 text-sm mb-2"><i class="fa-solid fa-tag mr-1"></i> ₹${prop.rent} / month</p>
                        <p class="text-xs font-semibold mb-4 ${payColor}">
                             <i class="fa-solid fa-circle text-[8px] mr-1"></i> ${escapeHtml(prop.payStatus)}
                        </p>
                        
                        <div class="flex justify-between items-center border-t pt-3 mt-2">
                            <span class="text-xs text-gray-500 truncate max-w-[100px]">Tenant: ${safeTenant}</span>
                            <button onclick="deleteProperty('${prop.id}')" class="text-red-500 hover:text-red-700 text-sm">
                                <i class="fa-solid fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function renderTenants(properties) {
            const list = document.getElementById('tenant-list');
            const occupiedProps = properties.filter(p => p.status === 'Occupied');

            if (occupiedProps.length === 0) {
                list.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No active tenants found.</td></tr>`;
                return;
            }

            list.innerHTML = occupiedProps.map(prop => `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${escapeHtml(prop.name)}</td>
                    <td class="py-3 px-6 text-left">${escapeHtml(prop.tenant)}</td>
                    <td class="py-3 px-6 text-center">₹${prop.rent}</td>
                    <td class="py-3 px-6 text-center">
                        <span class="${prop.payStatus === 'Paid' ? 'bg-green-200 text-green-700' : 'bg-orange-200 text-orange-700'} py-1 px-3 rounded-full text-xs">
                            ${escapeHtml(prop.payStatus)}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(properties) {
            document.getElementById('total-properties').innerText = properties.length;
            const occupied = properties.filter(p => p.status === 'Occupied').length;
            document.getElementById('total-tenants').innerText = occupied;
            const pendingTotal = properties
                .filter(p => p.payStatus === 'Pending')
                .reduce((sum, p) => sum + (Number(p.rent) || 0), 0);
            document.getElementById('pending-rent').innerText = '₹' + pendingTotal.toLocaleString();
        }
    </script>
</body>
</html>